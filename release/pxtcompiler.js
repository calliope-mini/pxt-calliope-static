var __extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),pxt,pxt,ts,ts,ts,ts,ts,ts,ts,ts,ts,ts,pxt,ts,ts,ts,ts,ts,ts,ts;!function(o){var i=function(){function e(e){this.packageFiles=e}return e.prototype.resolve=function(e,t){return""},e.prototype.readFile=function(e,t){var r="this"==e.id?t:"pxt_modules/"+e.id+"/"+t;return void 0!==this.packageFiles[r]?this.packageFiles[r]:o.appTarget.bundledpkgs[e.id]?o.appTarget.bundledpkgs[e.id][t]:(console.log("file missing: "+e.id+" / "+t),null)},e.prototype.writeFile=function(e,t,r){"this"==e.id&&t==o.CONFIG_NAME?this.packageFiles[o.CONFIG_NAME]=r:console.log("write file? "+e.id+" / "+t)},e.prototype.getHexInfoAsync=function(e){return Promise.resolve({hex:["SKIP"]})},e.prototype.cacheStoreAsync=function(e,t){return Promise.resolve()},e.prototype.cacheGetAsync=function(e){return Promise.resolve("")},e.prototype.downloadPackageAsync=function(e){return Promise.resolve()},e.prototype.resolveVersionAsync=function(e){return Promise.resolve("*")},e}();function a(e){if(e.target.preferredEditor==o.PYTHON_PROJECT_NAME){var t=o.U.clone(e);t.ast=!0,t.target.preferredEditor=o.JAVASCRIPT_PROJECT_NAME;for(var r=0,n=t.sourceFiles;r<n.length;r++){var i=n[r];o.U.endsWith(i,".py")&&(t.fileSystem[i.slice(0,-3)+".ts"]=" ")}var a=pxtc.compile(t);e.apisInfo=pxtc.getApiInfo(a.ast,t.jres)}}function r(e,t){var r=new i(e),n=new o.MainPackage(r);return n.loadAsync().then(function(){var e=n.getTargetOptions();return e.hasHex&&(e.isNative=t.native),n.getCompileOptionsAsync(e)}).then(function(e){return s(n.targetVersion(),e),a(e),e})}function s(e,t){if(e){o.debug("applying TS patches relative to "+e);for(var r=0,n=Object.keys(t.fileSystem);r<n.length;r++){var i=n[r];if(-1==i.indexOf("/")&&o.U.endsWith(i,".ts")){var a=t.fileSystem[i],s=o.patching.patchJavaScript(e,a);a!=s&&(o.debug("applying TS patch to "+i),t.fileSystem[i]=s)}}}}o.SimpleHost=i,o.prepPythonOptions=a,o.simpleGetCompileOptionsAsync=r,o.simpleCompileAsync=function(e,t){return r(e,"boolean"==typeof t?{native:t}:t||{}).then(function(e){return pxtc.compile(e)}).then(function(e){return e.success||(e.errors=e.diagnostics.map(ts.pxtc.getDiagnosticString).join("")||"Unknown error."),e})},o.patchTS=s,o.setupSimpleCompile=function(){"undefined"==typeof global||global.btoa||(global.btoa=function(e){return Buffer.from(e,"binary").toString("base64")},global.atob=function(e){return Buffer.from(e,"base64").toString("binary")}),"undefined"!=typeof pxtTargetBundle&&(o.debug("setup app bundle"),o.setAppTarget(pxtTargetBundle)),o.debug("simple setup done")}}(pxt||(pxt={})),function(S){S.simshim=function(e,t){for(var r,h=ts.SyntaxKind,g=e.getTypeChecker(),v=S.cpp.nsWriter("declare namespace"),b="",n=0,i=e.getSourceFiles();n<i.length;n++){var a=i[n];if(t){var s=t(a.fileName);if(S.debug("SimShim[1]: "+s.dir),!S.U.endsWith(s.dir,"/sim")&&!S.U.startsWith(a.fileName,"sim/"))continue}else if(!S.U.startsWith(a.fileName,"sim/"))continue;S.debug("SimShim[2]: "+a.fileName);for(var o=0,l=a.statements;o<l.length;o++){var c=l[o],u=c;c.kind==h.ModuleDeclaration&&"pxsim"==u.name.text&&m((r=u).body)}}var p={};return p[S.appTarget.corepkg]=v.finish(),p;function y(e){var t;return ts.isExpression(e)&&(t=g.getContextualType(e)),t||(t=g.getTypeAtLocation(e)),t}function x(e){var t=g.typeToString(e,r,ts.TypeFormatFlags.UseFullyQualifiedType);switch(t=t.replace(/^pxsim\./,"")){case"RefAction":return"() => void";case"RefBuffer":return"Buffer";default:return t}}function f(r){var e=k(r);if(e){v.setNs(b),v.write(e);var t=b;b&&(b+="."),b+=r.name.text;var n=t?"":"declare",i="";if(r.heritageClauses)for(var a=0,s=r.heritageClauses;a<s.length;a++){var o=s[a];o.token==h.ExtendsKeyword&&(i=" extends "+x(y(o.types[0])))}v.write(n+" class "+r.name.text+i+" {"),v.incrIndent();for(var l=function(t){switch(t.kind){case h.MethodDeclaration:d(t);break;case h.PropertyDeclaration:!function(e){var t=k(e);if(t){var r=e.name.getText(),n="//% shim=."+r,i=g.getTypeAtLocation(e);v.write(t),v.write(n),v.write("public "+r+": "+x(i)+";"),v.write("")}}(t);break;case h.Constructor:!function(e){var t=k(e);if(t){g.getTypeAtLocation(e);var r=e.parameters.map(function(e){return e.name.getText()+": "+x(y(e))});v.write(t),v.write('//% shim="new '+b+'"'),v.write("constructor("+r.join(", ")+");"),v.write("")}}(t);break;case h.GetAccessor:var e=r.members.some(function(e){return e.kind==h.SetAccessor&&e.name.getText()==t.name.getText()});d(t,e)}},c=0,u=r.members;c<u.length;c++)l(u[c]);b=t,v.decrIndent(),v.write("}")}}function k(e){var t=pxtc.getComments(e);return/^\s*\/\/%/m.test(t)?t:null}function d(e,t){void 0===t&&(t=!1);var r=k(e);if(r){var n,i=e.name.getText(),a=e.kind==h.MethodDeclaration||e.kind==h.GetAccessor||e.kind==h.SetAccessor,s="//% shim="+(a?"."+i:b+"::"+i),o=g.getSignatureFromDeclaration(e),l=g.getReturnTypeOfSignature(o),c=/Async$/.test(i),u=(n=l,pxtc.isObjectType(n)&&n.objectFlags&ts.ObjectFlags.Reference&&"Promise"==n.symbol.name?n.typeArguments[0]:null);u?(s+=" promise",l=u,c||S.U.userError(b+"::"+i+" should be called "+i+"Async")):c&&S.U.userError(b+"::"+i+" doesn't return a promise"),S.debug("emitFun: "+i);var p=e.parameters.map(function(e){return e.name.getText()+(e.questionToken?"?":"")+": "+x(y(e))}),f=i.replace(/Async$/,""),d=a?"public":"function",m="("+p.join(", ")+")";e.kind==h.GetAccessor&&(d=t?"public":"readonly",m="",s+=" property"),a||v.setNs(b),v.write(r),v.write(s),v.write(d+" "+f+m+": "+x(l)+";"),v.write("")}}function m(e){switch(e.kind){case h.ModuleDeclaration:return(r=b)&&(b+="."),b+=(t=e).name.text,m(t.body),void(b=r);case h.ModuleBlock:return e.statements.forEach(m);case h.FunctionDeclaration:return d(e);case h.ClassDeclaration:return f(e)}var t,r}}}(pxt||(pxt={})),function(f){var d;(d=f.pxtc||(f.pxtc={})).annotate=function(e,t,r){var n=d.target;d.target=r;var i=e.getSourceFiles().filter(function(e){return e.fileName===t})[0],c=e.getTypeChecker();function s(e,t,r,n){void 0===r&&(r=!1),void 0===n&&(n=null);var i=r||!(p(e).flags&f.TypeFlags.Void),a=n||u(e);if(e.expression&&a){var s=!1;switch(a.kind){case d.SK.PropertySignature:case d.SK.PropertyAssignment:case d.SK.PropertyDeclaration:d.isStatic(a)||(s=!0);break;case d.SK.Parameter:d.isCtorField(a)&&(s=!0);break;case d.SK.GetAccessor:case d.SK.SetAccessor:case d.SK.MethodDeclaration:case d.SK.MethodSignature:s=!0}if(s){var o=e.expression;o.kind===d.SK.PropertyAccessExpression?t.unshift(o.expression):t.unshift(e.expression)}}var l={decl:a,qName:a?d.getNodeFullName(c,a):"?",args:t,isExpression:i};d.pxtInfo(e).callInfo=l}function u(e){if(!e)return null;var t,r=c.getSymbolAtLocation(e);if(r&&!(t=r.valueDeclaration)&&r.declarations){var n=r.declarations[0];n&&n.kind==f.SyntaxKind.ImportEqualsDeclaration&&(r=c.getSymbolAtLocation(n.moduleReference))&&(t=r.valueDeclaration)}if(!t&&e.kind==d.SK.PropertyAccessExpression){var i=e;t={kind:d.SK.PropertySignature,symbol:{isBogusSymbol:!0,name:i.name.getText()},name:i.name},d.pxtInfo(t).flags|=2}return t}function p(e){var t,r=d.pxtInfo(e);return r.typeCache?r.typeCache:(f.isExpression(e)&&(t=c.getContextualType(e)),t||(t=c.getTypeAtLocation(e)),t?f.isStringLiteral(e)?t:d.checkType(t):t)}!function r(e){f.forEachChild(e,function(e){switch(e.kind){case f.SyntaxKind.CallExpression:s(e,e.arguments.slice(0),null,u(e.expression));break;case f.SyntaxKind.PropertyAccessExpression:s(e,[]);break;case f.SyntaxKind.TaggedTemplateExpression:s(e,[e.template],!0,u(e.tag));break;case f.SyntaxKind.BinaryExpression:!function(e){var t=e.left,r=e.right,n=p(e.left),i=p(e.right);switch(e.operatorToken.kind!=d.SK.PlusToken&&e.operatorToken.kind!=d.SK.PlusEqualsToken||(d.isStringType(n)||d.isStringType(i)&&e.operatorToken.kind==d.SK.PlusToken)&&(d.pxtInfo(e).exprInfo={leftType:c.typeToString(n),rightType:c.typeToString(i)}),e.operatorToken.kind){case f.SyntaxKind.EqualsToken:case f.SyntaxKind.PlusEqualsToken:case f.SyntaxKind.MinusEqualsToken:if(t.kind==d.SK.PropertyAccessExpression){var a=u(t);a&&a.kind==d.SK.GetAccessor?(a=f.getDeclarationOfKind(a.symbol,d.SK.SetAccessor),s(t,[r],!1,a)):a&&(a.kind==d.SK.PropertySignature||a.kind==d.SK.PropertyAssignment||d.target&&d.target.switches.slowFields)&&s(t,[r])}}}(e);break;case f.SyntaxKind.Identifier:var t=u(e);t&&"main.ts"!==t.getSourceFile().fileName&&t.kind==f.SyntaxKind.VariableDeclaration&&(d.pxtInfo(e).flags|=4)}r(e)})}(i),d.target=n}}(ts||(ts={})),function(e){!function(U){function o(e){for(var t='"',r=0;r<e.length;++r){var n=255&e.charCodeAt(r),i=String.fromCharCode(n);t+="\\"==i||'"'==i?"\\"+i:"\n"==i?"\\n":n<=15?"\\x0"+n.toString(16):n<32||127<n?"\\x"+n.toString(16):i}return t+'"'}U.asmStringLiteral=o;var e=function(){function e(){}return e.prototype.nop=function(){return"TBD(nop)"},e.prototype.reg_gets_imm=function(e,t){return"TBD(reg_gets_imm)"},e.prototype.proc_setup=function(e,t){return"TBD(proc_setup)"},e.prototype.push_fixed=function(e){return"TBD(push_fixed)"},e.prototype.push_local=function(e){return"TBD(push_local)"},e.prototype.push_locals=function(e){return"TBD(push_locals)"},e.prototype.pop_fixed=function(e){return"TBD(pop_fixed)"},e.prototype.pop_locals=function(e){return"TBD(pop_locals)"},e.prototype.proc_return=function(){return"TBD(proc_return)"},e.prototype.debugger_stmt=function(e){return""},e.prototype.debugger_bkpt=function(e){return""},e.prototype.debugger_proc=function(e){return""},e.prototype.unconditional_branch=function(e){return"TBD(unconditional_branch)"},e.prototype.beq=function(e){return"TBD(beq)"},e.prototype.bne=function(e){return"TBD(bne)"},e.prototype.cmp=function(e,t){return"TBD(cmp)"},e.prototype.cmp_zero=function(e){return"TBD(cmp_zero)"},e.prototype.arithmetic=function(){return""},e.prototype.load_reg_src_off=function(e,t,r,n,i,a){return"TBD(load_reg_src_off)"},e.prototype.rt_call=function(e,t,r){return"TBD(rt_call)"},e.prototype.call_lbl=function(e,t){return"TBD(call_lbl)"},e.prototype.call_reg=function(e){return"TBD(call_reg)"},e.prototype.vcall=function(e,t,r){return"TBD(vcall)"},e.prototype.prologue_vtable=function(e,t){return"TBD(prologue_vtable"},e.prototype.helper_prologue=function(){return"TBD(lambda_prologue)"},e.prototype.helper_epilogue=function(){return"TBD(lambda_epilogue)"},e.prototype.pop_clean=function(e){return"TBD"},e.prototype.load_ptr_full=function(e,t){return"TBD(load_ptr_full)"},e.prototype.emit_int=function(e,t){return"TBD(emit_int)"},e.prototype.obj_header=function(e){return".word "+e},e.prototype.string_literal=function(e,t){var r="pxt::string_inline_ascii_vt",n=U.target.utf8?U.U.toUTF8(t,!0):t;if(n!==t){if(16<t.length){r="pxt::string_skiplist16_vt";for(var i=[],a=0,s=0;s+16<=t.length;s+=16)a+=U.U.toUTF8(t.slice(s,s+16),!0).length,i.push(a);return"\n.balign 4\n"+e+": "+this.obj_header(r)+"\n        .short "+n.length+", "+t.length+"\n        .word "+e+"data\n"+e+"data:\n        .short "+i.map(function(e){return e.toString()}).join(", ")+"\n        .string "+o(n)+"\n"}r="pxt::string_inline_utf8_vt"}return"\n.balign 4\n"+e+": "+this.obj_header(r)+"\n        .short "+n.length+"\n        .string "+o(n)+"\n"},e.prototype.hex_literal=function(e,t){return"\n.balign 4\n"+e+": "+this.obj_header("pxt::buffer_vt")+"\n"+r(t)+"\n"},e}();function r(e,t){return void 0===t&&(t=""),"\n                .word "+(e.length>>1)+t+"\n                .hex "+e+(e.length%4==0?"":"00")+"\n        "}U.AssemblerSnippets=e,U.hexLiteralAsm=r,U.numBytes=function(e){for(var t=0,r=e;0<r;r>>>=8)t++;return t||1};var t=function(){function e(e,t,r){var n=this;this.resText="",this.exprStack=[],this.calls=[],this.proc=null,this.baseStackSize=0,this.labelledHelpers={},this.write=function(e){n.resText+=U.asmline(e)},this.t=e,this.bin=t,this.proc=r,this.proc&&this.work()}return e.prototype.emitHelpers=function(){this.emitLambdaTrampoline(),this.emitArrayMethods(),this.emitFieldMethods(),this.emitBindHelper()},e.prototype.redirectOutput=function(e){var t=this.write,r="";this.write=function(e){return r+=U.asmline(e)};try{e()}finally{this.write=t}return r},e.prototype.stackSize=function(){return this.baseStackSize+this.exprStack.length},e.prototype.stackAlignmentNeeded=function(e){if(void 0===e&&(e=0),!U.target.stackAlign)return 0;var t=U.target.stackAlign-(this.stackSize()+e&U.target.stackAlign-1);return t==U.target.stackAlign?0:t},e.prototype.getAssembly=function(){return this.resText},e.prototype.work=function(){var l=this;this.write("\n;\n; Function "+this.proc.getFullName()+"\n;\n"),this.emitLambdaWrapper(this.proc.isRoot);var e=this.proc.label(),c=e+"_bkpt",u=e+"_locals",p=e+"_end";this.write(".section code"),this.write(e+":"),this.proc.classInfo&&this.proc.info.thisParameter&&!U.target.switches.skipClassCheck&&!U.target.switches.noThisCheckOpt&&(this.write("mov r7, lr"),this.write("ldr r0, [sp, #0]"),this.emitInstanceOf(this.proc.classInfo,"validate"),this.write("mov lr, r7")),this.write("\n"+e+"_nochk:\n    @stackmark func\n    @stackmark args\n"),this.proc.fillDebugInfo=function(e){var t=e.getLabels();l.proc.debugInfo={locals:(1==l.proc.seqNo?l.bin.globals:l.proc.locals).map(function(e){return e.getDebugInfo()}),args:l.proc.args.map(function(e){return e.getDebugInfo()}),name:l.proc.getName(),codeStartLoc:U.U.lookup(t,u),codeEndLoc:U.U.lookup(t,p),bkptLoc:U.U.lookup(t,c),localsMark:U.U.lookup(e.stackAtLabel,u),idx:l.proc.seqNo,calls:l.calls};for(var r=0,n=l.calls;r<n.length;r++){var i=n[r];i.addr=U.U.lookup(t,i.callLabel),i.stack=U.U.lookup(e.stackAtLabel,i.callLabel),i.callLabel=void 0}for(var a=0;a<l.proc.body.length;++a){var s=l.proc.body[a].breakpointInfo;if(s){var o=U.U.lookup(e.stackAtLabel,"__brkp_"+s.id);o!==l.proc.debugInfo.localsMark&&(console.log(s),console.log(e.stackAtLabel),U.U.oops("offset doesn't match: "+o+" != "+l.proc.debugInfo.localsMark))}}},this.bin.options.breakpoints&&this.write(this.t.debugger_proc(c)),this.baseStackSize=1;var t=this.proc.locals.length;this.write("push {lr}"),this.write(".locals:\n"),this.proc.perfCounterNo&&(this.write(this.t.emit_int(this.proc.perfCounterNo,"r0")),this.write("bl pxt::startPerfCounter")),this.write(this.t.proc_setup(t)),this.baseStackSize+=t,this.write("@stackmark locals"),this.write(u+":");for(var r=0;r<this.proc.body.length;++r){var n=this.proc.body[r];switch(n.stmtKind){case U.ir.SK.Expr:this.emitExpr(n.expr);break;case U.ir.SK.StackEmpty:if(0<this.exprStack.length){for(var i=0,a=this.proc.body.slice(r-4,r+1);i<a.length;i++){var s=a[i];console.log("PREVSTMT "+s.toString().trim())}for(var o=0,f=this.exprStack;o<f.length;o++){var d=f[o];console.log("EXPRSTACK "+d.currUses+"/"+d.totalUses+" E: "+d.toString())}U.oops("stack should be empty")}this.write("@stackempty locals");break;case U.ir.SK.Jmp:this.emitJmp(n);break;case U.ir.SK.Label:this.write(n.lblName+":"),this.validateJmpStack(n);break;case U.ir.SK.Breakpoint:if(this.bin.options.breakpoints){var m="__brkp_"+n.breakpointInfo.id;n.breakpointInfo.isDebuggerStmt?this.write(this.t.debugger_stmt(m)):this.write(this.t.debugger_bkpt(m))}break;default:U.oops()}}U.assert(0<=t&&t<127),0<t&&this.write(this.t.pop_locals(t)),this.proc.perfCounterNo&&(this.write("mov r4, r0"),this.write(this.t.emit_int(this.proc.perfCounterNo,"r0")),this.write("bl pxt::stopPerfCounter"),this.write("mov r0, r4")),this.write(p+":"),this.write(this.t.proc_return()),this.write("@stackempty func"),this.write("@stackempty args"),this.write("; endfun")},e.prototype.mkLbl=function(e){var t=e+this.bin.lblNo++;return"_"!=t[0]&&(t="."+t),t},e.prototype.dumpStack=function(){for(var e="[",t=0,r=this.exprStack;t<r.length;t++){var n=r[t];e+=n.sharingInfo()+": "+n.toString()+"; "}return e+="]"},e.prototype.terminate=function(e){U.assert(e.exprKind==U.ir.EK.SharedRef);var t=e.args[0];U.U.assert(t.currUses!=t.totalUses),U.U.assert(this.exprStack[0]===t,"term at top");for(var r=1;r<this.exprStack.length;){var n=this.exprStack[r];if(n.currUses!=n.totalUses)break;r++}return this.write("@dummystack "+r),this.write(this.t.pop_locals(r)),r},e.prototype.validateJmpStack=function(e,t){void 0===t&&(t=0);var r=this.exprStack.length-t;null==e.lblStackSize?e.lblStackSize=r:e.lblStackSize!=r&&(console.log(e.lblStackSize,r),console.log(this.dumpStack()),U.U.oops("stack misaligned at: "+e.lblName))},e.prototype.emitJmp=function(e){var t=0;if(e.jmpMode==U.ir.JmpMode.Always)e.expr&&this.emitExpr(e.expr),e.terminateExpr&&(t=this.terminate(e.terminateExpr)),this.write(this.t.unconditional_branch(e.lblName)+" ; with expression");else{var r=this.mkLbl("jmpz");this.emitExpr(e.expr),(e.expr.exprKind!=U.ir.EK.RuntimeCall||"thumb::subs"!==e.expr.data&&!U.U.startsWith(e.expr.data,"_cmp_"))&&this.write(this.t.cmp_zero("r0")),e.jmpMode==U.ir.JmpMode.IfNotZero?this.write(this.t.beq(r)):this.write(this.t.bne(r)),e.terminateExpr&&(t=this.terminate(e.terminateExpr)),this.write(this.t.unconditional_branch(e.lblName)),this.write(r+":")}this.validateJmpStack(e.lbl,t)},e.prototype.clearStack=function(e){void 0===e&&(e=!1);for(var t=0;0<this.exprStack.length&&this.exprStack[0].currUses==this.exprStack[0].totalUses;)t++,this.exprStack.shift();if(t&&this.write(this.t.pop_locals(t)),!e){var r=this.exprStack.filter(function(e){return e.currUses==e.totalUses&&-1!=e.irCurrUses});if(0<r.length){this.write(this.t.reg_gets_imm("r7",0));for(var n=0,i=r;n<i.length;n++){var a=i[n];a.irCurrUses=-1,this.write(this.loadFromExprStack("r7",a,0,!0))}}}},e.prototype.emitExprInto=function(e,t){switch(e.exprKind){case U.ir.EK.NumberLiteral:"number"==typeof e.data?this.write(this.t.emit_int(e.data,t)):U.oops();break;case U.ir.EK.PointerLiteral:this.write(this.t.load_ptr_full(e.data,t));break;case U.ir.EK.SharedRef:var r=e.args[0];U.U.assert(!!r.currUses),U.U.assert(r.currUses<r.totalUses),r.currUses++;var n=this.exprStack.indexOf(r);if(U.U.assert(0<=n),0==n&&r.totalUses==r.currUses)this.write(this.t.pop_fixed([t])+" ; tmpref @"+this.exprStack.length),this.exprStack.shift(),this.clearStack();else{var i=n.toString()+":"+this.exprStack.length;this.write(this.t.load_reg_src_off(t,"sp",i,!0)+" ; tmpref @"+(this.exprStack.length-n))}break;case U.ir.EK.CellRef:var a=e.data;if(a.isGlobal()){var s=this.bitSizeInfo(a.bitSize),o="#"+a.index;(s.needsSignExt||a.index>=s.immLimit)&&(this.write(this.t.emit_int(a.index,t)),o=t),this.write(this.t.load_reg_src_off("r7","r6","#0")),this.write(this.t.load_reg_src_off(t,"r7",o,!1,!1,s))}else{var l=this.cellref(a),c=l[0],u=l[1],p=l[2];this.write(this.t.load_reg_src_off(t,c,u,p))}break;default:U.oops()}},e.prototype.bitSizeInfo=function(e){var t={size:U.sizeOfBitSize(e),immLimit:128};return 1==t.size?t.immLimit=32:2==t.size&&(t.immLimit=64),1!=e&&3!=e||(t.needsSignExt=!0),t},e.prototype.emitExpr=function(e){var t=this;switch(e.exprKind){case U.ir.EK.JmpValue:this.write("; jmp value (already in r0)");break;case U.ir.EK.Nop:this.write(this.t.nop());break;case U.ir.EK.FieldAccess:return this.emitExpr(e.args[0]),this.emitFieldAccess(e);case U.ir.EK.Store:return this.emitStore(e.args[0],e.args[1]);case U.ir.EK.RuntimeCall:return this.emitRtCall(e);case U.ir.EK.ProcCall:return this.emitProcCall(e);case U.ir.EK.SharedDef:return this.emitSharedDef(e);case U.ir.EK.Sequence:return e.args.forEach(function(e){return t.emitExpr(e)}),this.clearStack();case U.ir.EK.InstanceOf:return this.emitExpr(e.args[0]),this.emitInstanceOf(e.data,e.jsInfo);default:return this.emitExprInto(e,"r0")}},e.prototype.emitFieldAccess=function(e,t){void 0===t&&(t=!1);var r=e.data;r.classInfo.id,r.name;r.needsCheck&&!U.target.switches.skipClassCheck&&this.emitInstanceOf(r.classInfo,"validate");var n=4*r.idx+4,i="#"+n;124<n&&(this.write(this.t.emit_int(n,"r3")),i="r3"),t?this.write("str r1, [r0, "+i+"]"):this.write("ldr r0, [r0, "+i+"]")},e.prototype.emitClassCall=function(e){var t=this,r=e.virtualIndex+U.firstMethodOffset();this.write(this.t.emit_int(4*r,"r1"));var n=e.classInfo,i="";e.isThis&&(i+="_this"),this.emitLabelledHelper("classCall_"+n.id+i,function(){t.write("ldr r0, [sp, #0] ; ld-this"),t.loadVTable(),U.target.switches.skipClassCheck||e.isThis||t.checkSubtype(n),t.write("ldr r1, [r3, r1] ; ld-method"),t.write("bx r1 ; keep lr from caller"),t.write(".fail:"),t.write(t.t.callCPP("pxt::failedCast"))})},e.prototype.emitBindHelper=function(){this.write("\n                .section code\n                _pxt_bind_helper:\n                    push {r0, r2}\n                    movs r0, #2\n                    ldlit r1, _pxt_bind_lit\n                    "+this.t.callCPP("pxt::mkAction")+"\n                    pop {r1, r2}\n                    str r1, [r0, #12]\n                    str r2, [r0, #16]\n                    bx r4 ; return\n\n                _pxt_bind_lit:\n                    "+this.t.obj_header("pxt::RefAction_vtable")+"\n                    .short 0, 0 ; no captured vars\n                    .word .bindCode@fn\n                .bindCode:\n                    ; r0-bind object, r4-#args\n                    cmp r4, #12\n                    bge .fail\n                    lsls r3, r4, #2\n                    ldlit r2, _pxt_copy_list\n                    ldr r1, [r2, r3]\n\n                    ldr r3, [r0, #12]\n                    ldr r2, [r0, #16]\n                    adds r4, r4, #1\n                    bx r1\n                .fail:\n                    "+this.t.callCPP("pxt::failedCast")+"\n\n                _pxt_copy_list:\n            "),this.write(U.U.range(12).map(function(e){return".word _pxt_bind_"+e+"@fn"}).join("\n"));for(var e=0;e<12;e++){this.write("\n                _pxt_bind_"+e+":\n                    sub sp, #4\n                ");for(var t=0;t<e;++t)this.write("ldr r1, [sp, #4*"+(t+1)+"]"),this.write("str r1, [sp, #4*"+t+"]");this.write("\n                    push {r3} ; this-ptr\n                    mov r1, lr\n                    str r1, [sp, #4*"+(e+1)+"] ; store LR\n                    blx r2\n                    ldr r1, [sp, #4*"+(e+1)+"]\n                    add sp, #8\n                    bx r1\n                ")}},e.prototype.ifaceCallCore=function(e,t,r){void 0===r&&(r=!1),this.write("\n                ldr r2, [r3, #12] ; load mult\n                movs r7, r2\n                beq .objlit ; built-in types have mult=0\n                muls r7, r1\n                lsrs r7, r2\n                lsls r7, r7, #1 ; r7 - hash offset\n                ldr r3, [r3, #4] ; iface table\n                adds r3, r3, r7\n                ; r0-this, r1-method idx, r2-free, r3-hash entry, r4-num args, r7-free\n                ");for(var n=0;n<U.vtLookups;++n)0<n&&this.write("    adds r3, #2"),this.write("\n                ldrh r2, [r3, #0] ; r2-offset of descriptor\n                ldrh r7, [r2, r3] ; r7-method idx\n                cmp r7, r1\n                beq .hit\n                ");"get"==t?(this.write("movs r0, #0 ; undefined"),this.write("bx lr")):this.write("b .fail2"),this.write("\n            .hit:\n                adds r3, r3, r2 ; r3-descriptor\n                ldr r2, [r3, #4]\n                lsls r7, r2, #31\n                beq .field\n            ");var i=this.t.emit_int(e,"r4")+"\n     bx r2";if("set"==t?this.write("\n                    ; check for next descriptor\n                    ldrh r7, [r3, #8]\n                    cmp r7, r1\n                    bne .fail2 ; no setter!\n                    ldr r2, [r3, #12]\n                    "+i+"\n                "):(this.write("\n                    ; check if it's getter\n                    ldrh r7, [r3, #2]\n                    cmp r7, #1\n                "),"get"==t?this.write("\n                        bne .bind\n                        "+i+"\n                    .bind:\n                        mov r4, lr\n                        bl _pxt_bind_helper\n                    "):this.write("\n                        beq .doublecall\n                        "+i+"\n                    .doublecall:\n                        ; call getter\n                        movs r4, #1\n                        push {r0, lr}\n                        blx r2\n                        pop {r1, r2}\n                        mov lr, r2\n                        b .moveArgs\n                    ")),r||(this.write("\n                .objlit:\n                    ldrh r2, [r3, #8]\n                    cmp r2, #"+pxt.BuiltInType.RefMap+"\n                    bne .fail\n                    mov r4, lr\n                "),"set"==t&&this.write("ldr r2, [sp, #4] ; ld-val"),this.write(this.t.callCPP("set"==t?"pxtrt::mapSet":"pxtrt::mapGet")),t?this.write("bx r4"):(this.write("mov lr, r4"),this.write("b .moveArgs"))),this.write(".field:"),"set"==t?this.write("\n                        ldr r3, [sp, #4] ; ld-val\n                        str r3, [r0, r2] ; store field\n                        bx lr\n                    "):"get"==t?this.write("\n                        ldr r0, [r0, r2] ; load field\n                        bx lr\n                    "):this.write("\n                        ldr r0, [r0, r2] ; load field\n                    "),!t){this.write(".moveArgs:");for(n=0;n<e;++n)n==e-1?this.write("movs r1, r0"):this.write("ldr r1, [sp, #4*"+(n+1)+"]"),this.write("str r1, [sp, #4*"+n+"]");this.lambdaCall(e-1)}r&&this.write(".objlit:"),this.write("\n            .fail:\n                "+this.t.callCPP("pxt::failedCast")+"\n            .fail2:\n                "+this.t.callCPP("pxt::missingProperty")+"\n            ")},e.prototype.emitIfaceCall=function(e,t,r){var n=this;void 0===r&&(r=""),U.U.assert(0<e.ifaceIndex),this.write(this.t.emit_int(e.ifaceIndex,"r1")),this.emitLabelledHelper("ifacecall"+t+"_"+r,function(){n.write("ldr r0, [sp, #0] ; ld-this"),n.loadVTable(),n.ifaceCallCore(t,r)})},e.prototype.checkSubtype=function(e,t,r){void 0===t&&(t=".fail"),void 0===r&&(r="r2"),e.classNo?(this.write("ldrh "+r+", [r3, #8]"),this.write("cmp "+r+", #"+e.classNo),e.classNo==e.lastSubtypeNo?this.write("bne "+t):(this.write("blt "+t),this.write("cmp "+r+", #"+e.lastSubtypeNo),this.write("bgt "+t))):this.write("b "+t+" ; always fails; class never instantiated")},e.prototype.loadVTable=function(e,t,r){void 0===e&&(e="r2"),void 0===t&&(t=".fail"),void 0===r&&(r=".fail"),this.write("lsls "+e+", r0, #30"),this.write("bne "+t),this.write("cmp r0, #0"),this.write("beq "+r),this.write("ldr r3, [r0, #0]"),this.write("; vtable in R3")},e.prototype.emitInstanceOf=function(e,t){var r=this,n="inst_"+e.id+"_"+t;this.emitLabelledHelper(n,function(){"validateNullable"==t?r.loadVTable("r2",".tagged",".undefined"):r.loadVTable("r2",".fail",".fail"),r.checkSubtype(e),"bool"==t?(r.write("movs r0, #"+U.taggedTrue),r.write("bx lr"),r.write(".fail:"),r.write("movs r0, #"+U.taggedFalse),r.write("bx lr")):"validate"==t?(r.write("bx lr"),r.write(".fail:"),r.write(r.t.callCPP("pxt::failedCast"))):"validateNullable"==t?(r.write(".undefined:"),r.write("bx lr"),r.write(".tagged:"),r.write("cmp r0, #"+U.taggedNull+" ; check for null"),r.write("bne .fail"),r.write("movs r0, #0"),r.write("bx lr"),r.write(".fail:"),r.write(r.t.callCPP("pxt::failedCast"))):U.U.oops()})},e.prototype.emitSharedDef=function(e){var t=e.args[0];if(U.U.assert(1<=t.totalUses),U.U.assert(0===t.currUses),(t.currUses=1)==t.totalUses)return this.emitExpr(t);this.emitExpr(t),this.exprStack.unshift(t),this.write(this.t.push_local("r0")+"; tmpstore @"+this.exprStack.length)},e.prototype.clearArgs=function(e,t){e.length,t.length;for(var r=e.concat(t),n=0,i=r;n<i.length;n++){var a=i[n];0==a.currUses&&1==a.totalUses||(console.log(a.toString()),console.log(r.map(function(e){return e.toString()})),U.U.oops("wrong uses: "+a.currUses+" "+a.totalUses)),a.currUses=1}this.clearStack()},e.prototype.builtInClassNo=function(e){return{id:"builtin"+e,classNo:e,lastSubtypeNo:e}},e.prototype.emitBeginTry=function(e){this.emitExprInto(e.args[0],"r0"),this.write("bl _pxt_save_exception_state")},e.prototype.emitRtCall=function(e,t){var c=this;void 0===t&&(t=null);var r=e.data;if("pxt::beginTry"==r)return this.emitBeginTry(e);var n=e.mask||{refMask:0},i=n.conversions||[],a=e.args.map(function(e,t){return{idx:t,expr:e,isSimple:e.isLiteral(),isRef:0!=(n.refMask&1<<t),conv:i.find(function(e){return e.argIdx==t})}});U.U.assert(a.length<=4);for(var s=!1,o=0,l=U.U.reversed(a);o<l.length;o++){(y=l[o]).expr.isPure()?y.isSimple||y.isRef||s&&!y.expr.isStateless()||(y.isSimple=!0):s=!0}for(var u=0,p=a;u<p.length;u++){(y=p[u]).conv&&(y.isSimple=!1)}var f=a.filter(function(e){return!e.isSimple});if(f.every(function(e){return e.expr.isPure()&&!e.isRef&&!e.conv})){for(var d=0,m=f;d<m.length;d++){m[d].isSimple=!0}f=[]}var h=f[0],g=!0;if(1!=f.length||h.conv||h.isRef){for(var v=0,b=f;v<b.length;v++){var y=b[v];this.pushArg(y.expr)}this.alignExprStack(0);var x=f.filter(function(e){return!!e.conv});if(x.length){var k=this.redirectOutput(function(){var e=0;U.target.switches.inlineConversions||(c.t.stackAligned()?e+=2:e+=1);for(var t=0,r=x;t<r.length;t++){var n=r[t];if(U.isThumb()&&"pxt::toInt"==n.conv.method){c.write(c.loadFromExprStack("r0",n.expr,e)),c.write("asrs r0, r0, #1");var i=U.target.switches.inlineConversions?n.expr.getId():e;c.write("bcs .isint"+i),c.write("lsls r0, r0, #1"),c.alignedCall(n.conv.method,"",e),c.write(".isint"+i+":"),c.write(c.t.push_fixed(["r0"]))}else c.write(c.loadFromExprStack("r0",n.expr,e)),n.conv.refTag?U.target.switches.skipClassCheck||c.emitInstanceOf(c.builtInClassNo(n.conv.refTag),n.conv.refTagNullable?"validateNullable":"validate"):(c.alignedCall(n.conv.method,"",e),n.conv.returnsRef&&c.write(c.loadFromExprStack("r0",n.expr,e,!0))),c.write(c.t.push_fixed(["r0"]));e++}for(var a=0,s=U.U.reversed(x);a<s.length;a++){n=s[a];e--,c.write(c.t.pop_fixed(["r"+n.idx]))}for(var o=0,l=f;o<l.length;o++){(n=l[o]).conv||c.write(c.loadFromExprStack("r"+n.idx,n.expr,e))}});U.target.switches.inlineConversions?this.write(k):this.emitHelper(this.t.helper_prologue()+k+this.t.helper_epilogue(),"conv")}else for(var S=0,T=f;S<T.length;S++){y=T[S];this.write(this.loadFromExprStack("r"+y.idx,y.expr))}}else this.emitExpr(h.expr),0!=h.idx&&this.write(this.t.mov("r"+h.idx,"r0")),g=!1;for(var w=0,E=a;w<E.length;w++){(y=E[w]).isSimple&&this.emitExprInto(y.expr,"r"+y.idx)}t?t():"langsupp::ignore"!=r&&this.alignedCall(r,"",0,!0),g&&this.clearArgs(f.filter(function(e){return!e.isRef}).map(function(e){return e.expr}),f.filter(function(e){return e.isRef}).map(function(e){return e.expr}))},e.prototype.alignedCall=function(e,t,r,n){void 0===t&&(t=""),void 0===r&&(r=0),void 0===n&&(n=!1),(U.U.startsWith(e,"_cmp_")||U.U.startsWith(e,"_pxt_"))&&(n=!1),this.write(this.t.call_lbl(e,n,this.stackAlignmentNeeded(r))+t)},e.prototype.emitLabelledHelper=function(e,t){if(this.labelledHelpers[e])this.write(this.t.call_lbl(this.labelledHelpers[e]));else{var r=this.redirectOutput(t);this.emitHelper(r,e),this.labelledHelpers[e]=this.bin.codeHelpers[r]}},e.prototype.emitHelper=function(e,t){if(void 0===t&&(t="hlp"),!this.bin.codeHelpers[e]){var r=Object.keys(this.bin.codeHelpers).length;this.bin.codeHelpers[e]="_"+t+"_"+r}this.write(this.t.call_lbl(this.bin.codeHelpers[e]))},e.prototype.pushToExprStack=function(e){e.totalUses=1,e.currUses=0,this.exprStack.unshift(e)},e.prototype.pushArg=function(e){this.clearStack(!0);this.exprStack.length;this.emitExpr(e),this.clearStack(!0),this.write(this.t.push_local("r0")+" ; proc-arg"),this.pushToExprStack(e)},e.prototype.loadFromExprStack=function(e,t,r,n){void 0===r&&(r=0),void 0===n&&(n=!1);var i=this.exprStack.indexOf(t);return U.assert(0<=i),this.t.load_reg_src_off(e,"sp",(i+r).toString(),!0,n)+" ; estack\n"},e.prototype.pushDummy=function(){var e=U.ir.numlit(0);e.totalUses=1,e.currUses=1,this.exprStack.unshift(e)},e.prototype.alignExprStack=function(e){var t=this.stackAlignmentNeeded(e);if(t)for(var r=0;r<t;++r)this.write("push {r5} ; align"),this.pushDummy()},e.prototype.emitFieldMethods=function(){for(var e=0,t=["get","set"];e<t.length;e++){var r=t[e];this.write("\n                .section code\n                _pxt_map_"+r+":\n                "),this.loadVTable("r4"),this.checkSubtype(this.builtInClassNo(pxt.BuiltInType.RefMap),".notmap","r4"),this.write(this.t.callCPPPush("set"==r?"pxtrt::mapSetByString":"pxtrt::mapGetByString")),this.write(".notmap:");var n="set"==r?2:1,i=!1;this.write("mov r4, r3 ; save VT"),"set"==r?(U.target.stackAlign&&(i=!0,this.write("push {lr} ; align")),this.write("\n                            push {r0, r2, lr}\n                            mov r0, r1\n                        ")):this.write("\n                            push {r0, lr}\n                            mov r0, r1\n                        "),this.write("\n                    bl pxtrt::lookupMapKey\n                    mov r1, r0 ; put key index in r1\n                    ldr r0, [sp, #0] ; restore obj pointer\n                    mov r3, r4 ; restore vt\n                    bl .dowork\n                "),this.write(this.t.pop_locals(n+(i?1:0))),this.write("pop {pc}"),this.write(".dowork:"),this.ifaceCallCore(n,r,!0)}},e.prototype.emitArrayMethod=function(e,t){this.write("\n            .section code\n            _pxt_"+(t?"buffer":"array")+"_"+e+":\n            "),this.loadVTable("r4");var r=this.builtInClassNo(t?pxt.BuiltInType.BoxedBuffer:pxt.BuiltInType.RefCollection);U.target.switches.skipClassCheck||this.checkSubtype(r,".fail","r4");var n=U.target.stackAlign||t?"ldr":"ldrh";this.write("\n                asrs r1, r1, #1\n                bcc .notint\n                "+n+" r4, [r0, #"+(t?4:8)+"]\n                cmp r1, r4\n                bhs .oob\n            ");var i="r1";t?(i="#8",this.write("\n                    adds r4, r0, r1\n                ")):this.write("\n                    lsls r1, r1, #2\n                    ldr r4, [r0, #4]\n                ");var a=t?"b":"",s=t&&"get"==e?"lsls r0, r0, #1\nadds r0, #1":"";"set"==e?this.write("\n                        str"+a+" r2, [r4, "+i+"]\n                        bx lr\n                    "):this.write("\n                        ldr"+a+" r0, [r4, "+i+"]\n                        "+s+"\n                        bx lr\n                    "),this.write("\n            .notint:\n                lsls r1, r1, #1\n                "+this.t.pushLR()+"\n                push {r0, r2}\n                mov r0, r1\n                "+this.t.callCPP("pxt::toInt")+"\n                mov r1, r0\n                pop {r0, r2}\n            .doop:\n                "+this.t.callCPP("Array_::"+e+"At")+"\n                "+s+"\n                "+this.t.popPC()+"\n\n            .fail:\n                bl pxt::failedCast\n            "),"get"==e?this.write("\n                    .oob:\n                        movs r0, #"+(t?1:0)+" ; 0 or undefined\n                        bx lr\n                "):this.write("\n                    .oob:\n                        "+this.t.pushLR()+"\n                        b .doop\n                ")},e.prototype.emitArrayMethods=function(){for(var e=0,t=["get","set"];e<t.length;e++){var r=t[e];this.emitArrayMethod(r,!0),this.emitArrayMethod(r,!1)}},e.prototype.emitLambdaTrampoline=function(){var e=U.target.stackAlign?"r3,":"";this.write("\n            .section code\n            _pxt_lambda_trampoline:\n                push {"+e+" r4, r5, r6, r7, lr}\n                mov r4, r8\n                mov r5, r9\n                mov r6, r10\n                mov r7, r11\n                push {r4, r5, r6, r7} ; save high registers\n                mov r4, r1\n                mov r5, r2\n                mov r6, r3\n                mov r7, r0\n                "),this.emitInstanceOf(this.builtInClassNo(pxt.BuiltInType.RefAction),"validate"),this.write("\n                mov r0, sp\n                push {r4, r5, r6, r7} ; push args and the lambda\n                mov r1, sp\n                bl pxt::pushThreadContext\n                mov r6, r0          ; save ctx or globals\n                mov r5, r7          ; save lambda for closure\n                mov r0, r5          ; also save lambda pointer in r0 - needed by pxt::bindMethod\n                ldr r1, [r5, #8]    ; ld fnptr\n                movs r4, #3         ; 3 args\n                blx r1              ; execute the actual lambda\n                mov r7, r0          ; save result\n                @dummystack 4\n                add sp, #4*4        ; remove arguments and lambda\n                mov r0, r6   ; or pop the thread context\n                bl pxt::popThreadContext\n                mov r0, r7 ; restore result\n                pop {r4, r5, r6, r7} ; restore high registers\n                mov r8, r4\n                mov r9, r5\n                mov r10, r6\n                mov r11, r7\n                pop {"+e+" r4, r5, r6, r7, pc}"),this.write("\n            .section code\n            ; r0 - try frame\n            ; r1 - handler PC\n            _pxt_save_exception_state:\n                push {r0, lr}\n                "+this.t.callCPP("pxt::beginTry")+"\n                pop {r1, r4}\n                str r1, [r0, #1*4] ; PC\n                mov r1, sp\n                str r1, [r0, #2*4] ; SP\n                str r5, [r0, #3*4] ; lambda ptr\n                bx r4\n                "),this.write("\n            .section code\n            ; r0 - try frame\n            ; r1 - thread context\n            _pxt_restore_exception_state:\n                mov r6, r1\n                ldr r1, [r0, #2*4] ; SP\n                mov sp, r1\n                ldr r5, [r0, #3*4] ; lambda ptr\n                ldr r1, [r0, #1*4] ; PC\n                movs r0, #1\n                orrs r1, r0\n                bx r1\n                "),this.write("\n            .section code\n            _pxt_stringConv:\n            "),this.loadVTable(),this.checkSubtype(this.builtInClassNo(pxt.BuiltInType.BoxedString),".notstring"),this.write("\n                bx lr\n\n            .notstring: ; no string, but vtable in r3\n                ldr r7, [r3, #4*"+(U.firstMethodOffset()-1)+"]\n                cmp r7, #0\n                beq .fail\n                push {r0, lr}\n                movs r4, #1\n                blx r7\n                str r0, [sp, #0]\n                b .numops\n\n            .fail: ; not an object or no toString\n                push {r0, lr}\n            .numops:\n                "+this.t.callCPP("numops::toString")+"\n                pop {r1}\n                pop {pc}\n            ")},e.prototype.emitProcCall=function(e){var t=this,r=[],n=null,i="",a=e.data;if(a.proc&&a.proc.inlineBody)return this.emitExpr(a.proc.inlineSelf(e.args));for(var s=-1==a.virtualIndex,o=!1,l=0,c=U.U.reversed(e.args);l<c.length;l++){if((y=c[l]).isPure()){if(!o||y.isStateless())continue}else o=!0;r.push(y)}if(r.reverse(),r.length<=1){var u=r[0];u&&(n=u,this.clearStack(!0),this.emitExpr(u),u==e.args[e.args.length-1]?i="r0":(i="r3",this.write(this.t.mov("r3","r0")))),r=[]}else for(var p=0,f=r;p<f.length;p++){var d=f[p];this.pushArg(d)}this.alignExprStack(e.args.length);var m=["r1","r2","r3","r4"],h=[];if(r.length){for(var g=-1,v=0,b=r;v<b.length;v++){var y=b[v];g=Math.max(this.exprStack.indexOf(y),g)}if(++g<=m.length){m=m.slice(0,g),this.write(this.t.pop_fixed(m)),h=this.exprStack.splice(0,g);for(var x=[],k=g-1;0<=k;--k)r.indexOf(h[k])<0&&(x.push(m[k]),this.exprStack.unshift(h[k]));x.length&&this.write(this.t.push_fixed(x))}else m=null,this.write(this.t.reg_gets_imm("r7",0))}var S=U.U.reversed(e.args);s&&S.unshift(S.pop());for(var T=0,w=S;T<w.length;T++){d=w[T];if(0<=r.indexOf(d)){if(m)this.write(this.t.push_fixed([m[h.indexOf(d)]]));else{this.write(this.loadFromExprStack("r0",d)),this.write(this.t.push_local("r0")+" ; re-push"),this.write(this.loadFromExprStack("r7",d,1,!0));var E=this.exprStack.indexOf(d),I=U.ir.numlit(0);I.currUses=1,I.totalUses=1,this.exprStack[E]=I}this.exprStack.unshift(d)}else d===n?(this.write(this.t.push_local(i)+" ; the one arg"),this.pushToExprStack(d)):this.pushArg(d)}var _=this.mkLbl("_proccall"),K=-1;if(s){var N=e.args.length-1;this.write(this.loadFromExprStack("r0",e.args[0])),this.emitLabelledHelper("lambda_call"+N,function(){t.lambdaCall(N),t.write(".fail:"),t.write(t.t.callCPP("pxt::failedCast"))})}else if(null!=a.virtualIndex||null!=a.ifaceIndex)null!=a.ifaceIndex?a.isSet?(U.assert(2==e.args.length),this.emitIfaceCall(a,e.args.length,"set")):this.emitIfaceCall(a,e.args.length,a.noArgs?"get":""):this.emitClassCall(a),this.write(_+":");else{var C=a.proc;K=C.seqNo,this.write(this.t.call_lbl(C.label()+(a.isThis?"_nochk":""))),this.write(_+":")}this.calls.push({procIndex:K,stack:0,addr:0,callLabel:_}),s&&e.args[0].isStateless()?this.clearArgs([e.args[0]],e.args.slice(1)):this.clearArgs([],e.args)},e.prototype.lambdaCall=function(e){this.write("; lambda call"),this.loadVTable(),U.target.switches.skipClassCheck||this.checkSubtype(this.builtInClassNo(pxt.BuiltInType.RefAction)),this.write("\n                movs r4, #"+e+"\n                ldrh r1, [r0, #4]\n                cmp r1, #0\n                bne .pushR5\n                ldr r1, [r0, #8]\n                bx r1 ; keep lr from the caller\n            .pushR5:\n                sub sp, #8\n            ");for(var t=0;t<e;++t)this.write("ldr r1, [sp, #4*"+(t+2)+"]"),this.write("str r1, [sp, #4*"+t+"]");this.write("\n                str r5, [sp, #4*"+e+"]\n                mov r1, lr\n                str r1, [sp, #4*"+(e+1)+"]\n                mov r5, r0\n                ldr r7, [r5, #8]\n                blx r7 ; exec actual lambda\n                ldr r4, [sp, #4*"+(e+1)+"] ; restore what was in LR\n                ldr r5, [sp, #4*"+e+"] ; restore lambda ctx\n            ");for(t=0;t<e;++t)this.write("ldr r1, [sp, #4*"+t+"]"),this.write("str r1, [sp, #4*"+(t+2)+"]");this.write("\n                add sp, #8\n                bx r4\n            "),this.write("; end lambda call")},e.prototype.emitStore=function(e,t){var r=this;switch(e.exprKind){case U.ir.EK.CellRef:var n=e.data;if(this.emitExpr(t),n.isGlobal()){var i=this.bitSizeInfo(n.bitSize),a="#"+n.index;n.index>=i.immLimit&&(this.write(this.t.emit_int(n.index,"r1")),a="r1"),this.write(this.t.load_reg_src_off("r7","r6","#0")),this.write(this.t.load_reg_src_off("r0","r7",a,!1,!0,i))}else{var s=this.cellref(n),o=s[0],l=s[1];a=s[2];this.write(this.t.load_reg_src_off("r0",o,l,a,!0))}break;case U.ir.EK.FieldAccess:this.emitRtCall(U.ir.rtcall("dummy",[e.args[0],t]),function(){return r.emitFieldAccess(e,!0)});break;default:U.oops()}},e.prototype.cellref=function(e){if(e.isGlobal())throw U.oops();if(e.iscap){var t=e.index+3;return U.assert(0<=t&&t<32),["r5",t.toString(),!0]}return e.isarg?["sp","args@"+(t=e.index).toString()+":"+this.baseStackSize,!1]:["sp","locals@"+e.index,!1]},e.prototype.emitLambdaWrapper=function(e){var t=this;if(this.write(""),this.write(".section code"),this.write(".balign 4"),e&&(this.proc.info.usedAsValue=!0),this.proc.info.usedAsValue||this.proc.info.usedAsIface){this.proc.info.usedAsValue&&(this.write(this.proc.label()+"_Lit:"),this.write(this.t.obj_header("pxt::RefAction_vtable")),this.write(".short 0, 0 ; no captured vars"),this.write(".word "+this.proc.label()+"_args@fn")),this.write(this.proc.label()+"_args:");var r=this.proc.args.length;if(0!=r){this.write("cmp r4, #"+r),this.write("bge "+this.proc.label()+"_nochk");var n=this.stackAlignmentNeeded(r+1),i=n?r+2:r+1;this.write("push {lr}"),this.emitLabelledHelper("expand_args_"+r,function(){t.write("movs r0, #0"),t.write("movs r1, #0"),n&&t.write("push {r0}");for(var e=r;0<e;e--)e!=r&&(t.write("cmp r4, #"+e),t.write("blt .zero"+e),t.write("ldr r0, [sp, #"+(i-1)+"*4]"),t.write("str r1, [sp, #"+(i-1)+"*4] ; clear existing"),t.write(".zero"+e+":")),t.write("push {r0}");t.write("bx lr")}),this.write("bl "+this.proc.label()+"_nochk");var a=r+(n?1:0);this.write("@dummystack "+a),this.write("add sp, #4*"+a),this.write("pop {pc}")}}},e.prototype.emitCallRaw=function(e){var t=U.hex.lookupFunc(e);U.assert(!!t,"unimplemented raw function: "+e),this.alignedCall(e)},e}();U.ProctoAssembler=t}(e.pxtc||(e.pxtc={}))}(ts||(ts={})),function(e){!function(U){var A={"numops::adds":"+","numops::subs":"-","numops::div":"/","numops::mod":"%","numops::muls":"*","numops::ands":"&","numops::orrs":"|","numops::eors":"^","numops::bnot":"~","numops::lsls":"<<","numops::asrs":">>","numops::lsrs":">>>","numops::le":"<=","numops::lt":"<","numops::lt_bool":"<","numops::ge":">=","numops::gt":">","numops::eq":"==","pxt::eq_bool":"==","pxt::eqq_bool":"===","numops::eqq":"===","numops::neqq":"!==","numops::neq":"!="},g={"pxsim.Boolean_":"","pxsim.pxtcore":"","pxsim.String_":"","pxsim.ImageMethods":"","pxsim.Array_":"","pxsim.pxtrt":"","pxsim.numops":""},v={"pxsim.Array_.getAt":"","pxsim.Array_.length":"","pxsim.Array_.mk":"","pxsim.Array_.push":"","pxsim.Boolean_.bang":"","pxsim.String_.concat":"","pxsim.String_.stringConv":"","pxsim.numops.toBool":"","pxsim.numops.toBoolDecr":"","pxsim.pxtcore.mkAction":"","pxsim.pxtcore.mkClassInstance":"","pxsim.pxtrt.ldlocRef":"","pxsim.pxtrt.mapGetByString":"","pxsim.pxtrt.stclo":"","pxsim.pxtrt.stlocRef":""};function b(e){for(var t="",r=0,n=Object.keys(e);r<n.length;r++){var i=n[r],a=i.replace(/\./g,"_");t+="const "+(e[i]=a)+" = "+i+";\n"}return t}function P(e){"pxt."==(e=e.replace(/::/g,".")).slice(0,4)&&(e="pxtcore."+e.slice(4));var t="pxsim."+e;if(v.hasOwnProperty(t))return v[t];var r=t.lastIndexOf(".");if(0<r){var n=t.slice(0,r);if(g.hasOwnProperty(n))return g[n]+t.slice(r)}return t}U.isBuiltinSimOp=function(e){return!!U.U.lookup(A,e.replace(/\./g,"::"))},U.shimToJs=P;var y=["runtime","oops","doNothing","pxsim","globals","maybeYield","setupDebugger","isBreakFrame","breakpoint","trace","checkStack","leave","checkResumeConsumed","setupResume","setupLambda","checkSubtype","failedCast","buildResume","mkVTable","bind","leaveAccessor"];U.jsEmit=function(r){for(var n="(function (ectx) {\n'use strict';\n",e=0,t=y;e<t.length;e++){var i=t[e];n+="const "+i+" = ectx."+i+";\n"}n+="const __this = runtime;\n",n+="const pxtrt = pxsim.pxtrt;\n",n+="let yieldSteps = 1;\n",n+="ectx.setupYield(function() { yieldSteps = 100; })\n",n+="pxsim.setTitle("+JSON.stringify(r.getTitle())+");\n";for(var a={},s={},o=0,l=r.res.configData||[];o<l.length;o++){var c=l[o];a[c.key+""]=c.value,s[c.name]=c.key}n+="pxsim.setConfigData("+JSON.stringify(a,null,1)+", "+JSON.stringify(s,null,1)+");\n",n+="pxtrt.mapKeyNames = "+JSON.stringify(r.ifaceMembers,null,1)+";\n";var u=r.setPerfCounters(["SysScreen"]);n+="__this.setupPerfCounters("+JSON.stringify(u,null,1)+");\n",n+=b(v),n+=b(g);var p=0,f=0;r.procs.forEach(function(e){var t;e.cachedJS?(t=e.cachedJS,p+=t.length):(t=function(g,v){if(v.cachedJS)return v.cachedJS;var t="",b=function(e){t+=e+"\n"},y=function(e){t+="    "+e+"\n"},s=U.ir.EK,x=[],n=0,r={},i="";b("\nfunction "+v.label()+"(s) {\nlet r0 = s.r0, step = s.pc;\ns.pc = -1;\n"),v.perfCounterNo&&b("if (step == 0) __this.startPerfCounter("+v.perfCounterNo+");\n"),b("\nwhile (true) {\nif (yieldSteps-- < 0 && maybeYield(s, step, r0)) return null;\nswitch (step) {\n  case 0:\n"),v.locals.forEach(function(e){y(T(e)+" = undefined;")}),v.args.length&&(y("if (s.lambdaArgs) {"),v.args.forEach(function(e,t){y("  "+T(e)+" = (s.lambdaArgs["+t+"]);")}),y("  s.lambdaArgs = null;"),y("}")),v.classInfo&&v.info.thisParameter&&(y("r0 = s.arg0;"),N(v.classInfo,"validate"));for(var k=0,o=[],e=0,a=v.body;e<a.length;e++){var l=a[e];l.stmtKind==U.ir.SK.Label&&0<l.lblNumUses&&(l.lblId=++k)}for(var c=0,u=0,p=v.body;u<p.length;u++){var l=p[u];switch(l.stmtKind){case U.ir.SK.Expr:_(l.expr);break;case U.ir.SK.StackEmpty:C();break;case U.ir.SK.Jmp:for(var f=!1,d=c+1;d<v.body.length&&v.body[d].stmtKind==U.ir.SK.Label;++d)if(l.lbl==v.body[d]){f=!0;break}w(l,f);break;case U.ir.SK.Label:0<l.lblNumUses&&b("  case "+l.lblId+":");break;case U.ir.SK.Breakpoint:h(l);break;default:U.oops()}c++}C(),v.perfCounterNo&&b("__this.stopPerfCounter("+v.perfCounterNo+");\n"),v.isGetter()?y("return leaveAccessor(s, r0)"):y("return leave(s, r0)"),b("  default: oops()"),b("} } }");var m=U.nodeLocationInfo(v.action);return m.functionName=v.getName(),m.argumentNames=v.args&&v.args.map(function(e){return e.getName()}),b(v.label()+".info = "+JSON.stringify(m)),v.isGetter()&&b(v.label()+".isGetter = true;"),v.isRoot&&b(v.label()+".continuations = [ "+o.join(",")+" ]"),b(v.label()+".info = "+JSON.stringify(m)),b(S(v.label()+"_mk",v.label(),n,Object.keys(r))),b(i),v.cachedJS=t;function S(e,t,r,n){var i="";i+="\nfunction "+e+"(s) {\n    checkStack(s.depth);\n    return {\n        parent: s, fn: "+t+", depth: s.depth + 1,\n        pc: 0, retval: undefined, r0: undefined, overwrittenPC: false, lambdaArgs: null,\n";for(var a=0;a<r;++a)i+="  tmp_"+a+": undefined,\n";for(var s=0,o=n;s<o.length;s++){var l=o[s];i+="  "+l+": undefined,\n"}return i+="} }\n"}function h(e){var t,r=e.breakpointInfo.id;if(y("s.lastBrkId = "+r+";"),g.options.trace)t=++k,y("return trace("+r+", s, "+t+", "+v.label()+".info);");else{if(!g.options.breakpoints)return;var n="return breakpoint(s, "+(t=++k)+", "+r+", r0);";e.breakpointInfo.isDebuggerStmt?y(n):y("if ((breakpoints[0] && isBreakFrame(s)) || breakpoints["+r+"]) "+n)}b("  case "+t+":")}function T(e){if(e.isGlobal())return"globals."+e.uniqueName();if(e.iscap)return"s.caps["+e.index+"]";var t=e.uniqueName();return r[t]=!0,"s."+t}function w(e,t){if(e.lbl.lblNumUses==U.ir.lblNumUsesJmpNext||t)return U.assert(e.jmpMode==U.ir.JmpMode.Always),void(e.expr&&_(e.expr));U.assert(0<e.lbl.lblNumUses);var r="{ step = "+e.lbl.lblId+"; continue; }";e.jmpMode==U.ir.JmpMode.Always?(e.expr&&_(e.expr),y(r)):(_(e.expr),e.jmpMode==U.ir.JmpMode.IfNotZero?y("if (r0) "+r):y("if (!r0) "+r))}function E(e){return function(e){switch(e.exprKind){case s.NumberLiteral:case s.PointerLiteral:case s.SharedRef:case s.CellRef:return!0;default:return!1}}(e)?I(e):(_(e),"r0")}function I(e){switch(e.exprKind){case s.NumberLiteral:if(!0===e.data)return"true";if(!1===e.data)return"false";if(null===e.data)return"null";if(void 0===e.data)return"undefined";if("number"==typeof e.data)return e.data+"";throw U.oops("invalid data: "+typeof e.data);case s.PointerLiteral:if(e.ptrlabel())return e.ptrlabel().lblId+"";if(null!=e.hexlit())return i+="const "+e.data+' = pxsim.BufferMethods.createBufferFromHex("'+e.hexlit()+'")\n',e.data;if("string"==typeof e.jsInfo)return e.jsInfo;U.U.oops();case s.SharedRef:var t=e.args[0];U.U.assert(!!t.currUses),U.U.assert(t.currUses<t.totalUses),t.currUses++;var r=x.indexOf(t);return U.U.assert(0<=r),"s.tmp_"+r;case s.CellRef:var n=e.data;return T(n);default:throw U.oops()}}function _(e){switch(e.exprKind){case s.JmpValue:y("// jmp value (already in r0)");break;case s.Nop:y("// nop");break;case s.FieldAccess:var t=e.data,r=t.shimName,n=E(e.args[0]);return r?void y("r0 = "+n+r+";"):void y("r0 = "+n+'.fields["'+t.name+'"];');case s.Store:return function(e,t){switch(e.exprKind){case s.CellRef:var r=e.data,n=E(t);y(T(r)+" = "+function(e){switch(e){case 0:return"";case 1:return"pxtrt.toInt8";case 3:return"pxtrt.toInt16";case 5:return"pxtrt.toInt32";case 2:return"pxtrt.toUInt8";case 4:return"pxtrt.toUInt16";case 6:return"pxtrt.toUInt32";default:throw U.oops()}}(r.bitSize)+"("+n+");");break;case s.FieldAccess:var i=e.data,a=i.shimName;a||(a='.fields["'+i.name+'"]'),_(U.ir.rtcall("="+a,[e.args[0],t]));break;default:U.oops()}}(e.args[0],e.args[1]);case s.RuntimeCall:return function(e){var t=U.ir.flattenArgs(e.args);t.precomp.forEach(_);var r=e.data,n=t.flattened.map(I);if("langsupp::ignore"!=r){var i="";if(i="."==r[0]?""+n[0]+r+"("+n.slice(1).join(", ")+")":"="==r[0]?"("+n[0]+")"+r.slice(1)+" = ("+n[1]+")":U.U.startsWith(r,"new ")?"new "+P(r.slice(4))+"("+n.join(", ")+")":U.U.lookup(A,r)?2==n.length?"("+n[0]+" "+U.U.lookup(A,r)+" "+n[1]+")":"("+U.U.lookup(A,r)+" "+n[0]+")":P(r)+"("+n.join(", ")+")",0==e.callingConvention)y("r0 = "+i+";");else{var a=++k;o.push(a),"String_::stringConv"==r&&y("if (("+n[0]+") && ("+n[0]+").vtable) {"),2==e.callingConvention?y("(function(cb) { "+i+".done(cb) })(buildResume(s, "+a+"));"):(y("setupResume(s, "+a+");"),y(i+";")),y("checkResumeConsumed();"),y("return;"),"String_::stringConv"==r&&y("} else { s.retval = ("+n[0]+') + ""; }'),b("  case "+a+":"),y("r0 = s.retval;")}}}(e);case s.ProcCall:return function(e){var t=e.data,r=t.proc;if(r&&r.inlineBody)return _(r.inlineSelf(e.args));var n=U.ir.rtcall("<frame>",[]);n.totalUses=1,n.currUses=0;var i=x.length;x.push(n);var a="s.tmp_"+i,s=++k,o=-1==t.virtualIndex;if(r)y(a+" = "+r.label()+"_mk(s);");else{var l="generic";null!=t.ifaceIndex?l="if_"+g.ifaceMembers[t.ifaceIndex]:o?l="lambda":null!=t.virtualIndex?l=t.classInfo.id+"_v"+t.virtualIndex:U.U.oops();var c=e.args.length;l+="_"+c+"_mk",g.recordHelper(v.usingCtx,l,function(){var e=U.U.range(c).map(function(e){return"arg"+e});return S(l,"null",5,e)}),y(a+" = "+l+"(s);")}e.args.forEach(function(e,t){var r="arg"+t;o&&(r=0==t?"argL":"arg"+(t-1)),y(a+"."+r+" = "+E(e)+";")});var u="s.pc = "+s+"; return "+a+";";if(null!=t.ifaceIndex){U.U.assert(null==r);var p=g.ifaceMembers[t.ifaceIndex];U.U.assert(!!p,"no name for "+t.ifaceIndex),y("if (!"+a+".arg0.vtable.iface) {");var f=e.args.map(function(e,t){return a+".arg"+t});f.splice(1,0,JSON.stringify(p));var d="pxsim_pxtrt.map"+(t.isSet?"Set":"Get")+"ByString";t.noArgs?y("  s.retval = "+d+"("+f.join(", ")+");"):(U.U.assert(!t.isSet),y("  setupLambda("+a+", "+d+"("+f.slice(0,2).join(", ")+"), "+e.args.length+");"),y("  "+u)),y("} else {"),y("  "+a+".fn = "+a+'.arg0.vtable.iface["'+(t.isSet?"set/":"")+p+'"];');var m=a+'.arg0.fields["'+p+'"]';t.isSet?(y("  if ("+a+".fn === null) { "+m+" = "+a+".arg1; }"),y("  else if ("+a+".fn === undefined) { failedCast("+a+".arg0) } ")):t.noArgs?(y("  if ("+a+".fn == null) { s.retval = "+m+"; }"),y("  else if (!"+a+".fn.isGetter) { s.retval = bind("+a+"); }")):(y("  if ("+a+".fn == null) { setupLambda("+a+", "+m+", "+e.args.length+"); "+u+" }"),y("  else if ("+a+".fn.isGetter) { "+a+".stage2Call = true; "+u+"; }")),y(" else { "+u+" }"),y("}"),u=""}else if(-1==t.virtualIndex)U.U.assert(null==r),y("setupLambda("+a+", "+a+".argL);");else if(null!=t.virtualIndex){U.U.assert(null==r),U.assert(0<=t.virtualIndex),N(t.classInfo,"validate",a+".arg0");var h=t.classInfo.vtable[t.virtualIndex];y(a+".fn = "+a+".arg0.vtable.methods."+h.getName()+";")}else U.U.assert(null!=r);u&&y(u),b("  case "+s+":"),y("r0 = s.retval;"),n.currUses=1}(e);case s.SharedDef:return function(e){var t=e.args[0];if(U.U.assert(1<=t.totalUses),U.U.assert(0===t.currUses),(t.currUses=1)==t.totalUses)return _(t);var r=x.length;x.push(t);var n=E(t);"r0"!=n&&(n="r0 = "+n),y("s.tmp_"+r+" = "+n+";")}(e);case s.Sequence:return e.args.forEach(_);case s.InstanceOf:return _(e.args[0]),void N(e.data,e.jsInfo);default:y("r0 = "+I(e)+";")}}function K(e,t){void 0===t&&(t="r0");var r=e.id+"_VT";return"checkSubtype("+t+", "+r+")"}function N(e,t,r){void 0===r&&(r="r0"),"bool"==t?y("r0 = "+K(e)+";"):"validate"==t?y("if (!"+K(e,r)+") failedCast("+r+");"):U.U.oops()}function C(){for(var e=0,t=x;e<t.length;e++){var r=t[e];r.totalUses!==r.currUses&&U.oops()}n=Math.max(x.length,n),x=[]}}(r,e),f+=t.length),n+="\n"+t+"\n"}),n+=U.U.values(r.codeHelpers).join("\n")+"\n",r.usedClassInfos.forEach(function(e){n+=function(e){U.U.assert(void 0!==e.classNo),U.U.assert(void 0!==e.lastSubtypeNo);var t=parseInt(e.attrs.maxBgInstances);t||(t=null);for(var r="const "+e.id+"_VT = mkVTable({\n  name: "+JSON.stringify(U.getName(e.decl))+",\n  numFields: "+e.allfields.length+",\n  classNo: "+e.classNo+",\n  lastSubtypeNo: "+e.lastSubtypeNo+",\n  maxBgInstances: "+t+",\n  methods: {\n",n=0,i=e.vtable;n<i.length;n++)r+='    "'+(o=i[n]).getName()+'": '+o.label()+",\n";r+="  },\n",r+="  iface: {\n";for(var a=0,s=e.itable;a<s.length;a++){var o;r+='    "'+(o=s[a]).name+'": '+(o.proc?o.proc.label():"null")+",\n",o.setProc?r+='    "set/'+o.name+'": '+o.setProc.label()+",\n":o.proc||(r+='    "set/'+o.name+'": null,\n')}return r+="  },\n",e.toStringMethod&&(r+="  toStringMethod: "+e.toStringMethod.label()+",\n"),r+="});\n"}(e)}),r.res.breakpoints&&(n+="\nconst breakpoints = setupDebugger("+r.res.breakpoints.length+", ["+r.globals.filter(function(e){return e.isUserVariable}).map(function(e){return'"'+e.uniqueName()+'"'}).join(",")+"])\n");var d=(n+="\nreturn "+(r.procs[0]?r.procs[0].label():"null")+"\n})\n").length,m=function(e){return(100*e/d).toFixed(2)+"%"},h="// total="+n.length+" new="+m(f)+" cached="+m(p)+" other="+m(d-f-p)+"\n";r.writeFile(U.BINARY_JS,h+n)}}(e.pxtc||(e.pxtc={}))}(ts||(ts={})),function(e){!function(m){m.thumbCmpMap={"numops::lt":"_cmp_lt","numops::gt":"_cmp_gt","numops::le":"_cmp_le","numops::ge":"_cmp_ge","numops::eq":"_cmp_eq","numops::eqq":"_cmp_eqq","numops::neq":"_cmp_neq","numops::neqq":"_cmp_neqq"};var i={"numops::adds":"_numops_adds","numops::subs":"_numops_subs","numops::orrs":"_numops_orrs","numops::eors":"_numops_eors","numops::ands":"_numops_ands","numops::lsls":"_numops_lsls","numops::asrs":"_numops_asrs","numops::lsrs":"_numops_lsrs","pxt::toInt":"_numops_toInt","pxt::fromInt":"_numops_fromInt"},e=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.stackAligned=function(){return m.target.stackAlign&&1<m.target.stackAlign},t.prototype.pushLR=function(){return this.stackAligned()?"push {lr, r5}  ; r5 for align":"push {lr}"},t.prototype.popPC=function(){return this.stackAligned()?"pop {pc, r5}  ; r5 for align":"pop {pc}"},t.prototype.nop=function(){return"nop"},t.prototype.mov=function(e,t){return"mov "+e+", "+t},t.prototype.helper_ret=function(){return"bx r4"},t.prototype.reg_gets_imm=function(e,t){return"movs "+e+", #"+t},t.prototype.push_fixed=function(e){return"push {"+e.join(", ")+"}"},t.prototype.pop_fixed=function(e){return"pop {"+e.join(", ")+"}"},t.prototype.proc_setup=function(e,t){var r="";if(0<e){r+="    movs r0, #0\n";for(var n=0;n<e;++n)r+="    push {r0} ;loc\n"}return r},t.prototype.proc_return=function(){return"pop {pc}"},t.prototype.debugger_stmt=function(e){return m.target.gc&&m.oops(),"\n    @stackempty locals\n    ldr r0, [r6, #0] ; debugger\n    subs r0, r0, #4  ; debugger\n"+e+":\n    ldr r0, [r0, #0] ; debugger\n"},t.prototype.debugger_bkpt=function(e){return m.target.gc&&m.oops(),"\n    @stackempty locals\n    ldr r0, [r6, #0] ; brk\n"+e+":\n    ldr r0, [r0, #0] ; brk\n"},t.prototype.debugger_proc=function(e){return m.target.gc&&m.oops(),"\n    ldr r0, [r6, #0]  ; brk-entry\n    ldr r0, [r0, #4]  ; brk-entry\n"+e+":"},t.prototype.push_local=function(e){return"push {"+e+"}"},t.prototype.push_locals=function(e){return"sub sp, #4*"+e+" ; push locals "+e+" (align)"},t.prototype.pop_locals=function(e){return"add sp, #4*"+e+" ; pop locals "+e},t.prototype.unconditional_branch=function(e){return"bb "+e},t.prototype.beq=function(e){return"beq "+e},t.prototype.bne=function(e){return"bne "+e},t.prototype.cmp=function(e,t){return"cmp "+e+", "+t},t.prototype.cmp_zero=function(e){return"cmp "+e+", #0"},t.prototype.load_reg_src_off=function(e,t,r,n,i,a){r=r.replace(/:\d+$/,""),n&&(r="#4*"+r);var s="str",o="ldr";return a&&(32==a.immLimit?s="strb":64==a.immLimit&&(s="strh"),o=a.needsSignExt?s.replace("str","ldrs"):s.replace("str","ldr")),i?s+" "+e+", ["+t+", "+r+"]":o+" "+e+", ["+t+", "+r+"]"},t.prototype.rt_call=function(e,t,r){return e+" "+t+", "+r},t.prototype.alignedCall=function(e,t){return t?this.push_locals(t)+"\nbl "+e+"\n"+this.pop_locals(t):"bl "+e},t.prototype.call_lbl=function(e,t,r){var n=m.U.lookup(i,e);return n&&(e=n,t=!1),!t&&0<e.indexOf("::")&&(t=!0),t?this.callCPP(e,r):this.alignedCall(e,r)},t.prototype.call_reg=function(e){return"blx "+e},t.prototype.vcall=function(e,t,r){return"\n    ldr r0, [sp, #0] ; ld-this\n    ldrh r3, [r0, #2] ; ld-vtable\n    lsls r3, r3, #"+r+"\n    ldr r3, [r3, #4] ; iface table\n    cmp r3, #43\n    beq .objlit\n.nonlit:\n    lsls r1, "+(t?"r2":"r1")+", #2\n    ldr r0, [r3, r1] ; ld-method\n    bx r0\n.objlit:\n    "+(t?"ldr r2, [sp, #4]":"")+"\n    movs r3, #0 ; clear args on stack, so the outside decr() doesn't touch them\n    str r3, [sp, #0]\n    "+(t?"str r3, [sp, #4]":"")+"\n    "+this.pushLR()+"\n    "+this.callCPP(e)+"\n    "+this.popPC()+"\n"},t.prototype.prologue_vtable=function(e,t){return"\n    ldr r0, [sp, #4*"+e+"]  ; ld-this\n    ldrh r0, [r0, #2] ; ld-vtable\n    lsls r0, r0, #"+t+"\n    "},t.prototype.helper_prologue=function(){return"\n    @stackmark args\n    "+this.pushLR()+"\n"},t.prototype.helper_epilogue=function(){return"\n    "+this.popPC()+"\n    @stackempty args\n"},t.prototype.load_ptr_full=function(e,t){return m.assert(!!e),"\n    ldlit "+t+", "+e+"\n"},t.prototype.load_vtable=function(e,t){return"ldr "+e+", ["+t+", #0]"},t.prototype.lambda_init=function(){return"\n    mov r5, r0\n    mov r4, lr\n    bl pxtrt::getGlobalsPtr\n    mov r6, r0\n    bx r4\n"},t.prototype.saveThreadStack=function(){return"mov r7, sp\n    str r7, [r6, #4]\n"},t.prototype.restoreThreadStack=function(){return m.target.gc&&m.target.switches.gcDebug?"movs r7, #0\n    str r7, [r6, #4]\n":""},t.prototype.callCPPPush=function(e){return this.pushLR()+"\n"+this.callCPP(e)+"\n"+this.popPC()+"\n"},t.prototype.callCPP=function(e,t){return this.saveThreadStack()+this.alignedCall(e,t)+"\n"+this.restoreThreadStack()},t.prototype.inline_decr=function(e){return"\n    lsls r1, r0, #30\n    bne .tag"+e+"\n    bl _pxt_decr\n.tag"+e+":\n"},t.prototype.arithmetic=function(){for(var r=this,t="",n=function(e){var t=".boxed:\n";return t+="\n                    "+r.pushLR()+"\n                    push {r0, r1}\n                    "+r.saveThreadStack()+"\n                    "+e+"\n                    "+r.restoreThreadStack()+"\n                    add sp, #8\n                    "+r.popPC()+"\n                "},e=function(e){t+="\n_numops_"+e+":\n    @scope _numops_"+e+"\n    lsls r2, r0, #31\n    beq .boxed\n    lsls r2, r1, #31\n    beq .boxed\n"},i=function(e){t+="    blx lr\n",t+=n("bl numops::"+e)},a=0,s=["adds","subs"];a<s.length;a++){e(d=s[a]),t+="\n    subs r2, r1, #1\n    "+d+" r2, r0, r2\n    bvs .boxed\n    movs r0, r2\n",i(d)}for(var o=0,l=["ands","orrs","eors"];o<l.length;o++){e(d=l[o]),t+="    "+d+" r0, r1\n","eors"==d&&(t+="    adds r0, r0, #1\n"),i(d)}for(var c=0,u=["lsls","lsrs","asrs"];c<u.length;c++){e(d=u[c]),t+="\n    ; r3 := (r1 >> 1) & 0x1f\n    lsls r3, r1, #26\n    lsrs r3, r3, #27\n","asrs"==d?t+="\n    asrs r0, r3\n    movs r2, #1\n    orrs r0, r2\n":(t+="lsrs"==d?"\n    asrs r2, r0, #1\n    lsrs r2, r3\n    lsrs r3, r2, #30\n    bne .boxed\n":"\n    asrs r2, r0, #1\n    lsls r2, r3\n    lsrs r3, r2, #30\n    beq .ok\n    cmp r3, #3\n    bne .boxed\n.ok:\n",t+="\n    lsls r0, r2, #1\n    adds r0, r0, #1\n"),i(d)}t+="\n@scope _numops_toInt\n_numops_toInt:\n    asrs r0, r0, #1\n    bcc .over\n    blx lr\n.over:\n    lsls r0, r0, #1\n    "+this.callCPPPush("pxt::toInt")+"\n\n_numops_fromInt:\n    lsls r2, r0, #1\n    asrs r1, r2, #1\n    cmp r0, r1\n    bne .over2\n    adds r0, r2, #1\n    blx lr\n.over2:\n    "+this.callCPPPush("pxt::fromInt")+"\n";for(var p=0,f=Object.keys(m.thumbCmpMap);p<f.length;p++){var d;d=(d=f[p]).replace(/.*::/,""),t+="\n.section code\n_cmp_"+d+":\n    lsls r2, r0, #31\n    beq .boxed\n    lsls r2, r1, #31\n    beq .boxed\n    subs r0, r1\n    b"+d.replace("qq","q").replace("neq","ne")+" .true\n.false:\n    movs r0, #0\n    bx lr\n.true:\n    movs r0, #1\n    bx lr\n",t+=n("\n                        bl numops::"+d+"\n                        bl numops::toBoolDecr\n                        cmp r0, #0")}return t},t.prototype.emit_int=function(e,r){var n=!1;function t(e){m.assert(0<=e&&e<=255);var t="";return n?e&&(t="adds "+r+", #"+e+"\n"):t="movs "+r+", #"+e+"\n",n=!0,t}function i(e){return void 0===e&&(e=8),"lsls "+r+", "+r+", #"+e+"\n"}m.assert(null!=e);var a=Math.floor(e),s=!1;a<0&&(s=!0,a=-a);var o=0;if(255<a){for(var l=a;0==(1&l);)l>>>=1,o++;m.numBytes(l)<m.numBytes(a)?a=l:o=0}var c="";switch(m.numBytes(a)){case 4:c+=t(a>>>24&255),c+=i();case 3:c+=t(a>>>16&255),c+=i();case 2:c+=t(a>>>8&255),c+=i();case 1:c+=t(255&a);break;default:m.oops()}return o&&(c+=i(o)),s&&(c+="negs "+r+", "+r+"\n"),4<c.split("\n").length?"ldlit "+r+", "+Math.floor(e)+"\n":c},t}(m.AssemblerSnippets);m.ThumbSnippets=e}(e.pxtc||(e.pxtc={}))}(ts||(ts={})),function(U){!function(I){var _,e,K={"pxtrt::mapSetGeneric":"mapset","pxtrt::mapGetGeneric":"mapget"},N={};function C(e){var t=e.getTime()/1e3;return(t>>>0)+", "+(t/4294967296|0)}(e=_||(_={}))[e.Invalid=0]="Invalid",e[e.InfoHeader=1]="InfoHeader",e[e.OpCodeMap=2]="OpCodeMap",e[e.NumberLiterals=3]="NumberLiterals",e[e.ConfigData=4]="ConfigData",e[e.IfaceMemberNames=5]="IfaceMemberNames",e[e.Function=32]="Function",e[e.Literal=33]="Literal",e[e.VTable=34]="VTable",I.vmEmit=function(r,e){var l="; VM start\n"+I.hex.hexPrelude()+"\n",t={dblText:[],dbls:{},opcodeMap:{},opcodes:I.vm.opcodes.map(function(e){return"pxt::op_"+e.replace(/ .*/,"")})};for(t.opcodes.unshift(null);t.opcodes.length<128;)t.opcodes.push(null);var c=0;function n(e,t,r,n,i){if(void 0===i&&(i=0),l+="\n; --- "+e+"\n.section code\n    .set "+e+" = "+c+"\n",n)for(var a=0,s=n;a<s.length;a++){var o=s[a];l+="    .set "+o+" = "+c+"\n"}l+="\n_start_"+e+":\n    .byte "+t+", 0x00\n    .short "+i+"\n    .word _end_"+e+"-_start_"+e+"\n",l+=r(),l+="\n.balign 8\n_end_"+e+":\n",c++}var i=new Date,a=I.U.toUTF8(e.name,!0);100<a.length&&(a=a.slice(0,100));var s=a.length+1;1&s&&s++;var o=128-s;n("_info",_.InfoHeader,function(){return'\n                ; magic - \\0 added by assembler\n                .string "\\nPXT64\\n"\n                .hex 5471fe2b5e213768 ; magic\n                .hex '+I.hex.hexTemplateHash()+" ; hex template hash\n                .hex 0000000000000000 ; @SRCHASH@\n                .word "+r.globalsWords+"   ; num. globals\n                .word "+r.nonPtrGlobals+" ; non-ptr globals\n                .word 0, 0 ; last usage time\n                .word "+C(i)+" ; installation time\n                .word "+C(i)+" ; publication time - TODO\n                .space 64 ; reserved\n                .string "+JSON.stringify(a)+"\n                .space "+o+" ; pad to 128 bytes\n"}),r.procs.forEach(function(e){n(e.label(),_.Function,function(){return function(d,p,s){var t="",o=function(e){t+=e+"\n"},m=function(e){t+="    "+e+"\n"},h=I.ir.EK,i=[],g=[],a=!1,l=0,v=0,b=8388607;pxt.options.debug&&console.log("EMIT",s.toString()),c(),t="";for(var e=0,r=i;e<r.length;e++){var n=r[e];n.currUses=0}return a=!0,I.U.assert(0==v),c(),t;function c(){o(";\n; Proc: "+s.getFullName()+"\n;"),m(".section code"),p.procs[0]==s&&o("; main"),m(".short 0, "+s.args.length+" ; #args"),m(".short "+s.captured.length+", 0 ; #cap"),m(".word 0, 0"),l=s.locals.length+g.length,m("pushmany "+l+" ; incl. "+g.length+" tmps");for(var e=0,t=s.body;e<t.length;e++){var r=t[e];switch(r.stmtKind){case I.ir.SK.Expr:x(r.expr);break;case I.ir.SK.StackEmpty:S();for(var n=0,i=g;n<i.length;n++){var a=i[n];a&&I.oops("uses: "+a.currUses+"/"+a.totalUses+" "+a.toString())}break;case I.ir.SK.Jmp:u(r);break;case I.ir.SK.Label:o(r.lblName+":");break;case I.ir.SK.Breakpoint:break;default:I.oops()}}m("ret "+s.args.length+", "+l)}function u(e){var t=e.lbl.lblName;e.jmpMode==I.ir.JmpMode.Always?(e.expr&&x(e.expr),m("jmp "+t)):(x(e.expr),e.jmpMode==I.ir.JmpMode.IfNotZero?m("jmpnz "+t):e.jmpMode==I.ir.JmpMode.IfZero?m("jmpz "+t):I.oops())}function y(e){if(e.isGlobal())return I.U.assert(0==(3&e.index)),"glb "+(e.index>>2)+" ; "+e.getName();if(e.iscap)return"cap "+e.index+" ; "+e.getName();if(e.isarg){var t=s.args.length-e.index-1;return I.assert(0<=t,"arg#"+t),"loc "+(v+l+2+t)+" ; "+e.getName()}var t=e.index+g.length;return I.assert(!a||t<l,"cell#"+t),I.assert(0<=t,"cell#"+t),"loc "+(v+t)}function f(e){switch(e.exprKind){case h.NumberLiteral:var t=I.taggedSpecial(e.data);if(null!=t)m("ldspecial "+t+" ; "+e.data);else{var r=e.data,n=0,i=0;if((0|r)==r){if(Math.abs(r)<=b)return void m(r<0?"ldintneg "+-r:"ldint "+r);n=(r<<1|1)>>>0,i=r<0?1:0}else{var a=new Float64Array(1);a[0]=r;var s=new Uint32Array(a.buffer);s[1]+=65536,n=s[0],i=s[1]}var o=n+","+i,l=I.U.lookup(d.dbls,o);null==l&&(l=d.dblText.length,d.dblText.push(".word "+n+", "+i+"  ; "+l+": "+e.data),d.dbls[o]=l),m("ldnumber "+l+" ; "+e.data)}return;case h.PointerLiteral:return void m("ldlit "+e.data);case h.SharedRef:var c=e.args[0];I.U.assert(!!c.currUses),I.U.assert(c.currUses<c.totalUses),c.currUses++;var u=g.indexOf(c);return u<0&&(console.log(g,c),I.assert(!1)),m("ldloc "+(u+v)+(c.currUses==c.totalUses?" ; LAST":"")),void S();case h.CellRef:m("ld"+y(e.data));var p=e.data;return void(p.isGlobal()&&(1==p.bitSize?m("sgnext"):2==p.bitSize&&m("clrhi")));case h.InstanceOf:x(e.args[0]),f=e.data,"bool"==e.jsInfo?m("checkinst "+f.id+"_VT"):I.U.oops();break;default:throw I.oops("kind: "+e.exprKind)}var f}function x(e){switch(e.exprKind){case h.JmpValue:m("; jmp value (already in r0)");break;case h.Nop:m("; nop");break;case h.FieldAccess:var t=e.data;x(e.args[0]),m("ldfld "+t.idx+", "+t.classInfo.id+"_VT");break;case h.Store:return function(e,t){switch(e.exprKind){case h.CellRef:x(t);var r=e.data,n="st"+y(r);!r.isGlobal()||1!=r.bitSize&&2!=r.bitSize||(n=n.replace("stglb","stglb1")),m(n);break;case h.FieldAccess:var i=e.data;x(e.args[0]),k(),x(t),m("stfld "+i.idx+", "+i.classInfo.id+"_VT"),v--;break;default:I.oops()}}(e.args[0],e.args[1]);case h.RuntimeCall:return function(e){var t=e.data;if("pxt::beginTry"!=t){t=I.U.lookup(N,t)||t,S();var r=I.U.lookup(K,t),n=e.args,i=0;if("pxt::mkClassInstance"!=t){for(var a=0;a<n.length;++a)x(n[a]),a<n.length-1&&(k(),i++);"langsupp::ignore"==t?i&&m("popmany "+i+" ; ignore"):r?m(r):function(e){var t=I.hex.lookupFunc(e);t||I.U.oops("missing function: "+e);var r=d.opcodeMap[t.name];null==r&&(r=d.opcodes.length,d.opcodes.push(t.name),d.opcodeMap[t.name]=r,t.value=r),m("callrt "+e)}(t),v-=i}else m("newobj "+n[0].data)}else m("try "+e.args[0].data)}(e);case h.ProcCall:return function(e){var t=e.data,r=t.proc;if(r&&r.inlineBody)return x(r.inlineSelf(e.args));for(var n=0,i=e.args.slice(),a=-1==t.virtualIndex?i.shift():null,s=0,o=i;s<o.length;s++){var l=o[s];x(l),k(),n++}var c=i.length;if(a)x(a),m("callind "+c);else if(null!=t.ifaceIndex){var u=t.ifaceIndex+" ; ."+p.ifaceMembers[t.ifaceIndex];t.isSet?(m("callset "+u),I.U.assert(2==c)):t.noArgs?(m("callget "+u),I.U.assert(1==c)):m("calliface "+c+", "+u)}else null!=t.virtualIndex?I.U.oops():m("callproc "+r.label());v-=n}(e);case h.SharedDef:return function(e){var t=e.args[0];if(I.U.assert(1<=t.totalUses),I.U.assert(0===t.currUses),t.currUses=1,i.push(t),1==t.totalUses)return x(t);x(t);for(var r=-1,n=0;n<g.length;++n)if(null==g[n]){r=n;break}r<0?(a&&(console.log(t,g),I.assert(!1,"missed tmp")),r=g.length,g.push(t)):g[r]=t,m("stloc "+(r+v))}(e);case h.Sequence:return e.args.forEach(x);default:return f(e)}}function k(){m("push"),v++}function S(){for(var e=0;e<g.length;++e){var t=g[e];t&&t.currUses==t.totalUses&&(a||i.push(t),g[e]=null)}}}(t,r,e)},[e.label()+"_Lit"])}),l+="_code_end:\n\n",l+="_helpers_end:\n\n",r.usedClassInfos.forEach(function(e){n(e.id+"_VT",_.VTable,function(){return function(e,t,r){for(var n=I.computeHashMultiplier(e.itable.map(function(e){return e.idx})),i=I.U.toArray(n.mapping);3&i.length;)i.push(0);var a="\n"+e.id+"_VT_start:\n        .short "+(8*e.allfields.length+8)+"  ; size in bytes\n        .byte "+pxt.ValTypeObject+", "+pxt.VTABLE_MAGIC+" ; magic\n        .short "+i.length+" ; entries in iface hashmap\n        .short "+(e.lastSubtypeNo||e.classNo)+" ; last sub class-id\n        .short "+e.classNo+" ; class-id\n        .short 0 ; reserved\n        .word "+n.mult+" ; hash-mult\n        .word 0,0, 0,0, 0,0, 0,0 ; space for 4 (VM_NUM_CPP_METHODS) native methods\n";a+="\n        .balign 4\n"+e.id+"_IfaceVT:\n";for(var s=i.length>>2,o="",l=s,c={},u=0,p=e.itable;u<p.length;u++){var f=p[u];c[f.idx+""]=l,o+="  .short "+f.idx+", "+f.info+" ; "+f.name+"\n",o+="  .word "+(f.proc?f.proc.vtLabel()+"@fn":f.info)+"\n",l+=1,f.setProc&&(o+="  .short "+f.idx+", 0 ; set "+f.name+"\n",o+="  .word "+f.setProc.vtLabel()+"@fn\n",l+=1)}o+="  .word 0, 0 ; the end\n",l+=1;for(var d=0;d<i.length;++d)r.itEntries++,i[d]&&r.itFullEntries++;return a+="  .short "+I.U.toArray(i).map(function(e,t){return c[e+""]||s}).join(", ")+"\n",a+=o,a+="\n"}(e,0,r)})});var u=0;n("ifaceMemberNames",_.IfaceMemberNames,function(){return"    .word "+r.ifaceMembers.length+", 0 ; num. entries\n"+r.ifaceMembers.map(function(e){return"    .word "+r.emitString(e)+", 0  ; "+u+++" ."+e}).join("\n")}),l+="_vtables_end:\n\n",I.U.iterMap(r.hexlits,function(e,t){n(t,_.Literal,function(){return I.hexLiteralAsm(e)},[],pxt.BuiltInType.BoxedBuffer)}),I.U.unique(r.ifaceMembers.concat(Object.keys(r.strings)),function(e){return e}).forEach(function(e){var t=I.U.toUTF8(e,!0);n(r.strings[e],_.Literal,function(){return".word "+t.length+"\n.string "+JSON.stringify(t)},[],pxt.BuiltInType.BoxedString)}),n("numberLiterals",_.NumberLiterals,function(){return t.dblText.join("\n")});var p=r.res.configData||[];n("configData",_.ConfigData,function(){return p.map(function(e){return"    .word "+e.key+", "+e.value+"  ; "+e.name+"="+e.value}).join("\n")+"\n    .word 0, 0"});for(var f=t.opcodes.map(function(e){return null==e?"":e}).join("\0")+"\0",d="";f;){var m=f.slice(0,64);f=f.slice(64),1&m.length&&(m+="\0"),d+=".hex "+I.U.toHex(I.U.stringToUint8Array(m))+"\n"}n("opcodeMap",_.OpCodeMap,function(){return d}),l+="_literals_end:\n",l+="\n; The end.\n",r.writeFile(I.BINARY_ASM,l);var h=I.assemble(e.target,r,l);if(h.src&&r.writeFile(I.BINARY_ASM,h.src),pxt.options.debug){var g=h.thumbFile.peepCounts,v=Object.keys(g);v.sort(function(e,t){return g[t]-g[e]});for(var b=0,y=v.slice(0,50);b<y.length;b++){var x=y[b];console.log(x+"  "+g[x])}}if(h.buf){for(var k="",S=0,T=h.buf;S<T.length;S++){var w=T[S];k+=String.fromCharCode(255&w,w>>8)}var E=U.pxtc.encodeBase64(k);r.writeFile(pxt.outputName(I.target),E)}}}(U.pxtc||(U.pxtc={}))}(ts||(ts={})),function(qe){var je;(function(oe){var le,e;(e=le=oe.DecompileParamKeys||(oe.DecompileParamKeys={})).DecompileLiterals="decompileLiterals",e.TaggedTemplate="taggedTemplate",e.DecompileIndirectFixedInstances="decompileIndirectFixedInstances",e.DecompileArgumentAsString="decompileArgumentAsString",oe.FILE_TOO_LARGE_CODE=9266,oe.DECOMPILER_ERROR=9267;var ce,t,ue=qe.SyntaxKind,pe=1500,o=97,l=122,fe=160,de=120,me=480,he=360,c=/^[^\f\n\r\t\v\u00a0\u1680\u180e\u2000-\u200a\u2028\u2029\u202f\u205f\u3000\ufeff]*$/,u=/^(?:Array<(.+)>)|(?:(.+)\[\])$/,ge="math_number",ve="math_number_minmax",be="math_integer",ye="math_whole_number",xe="text",ke="logic_boolean",Se={"+":{type:"math_arithmetic",op:"ADD"},"-":{type:"math_arithmetic",op:"MINUS"},"/":{type:"math_arithmetic",op:"DIVIDE"},"*":{type:"math_arithmetic",op:"MULTIPLY"},"**":{type:"math_arithmetic",op:"POWER"},"%":{type:"math_modulo",leftName:"DIVIDEND",rightName:"DIVISOR"},"<":{type:"logic_compare",op:"LT"},"<=":{type:"logic_compare",op:"LTE"},">":{type:"logic_compare",op:"GT"},">=":{type:"logic_compare",op:"GTE"},"==":{type:"logic_compare",op:"EQ"},"===":{type:"logic_compare",op:"EQ"},"!=":{type:"logic_compare",op:"NEQ"},"!==":{type:"logic_compare",op:"NEQ"},"&&":{type:"logic_operation",op:"AND"},"||":{type:"logic_operation",op:"OR"}},Te=/^\s*\/\/\s*(.*)$/,we=/^\s*(?:(?:(?:\/\*\*?)|(?:\*))(?!\/))?\s*(.*?)(?:\*?\*\/)?$/,r=function(){function e(e){this.renames=e,this.renames.sort(function(e,t){return e.span.start-t.span.start})}return e.prototype.getRenamesInSpan=function(e,t){for(var r=[],n=0,i=this.renames;n<i.length;n++){var a=i[n];if(a.span.start>t)break;a.span.start>=e&&r.push(a)}return r},e.prototype.getRenameForPosition=function(e){for(var t=0,r=this.renames;t<r.length;t++){var n=r[t];if(n.span.start>e)return;if(n.span.start===e)return n}},e}();function p(e,t){if(1===e.length){var r=e.charCodeAt(0);if(o<=r&&r<=l)for(var n=r-o,i=1;i<26;i++){var a=String.fromCharCode(o+(n+i)%26);if(!t[a])return t[a]=!0,a}}for(i=2;;i++){var s=e+i;if(!t[s])return t[s]=!0,s}}function Ee(e,c,t,r){switch(void 0===t&&(t=!1),void 0===r&&(r=!1),e.kind){case ue.WhileStatement:case ue.IfStatement:case ue.Block:return;case ue.ExpressionStatement:return Ee(e.expression,c,t,r);case ue.VariableStatement:return function(e,t){for(var r=0,n=e.declarationList.declarations;r<n.length;r++){var i=n[r],a=s(i,t);if(a)return a}}(e,c);case ue.CallExpression:return function(e,S,t,r){void 0===t&&(t=!1),void 0===r&&(r=!1);var s=je.pxtInfo(e).callInfo;if(!s)return je.Util.lf("Function call not supported in the blocks");var T=S.attrs(s);if(t){if("Math.pow"==s.qName)return;if(pxt.Util.startsWith(s.qName,"Math.")){var n=s.qName.substring(5);if(Me(n))return}}else if(s.isExpression)return je.Util.lf("No output expressions as statements");if(T.blockId===je.PAUSE_UNTIL_TYPE){var i=e.arguments[0];if(1===e.arguments.length&&function(e){if(e.kind!==ue.FunctionExpression&&e.kind!==ue.ArrowFunction)return!1;var t=e;if(function(e){switch(e.kind){case ue.BinaryExpression:var t=e.operatorToken.kind;return t!=ue.PlusEqualsToken&&t!=ue.MinusEqualsToken&&t!=ue.EqualsToken;case ue.PrefixUnaryExpression:case ue.PostfixUnaryExpression:var r=e.operator;return r!=ue.PlusPlusToken&&r!=ue.MinusMinusToken;case ue.CallExpression:var n=je.pxtInfo(e).callInfo;return je.assert(!!n),n.isExpression;case ue.ParenthesizedExpression:case ue.NumericLiteral:case ue.StringLiteral:case ue.NoSubstitutionTemplateLiteral:case ue.TrueKeyword:case ue.FalseKeyword:case ue.NullKeyword:case ue.TaggedTemplateExpression:return!0;default:return!1}}(t.body))return!0;var r=t.body;if(1===r.statements.length){var n=Pe(r.statements[0]);if(n.kind===ue.ReturnStatement)return!0}return!1}(i))return;return je.Util.lf("Predicates must be inline expressions that return a value")}var a=Le(s,T);if(a&&!T.handlerStatement&&!r)return je.Util.lf("Events must be top level");if(!T.blockId||!T.block){var o=pxt.blocks.builtinFunctionInfo[s.qName];if(!o){if(e.expression.kind===ue.Identifier){var l=e.expression.text;return S.declaredFunctions[l]?S.declaredFunctions[l].parameters.length!==s.args.length?je.Util.lf("Function calls in blocks must have the same number of arguments as the function definition"):void 0:je.Util.lf("Call statements must have a valid declared function")}return je.Util.lf("Function call not supported in the blocks")}T.blockId=o.blockId}var c=De(s,S.blocks),u=S.blocks.apis.byQName[s.qName],p=pxt.blocks.compileInfo(u),f=p.parameters.length+(p.thisParameter?1:0);if(T.imageLiteral){if(1<s.args.length-f)return je.Util.lf("Function call has more arguments than are supported by its block");var d=e.arguments[0];if(d.kind!=ue.StringLiteral&&d.kind!=ue.NoSubstitutionTemplateLiteral)return je.Util.lf("Only string literals supported for image literals");var m=(d.text||"").replace(/\s+/g,""),h=T.imageLiteralRows||5,g=(T.imageLiteralColumns||5)*T.imageLiteral,v=g*h;return g*h!=m.length?je.Util.lf("Invalid image pattern ({0} expected vs {1} actual)",v,m.length):void 0}var b=s.args.length-f;if(0<b&&!function(){if(T.mutatePropertyEnum&&2===b&&2<=s.args.length){var e=s.args[s.args.length-2],t=s.args[s.args.length-1];if(e.kind===ue.ArrayLiteralExpression&&I(t)){var r=[],n=!e.elements.some(function(e){return e.kind!==ue.PropertyAccessExpression||e.expression.kind!==ue.Identifier||(r.push(e.name.text),e.expression.text!==T.mutatePropertyEnum)});if(n){var i=Ce(t);if(i){var a=i[0];return a.length===r.length&&!r.some(function(e){return-1===a.indexOf(e)})}}}}return!1}()){var y=b;if(a&&y--,T.defaultInstance&&y--,0<y)return je.Util.lf("Function call has more arguments than are supported by its block")}if(p.parameters.length||a){var x,k=T.defaultInstance||!!p.thisParameter;if(c.forEach(function(e,t){x||k&&0===t||(k&&t--,x=function(e){var t=Pe(e.value),i=e.info,r=e.param;if(i.isEnum){if(k(t))return;if(t.kind===ue.CallExpression){var n=je.pxtInfo(t).callInfo,a=S.attrs(n);if(n&&"TD_ID"===a.shim&&n.args&&1===n.args.length){var s=Pe(n.args[0]);if(k(s))return}}return je.Util.lf("Enum arguments may only be literal property access expressions")}if(Fe(t)&&(r.fieldEditor||r.shadowBlockId)){var o=!(!r.fieldOptions||!r.fieldOptions[le.DecompileLiterals]);if(!o&&r.shadowBlockId){var l=S.blocks.blocksById[r.shadowBlockId];if(l&&l.parameters&&l.parameters.length){var c=l.parameters[0].name;o=!l.attributes.paramFieldEditorOptions||!l.attributes.paramFieldEditorOptions[c]||!!l.attributes.paramFieldEditorOptions[c][le.DecompileLiterals]}else o=!0}if(!o)return je.Util.lf("Field editor does not support literal arguments")}else if(t.kind===ue.TaggedTemplateExpression&&r.fieldEditor){var u=r.fieldOptions&&r.fieldOptions[le.TaggedTemplate];if(!u)return je.Util.lf("Tagged templates only supported in custom fields with param.fieldOptions.taggedTemplate set");var p=Pe(t.tag);if(p.kind!==ue.Identifier)return je.Util.lf("Tagged template literals must use an identifier as the tag");var f=p.getText();if(f.trim()!=u.trim())return je.Util.lf("Function only supports template literals with tag '{0}'",u);var d=t.template;if(d.kind!==ue.NoSubstitutionTemplateLiteral)return je.Util.lf("Tagged template literals cannot have substitutions")}else if(t.kind===ue.ArrowFunction){var m=t;if(m.parameters.length)if("objectdestructuring"===T.mutate){var h=Pe(m.parameters[0]);if(h.kind===ue.Parameter&&h.name.kind!==ue.ObjectBindingPattern)return je.Util.lf("Object destructuring mutation callbacks can only have destructuring patters as arguments")}else for(var g=0,v=m.parameters;g<v.length;g++){var b=v[g];if(b.name.kind!==ue.Identifier)return je.Util.lf("Only identifiers allowed as function arguments")}}else if(S.blocks.apis.byQName[i.type]){var y=S.blocks.apis.byQName[i.type];if(y.attributes.fixedInstances){if(_(r))return;if(r.shadowBlockId){var x=S.blocks.blocksById[r.shadowBlockId];if(x){var l=pxt.blocks.compileInfo(x);if(l.parameters&&_(l.parameters[0]))return}}var n=je.pxtInfo(t).callInfo;if(n&&S.attrs(n).fixedInstance)return;return je.Util.lf("Arguments of a fixed instance type must be a reference to a fixed instance declaration")}}return;function k(e){for(var t=i.type.split("."),r=[];e.kind===ue.PropertyAccessExpression;)r.unshift(e.name.text),e=e.expression;if(e.kind!==ue.Identifier)return!1;r.unshift(e.text);for(var n=0;n<t.length;n++)if(t[n]!==r[n])return!1;return!0}}(e))}),x)return x}if(u){var w=S.blocks.apis.byQName[u.namespace];if(w&&w.attributes.fixedInstances&&!w.attributes.decompileIndirectFixedInstances&&s.args.length){var E=je.pxtInfo(s.args[0]).callInfo;if(!E||!S.attrs(E).fixedInstance)return je.Util.lf("Fixed instance APIs can only be called directly from the fixed instance")}}}(e,c,t,r);case ue.VariableDeclaration:return s(e,c);case ue.PostfixUnaryExpression:case ue.PrefixUnaryExpression:return(n=e).operand.kind!=ue.Identifier?je.Util.lf("-- and ++ may only be used on an identifier"):n.operator!==ue.PlusPlusToken&&n.operator!==ue.MinusMinusToken?je.Util.lf("Only ++ and -- supported as prefix or postfix unary operators in a statement"):void 0;case ue.FunctionExpression:case ue.ArrowFunction:return function(e,t){var r=!1;if(e.parameters.length){var n=Ae(e)[0];if(n&&je.pxtInfo(n).callInfo){var i=je.pxtInfo(n).callInfo;r="objectdestructuring"===t.attrs(i).mutate?e.parameters[0].name.kind!==ue.ObjectBindingPattern:e.parameters.some(function(e){return e.name.kind!==ue.Identifier})}}if(r)return je.Util.lf("Unsupported parameters in error function")}(e,c);case ue.BinaryExpression:return function(e,t){if(e.left.kind===ue.ElementAccessExpression){if(e.operatorToken.kind!==ue.EqualsToken)return je.Util.lf("Element access expressions may only be assigned to using the equals operator")}else{if(e.left.kind===ue.PropertyAccessExpression)return e.operatorToken.kind!==ue.EqualsToken&&e.operatorToken.kind!==ue.PlusEqualsToken?je.Util.lf("Property access expressions may only be assigned to using the = and += operators"):Ue(e.left,t);if(e.left.kind!==ue.Identifier)return je.Util.lf("This expression cannot be assigned to");switch(e.operatorToken.kind){case ue.EqualsToken:return Ue(e.right,t);case ue.PlusEqualsToken:case ue.MinusEqualsToken:return;default:return je.Util.lf("Unsupported operator token in statement {0}",ue[e.operatorToken.kind])}}}(e,c);case ue.ForStatement:return function(r){if(!r.initializer||!r.incrementor||!r.condition)return je.Util.lf("for loops must have an initializer, incrementor, and condition");if(r.initializer.kind!==ue.VariableDeclarationList)return je.Util.lf("only variable declarations are permitted in for loop initializers");var e=r.initializer;if(!e.declarations)return je.Util.lf("for loop with out-of-scope variables not supported");if(1!=e.declarations.length)return je.Util.lf("for loop with multiple variables not supported");var t=e.declarations[0];if(t.initializer.kind!==ue.NumericLiteral||"0"!==t.initializer.text)return je.Util.lf("for loop initializers must be initialized to 0");var n=t.name.text;if(!function(e){if(r.incrementor.kind===ue.PostfixUnaryExpression||r.incrementor.kind===ue.PrefixUnaryExpression){var t=r.incrementor;if(t.operator===ue.PlusPlusToken&&t.operand.kind===ue.Identifier)return t.operand.text===e}return!1}(n))return je.Util.lf("for loop incrementors may only increment the variable declared in the initializer");if(r.condition.kind!==ue.BinaryExpression)return je.Util.lf("for loop conditionals must be binary comparison operations");var i=r.condition;return i.left.kind!==ue.Identifier||i.left.text!==n?je.Util.lf("left side of for loop conditional must be the variable declared in the initializer"):i.operatorToken.kind!==ue.LessThanToken&&i.operatorToken.kind!==ue.LessThanEqualsToken?je.Util.lf("for loop conditional operator must be either < or <="):void 0}(e);case ue.ForOfStatement:return function(e){if(e.initializer.kind!==ue.VariableDeclarationList)return je.Util.lf("only variable declarations are permitted in for of loop initializers")}(e);case ue.FunctionDeclaration:return function(e,t){if(!t)return je.Util.lf("Function declarations must be top level");if(0<e.parameters.length&&c.opts.allowedArgumentTypes)for(var r=0,n=e.parameters;r<n.length;r++){var i=n[r];if(i.initializer||i.questionToken)return je.Util.lf("Function parameters cannot be optional");var a=i.type?i.type.getText():void 0;if(!a)return je.Util.lf("Function parameters must declare a type");if(-1===c.opts.allowedArgumentTypes.indexOf((s=a,void 0,(o=u.exec(s))?(o[1]||o[2])+"[]":s)))return je.Util.lf("Only types that can be added in blocks can be used for function arguments")}var s,o,l=!1;return qe.forEachReturnStatement(e.body,function(e){e.expression&&(l=!0)}),l?je.Util.lf("Function with return value not supported in blocks"):void 0}(e,r);case ue.EnumDeclaration:return function(e,t){if(!t)return je.Util.lf("Enum declarations must be top level");var r=e.name.text;if(!c.blocks.enumsByName[r])return je.Util.lf("Enum declarations in user code must have a block");var n=!1;return e.members.forEach(function(e){if(e.name.kind!==ue.Identifier&&(n=!0),!n&&e.initializer){if(e.initializer.kind===ue.NumericLiteral)return;if(e.initializer.kind===ue.BinaryExpression){var t=e.initializer;if(t.operatorToken.kind===ue.LessThanLessThanToken&&t.left.kind===ue.NumericLiteral&&t.right.kind===ue.NumericLiteral&&"1"==t.left.text)return}n=!0}}),n?je.Util.lf("Invalid initializer for enum member"):void 0}(e,r);case ue.ModuleDeclaration:return(a=Ie(i=e,c))&&_e(i)?a:void 0;case ue.BreakStatement:case ue.ContinueStatement:case ue.DebuggerStatement:case ue.EmptyStatement:return}var n,i,a;return je.Util.lf("Unsupported statement in block: {0}",ue[e.kind]);function s(e,t){return e.name.kind!==ue.Identifier?je.Util.lf("Variable declarations may not use binding patterns"):e.initializer?Ke(e,t)?void 0:e.type&&function(e){switch(e.kind){case ue.TupleType:case ue.UnionType:case ue.IntersectionType:case ue.ParenthesizedType:return!0;default:return!1}}(e.type)?je.Util.lf("Variable type is not supported by Blockly"):Ue(e.initializer,t):je.Util.lf("Variable declarations must have an initializer")}}function Ie(e,t){if(!qe.isModuleBlock(e.body))return je.Util.lf("Namespaces cannot be nested.");var r=t.blocks.kindsByName[e.name.text];if(!r)return je.Util.lf("Only namespaces with 'kind' blocks can be decompiled");for(var n=je.Util.lf("Namespaces may only contain valid 'kind' exports"),i=0,a=e.body.statements;i<a.length;i++){var s=a[i];if(d(s))return n;if(!qe.isVariableStatement(s)||!s.declarationList.declarations)return n;var o=1===s.declarationList.declarations.length,l=s.modifiers&&1===s.modifiers.length&&s.modifiers[0].kind===ue.ExportKeyword,c=s.declarationList.flags&qe.NodeFlags.Const;if(!(o&&l&&c))return n;var u=s.declarationList.declarations[0];if(!u.initializer||!qe.isCallExpression(u.initializer)||!qe.isIdentifier(u.name))return n;var p=u.initializer;if(p.arguments.length)return n;if(qe.isPropertyAccessExpression(p.expression)&&qe.isIdentifier(p.expression.expression)){if(p.expression.expression.text!==r.name||p.expression.name.text!==r.createFunctionName)return n}else{if(!qe.isIdentifier(p.expression))return n;if(p.expression.text!==r.createFunctionName)return n}}}function _e(e){if(!qe.isModuleBlock(e.body))return je.Util.lf("Namespaces cannot be nested.");if(e.name.text!==pxt.sprite.TILE_NAMESPACE)return je.Util.lf("Tileset namespace must be named myTiles");for(var t=je.Util.lf("The myTiles namespace can only export tile variables with image literal initializers and no duplicate ids"),r=new RegExp(pxt.sprite.TILE_PREFIX+"(\\d+)"),n=[],i=0,a=e.body.statements;i<a.length;i++){var s=a[i];if(d(s))return t;if(!qe.isVariableStatement(s)||!s.declarationList.declarations)return t;var o=1===s.declarationList.declarations.length,l=s.modifiers&&1===s.modifiers.length&&s.modifiers[0].kind===ue.ExportKeyword,c=s.declarationList.flags&qe.NodeFlags.Const;if(!(o&&l&&c))return t;var u=s.declarationList.declarations[0];if(!u.initializer||!qe.isTaggedTemplateExpression(u.initializer)||!qe.isIdentifier(u.name))return t;var p=u.initializer;if(!qe.isIdentifier(p.tag)||"img"!==p.tag.text)return t;var f=r.exec(u.name.text);if(!f||-1!==n.indexOf(f[1]))return t;n.push(f[1])}}function Ke(e,t){if(e.initializer){if(Ne(e)&&t.opts.generatedVarDeclarations){var r=t.opts.generatedVarDeclarations[e.name.getText()];if(r&&r.type===(void 0===e.type?void 0:e.type.getText())&&r.value===e.initializer.getText())return!0}var n=je.pxtInfo(e.initializer).callInfo;if(n&&n.isAutoCreate)return!0}return!1}function Ne(e){var t=Ae(e)[0];return!t||t.kind==ue.SourceFile||(t.kind==ue.ExpressionStatement?Ne(t):t.kind==ue.VariableDeclarationList&&Ne(t.parent))}function Ce(e){if(1===e.parameters.length&&e.parameters[0].name.kind===ue.ObjectBindingPattern){var t=e.parameters[0].name.elements,n={};return[t.map(function(e){if(i(e.propertyName)&&i(e.name)){var t=e.name.text;if(e.propertyName){var r=e.propertyName.text;return n[r]=t,r}return t}return""}),n]}return;function i(e){return!e||e.kind===ue.Identifier}}function Ue(e,t){switch(e.kind){case ue.NumericLiteral:case ue.TrueKeyword:case ue.FalseKeyword:case ue.ExpressionStatement:case ue.ArrayLiteralExpression:case ue.ElementAccessExpression:return;case ue.ParenthesizedExpression:return Ue(e.expression,t);case ue.StringLiteral:case ue.FirstTemplateToken:case ue.NoSubstitutionTemplateLiteral:return s=e.text,c.test(s)?void 0:je.Util.lf("Only whitespace character allowed in string literals is space");case ue.Identifier:return(a=e)&&a.kind===ue.Identifier&&"undefined"===a.text?je.Util.lf("Undefined is not supported in blocks"):(i=e,4&je.pxtInfo(i).flags?je.Util.lf("Variable is declared in another file"):void 0);case ue.BinaryExpression:var r=e.operatorToken.getText();return Se[r]?void 0:je.Util.lf("Could not find operator {0}",r);case ue.PrefixUnaryExpression:var n=e.operator;return n===ue.MinusToken||n===ue.PlusToken||n===ue.ExclamationToken?void 0:je.Util.lf("Unsupported prefix unary operator{0}",n);case ue.PropertyAccessExpression:return function(e,t){var r=je.pxtInfo(e).callInfo;if(r){var n=t.attrs(r),i=t.compInfo(r);if(n.blockIdentity||"lists_length"===n.blockId||"text_length"===n.blockId)return;if(r.decl.kind===ue.EnumMember){if(e.expression.kind===ue.Identifier){var a=e.expression.text;if(t.declaredEnums[a])return}var s=Ae(e),o=s[0],l=s[1],c=!0;if(o){var u=je.pxtInfo(o).callInfo;if(u&&u.args){var p=t.blocks.apis.byQName[u.qName],f=1==p.kind||2==p.kind;p&&u.args.forEach(function(e,t){if(e===l){var r=p.parameters[f?t-1:t];r.isEnum&&(c=!1)}})}}return c?je.Util.lf("Enum value without a corresponding block"):void 0}if(n.fixedInstance&&e.parent){if(e.parent.parent&&e.parent.kind===ue.PropertyAccessExpression&&e.parent.parent.kind===ue.CallExpression){var d=e.parent.parent;if(d.expression===e.parent)return}else if(e.parent.kind===ue.CallExpression&&e.parent.expression!==e)return}else{if(n.blockCombine||n.blockId&&i&&i.thisParameter)return Ue(e.expression,t);if(qe.isIdentifier(e.expression)&&t.declaredKinds[e.expression.text]){var m=e.name.text,h=t.declaredKinds[e.expression.text];if(h&&(-1!==h.kindInfo.initialMembers.indexOf(m)||-1!==h.declaredNames.indexOf(m)))return}}}return je.Util.lf("No call info found")}(e,t);case ue.CallExpression:return Ee(e,t,!0,void 0);case ue.TaggedTemplateExpression:return function(e,t){var r=je.pxtInfo(e).callInfo;if(!r)return je.Util.lf("Invalid tagged template");var n=t.attrs(r);if(!n.blockIdentity)return je.Util.lf("Tagged template does not have blockIdentity set");var i=t.blocks.apis.byQName[n.blockIdentity];return i?1!==pxt.blocks.compileInfo(i).parameters.length?je.Util.lf("Tagged template functions must have 1 argument"):void 0:je.Util.lf("Could not find blockIdentity for tagged template")}(e,t)}var i,a,s;return je.Util.lf("Unsupported syntax kind for output expression block: {0}",ue[e.kind])}function Ae(e){return e.parent?e.parent.kind===ue.ParenthesizedExpression?Ae(e.parent):[e.parent,e]:[void 0,e]}function Pe(e){for(;e.kind===ue.ParenthesizedExpression;)e=e.expression;return e}function Le(e,t){return t.blockId!==je.PAUSE_UNTIL_TYPE&&(e.decl.parameters,e.args.some(function(e,t){return e&&I(e)}))}function Fe(e){if(!e)return!1;switch(e.kind){case ue.ParenthesizedExpression:return Fe(e.expression);case ue.ArrayLiteralExpression:for(var t=0,r=e.elements;t<r.length;t++){var n=r[t];if(!Fe(n)&&n.kind!==ue.TaggedTemplateExpression)return!1}return!0;case ue.NumericLiteral:case ue.StringLiteral:case ue.NoSubstitutionTemplateLiteral:case ue.TrueKeyword:case ue.FalseKeyword:return!0;case ue.PrefixUnaryExpression:var i=e;return(i.operator===ue.PlusToken||i.operator===ue.MinusToken)&&Fe(i.operand);default:return!1}}function I(e){return e.kind===ue.ArrowFunction||e.kind===ue.FunctionExpression}function De(e,t){var r=[],n=t.apis.byQName[e.qName];if(n){var i=t.apis.byQName[e.qName].attributes,a=pxt.blocks.compileInfo(n),s=(pxt.blocks.builtinFunctionInfo[e.qName],i.imageLiteral?1:0);a.thisParameter?r.push({value:Pe(e.args[0]),info:null,param:a.thisParameter}):i.defaultInstance&&r.push({value:Pe(e.args[0]),info:n.parameters[0],param:{definitionName:"__instance__",actualName:"this"}});var o=!(!a.thisParameter&&!i.defaultInstance);o&&s++;for(var l=s;l<e.args.length;l++)r.push({value:Pe(e.args[l]),info:n.parameters[o?l-1:l],param:a.parameters[l-s]})}return r}function Oe(e){return e.body.statements.map(function(e){var t=e.declarationList.declarations[0];return{name:t.name.text,initializer:t.initializer.getText()}})}function _(e){return e&&e.fieldOptions&&e.fieldOptions[le.DecompileIndirectFixedInstances]}function Me(e){return Be(e)||Re(e)||$e(e)||-1!==pxt.blocks.MATH_FUNCTIONS.binary.indexOf(e)}function Be(e){return-1!==pxt.blocks.MATH_FUNCTIONS.unary.indexOf(e)}function Re(e){return-1!==pxt.blocks.MATH_FUNCTIONS.infix.indexOf(e)}function $e(e){return-1!==pxt.blocks.ROUNDING_FUNCTIONS.indexOf(e)}function d(e){var t=qe.getLeadingCommentRangesOfNode(e,e.getSourceFile());return!(!t||!t.length)}oe.RenameMap=r,oe.buildRenameMap=function(e,a,s){void 0===s&&(s={});var o=qe.createLanguageService(new je.LSHost(e)),l=[],t=(function i(e){qe.forEachChild(e,function(e){if(e.kind===ue.VariableDeclaration&&e.name.kind===ue.Identifier){var t=e.name.getText();if(s[t]){var r=p(t,s),n=o.findRenameLocations(a.fileName,e.name.pos+1,!1,!1);n&&n.forEach(function(e){l.push({name:r,diff:r.length-t.length,span:e.textSpan})})}else s[t]=!0}i(e)})}(a),s);return[new r(l),t]},oe.getNewName=p,(t=ce||(ce={}))[t.None=0]="None",t[t.InBlocksOnly=1]="InBlocksOnly",t[t.InTextBlocks=2]="InTextBlocks",oe.decompileToBlocks=function(B,S,u,r){var e,t=0,n=S.statements,i={blocksInfo:B,outfiles:{},diagnostics:[],success:!0,times:{}},R={blocks:B,declaredFunctions:{},declaredEnums:{},declaredKinds:{},functionParamIds:{},attrs:$,compInfo:function(e){var t=B.apis.byQName[e.qName];if(t)return pxt.blocks.compileInfo(t)},localReporters:[],tileset:[],opts:u||{}},T=S.getFullText(),a="",o=[],f={},w=[],E=[],I=(e=0,function(){return""+e++}),l=function(e){if(e.kind!==ue.FunctionDeclaration||Ee(e,R,!1,!0))if(e.kind!==ue.EnumDeclaration||Ee(e,R,!1,!0))if(qe.isModuleDeclaration(e))if(Ie(e,R))_e(e)||(R.tileset=Oe(e).map(function(e){var t=e.name,r=e.initializer;return{projectId:parseInt(t.substr(pxt.sprite.TILE_PREFIX.length)),data:pxt.sprite.imageLiteralToBitmap(r).data()}}));else{var t=e.name.text,r=Oe(e);R.declaredKinds[t]&&(s=R.declaredKinds[t].declaredNames).push.apply(s,r.map(function(e){return e.name}))}else e.kind===ue.Block&&qe.forEachChild(e,l);else{var n=e.name.text;R.declaredEnums[n]=!0,(i=e,a=[],i.members.forEach(function(e){je.U.assert(e.name.kind===ue.Identifier);var t,r=e.name.text;if(e.initializer)if(e.initializer.kind===ue.NumericLiteral)t=parseInt(e.initializer.text);else{var n=e.initializer;je.U.assert(n.left.kind===ue.NumericLiteral),je.U.assert("1"===n.left.text),je.U.assert(n.operatorToken.kind===ue.LessThanLessThanToken),je.U.assert(n.right.kind===ue.NumericLiteral),t=1<<parseInt(n.right.text)}else t=0===a.length?0:a[a.length-1][1]+1;a.push([r,t])}),a).forEach(function(e){var t=e[0],r=e[1];o.push({name:r+t,type:n})})}else R.declaredFunctions[se(e.name)]=e;var i,a,s};Object.keys(B.kindsByName).forEach(function(e){var t=B.kindsByName[e];R.declaredKinds[e]={kindInfo:t,declaredNames:[]}}),qe.forEachChild(S,l);var s,c=function(){return(Math.PI*Math.random()).toString(36).slice(2)};Object.keys(R.declaredFunctions).forEach(function(t){R.functionParamIds[t]={},R.declaredFunctions[t].parameters.forEach(function(e){R.functionParamIds[t][e.name.getText()]=c()+c()})}),Object.keys(R.declaredKinds).forEach(function(e){var t="KIND_"+e;R.declaredKinds[e].declaredNames.forEach(function(e){return o.push({name:e,type:t})})}),(o.length||R.tileset.length)&&(p("<variables>"),o.forEach(function(e){p('<variable type="'+je.U.htmlEscape(e.type)+'">'+je.U.htmlEscape(e.name)+"</variable>")}),R.tileset.forEach(function(e){p('<variable type="'+pxt.sprite.BLOCKLY_TILESET_TYPE+'">'+pxt.sprite.tileToBlocklyVariable(e)+"</variable>")}),p("</variables>"));try{s=re(n,void 0,!0,void 0,!u.snippetMode)}catch(e){if(!e.programTooLarge)return pxt.reportException(e),i.success=!1,i.diagnostics=je.patchUpDiagnostics([{file:S,start:S.getFullStart(),length:S.getFullWidth(),messageText:e.message,category:qe.DiagnosticCategory.Error,code:oe.DECOMPILER_ERROR}]),i;i.success=!1,i.diagnostics=je.patchUpDiagnostics([{file:S,start:S.getFullStart(),length:S.getFullWidth(),messageText:e.message,category:qe.DiagnosticCategory.Error,code:oe.FILE_TOO_LARGE_CODE}])}return s?h(s):u.snippetMode||n.length||p('<block type="'+qe.pxtc.ON_START_TYPE+'"></block>'),w.forEach(function(e){!function(e){var t=0,r=e.text.split("\n");r.forEach(function(e){return t=Math.max(t,e.length)});var n=Math.max(Math.min(10*t,me),fe);p('<comment h="'+Math.max(Math.min(40*r.length,he),de)+'" w="'+n+'" data="'+je.U.htmlEscape(e.refId)+'">'),p(je.U.htmlEscape(e.text)),p("</comment>")}(e)}),i.outfiles[S.fileName.replace(/(\.blocks)?\.\w*$/i,"")+".blocks"]='<xml xmlns="http://www.w3.org/1999/xhtml">\n'+a+"</xml>",i;function p(e,t){void 0===t&&(t="\n"),a+=e+t}function _(e,t){var r=t||'Language feature "'+e.getFullText().trim()+'"" not supported in blocks',n=je.patchUpDiagnostics([{file:S,start:e.getFullStart(),length:e.getFullWidth(),messageText:r,category:qe.DiagnosticCategory.Error,code:1001}]);pxt.debug("decompilation error: "+r),je.U.pushRange(i.diagnostics,n),i.success=!1}function $(e){var t=B.apis.byQName[e.qName];if(t){var r=t.attributes;if(!r.blockId||B.blocksById[r.blockId]||r.blockId===je.PAUSE_UNTIL_TYPE)return t.attributes}return{paramDefl:{},callingConvention:0}}function d(){if(pe<++t){var e=new Error(je.Util.lf("Could not decompile because the script is too large"));throw e.programTooLarge=!0,e}}function K(e){return{kind:"statement",type:e}}function N(e){return{kind:"expr",type:e}}function q(e,t,r,n){return(!r||r===ge)&&n&&n.min&&n.max&&(r=ve),{kind:"value",name:e,value:t,shadowType:r,shadowMutation:n}}function m(e){if(e.expression.kind==ue.CallExpression){var t=e.expression,r=je.pxtInfo(t).callInfo;if(!r)return _(e),!1;var n=$(r);return n.blockId&&!n.handlerStatement&&!r.isExpression&&Le(r,n)}return!1}function h(e){var t;e&&(t=e.type,d(),p('<block type="'+je.U.htmlEscape(t)+'">'),v(e),void 0!==e.data&&p("<data>"+je.U.htmlEscape(e.data)+"</data>"),e.handlers&&e.handlers.forEach(x),e.next&&(p("<next>"),h(e.next),p("</next>")),void 0!==e.comment&&p('<comment pinned="false">'+je.U.htmlEscape(e.comment)+"</comment>"),p("</block>"))}function g(t,e){p("<mutation ",""),Object.keys(t).forEach(function(e){void 0!==t[e]&&p(e+'="'+t[e]+'" ',"")}),e?(p(">"),e.forEach(function(t){p("<"+t.nodeName+" ",""),Object.keys(t.attributes).forEach(function(e){p(e+'="'+t.attributes[e]+'" ',"")}),p("/>")}),p("</mutation>")):p("/>")}function v(e){e.mutation&&g(e.mutation,e.mutationChildren),e.fields&&e.fields.forEach(y),e.inputs&&e.inputs.forEach(b)}function b(e){p('<value name="'+e.name+'">');var t=!1;if("expr"===e.value.kind){var r=e.value;if(r.type===ge&&e.shadowType===ve&&(r.type=ve,r.fields[0].name="SLIDER",r.mutation=e.shadowMutation),!(t=r.type===e.shadowType))switch(r.type){case"math_number":case"math_number_minmax":case"math_integer":case"math_whole_number":case"logic_boolean":case"text":t=!e.shadowType}}if(t)k(e.value,!0);else{if(void 0!==e.shadowType)switch(e.shadowType){case ge:case be:case ye:p('<shadow type="'+e.shadowType+'"><field name="NUM">0</field></shadow>');break;case ve:p('<shadow type="'+ve+'">'),e.shadowMutation&&g(e.shadowMutation),p('<field name="SLIDER">0</field></shadow>');break;case ke:p('<shadow type="'+ke+'"><field name="BOOL">TRUE</field></shadow>');break;case xe:p('<shadow type="'+xe+'"><field name="TEXT"></field></shadow>');break;default:p('<shadow type="'+e.shadowType+'"/>')}k(e.value)}p("</value>")}function y(e){p('<field name="'+je.U.htmlEscape(e.name)+'">'+je.U.htmlEscape(e.value.toString())+"</field>")}function x(e){p('<statement name="'+je.U.htmlEscape(e.name)+'">'),h(e.statement),p("</statement>")}function k(e,t){if(void 0===t&&(t=!1),"text"===e.kind)p((r=e).value);else{var r=e,n=t||r.isShadow,i=n?"shadow":"block";n||d(),p("<"+i+' type="'+je.U.htmlEscape(r.type)+'">'),v(r),p("</"+i+">")}}function j(e){if(Ue(e,R))return U(e);switch(e.kind){case ue.ExpressionStatement:case ue.ParenthesizedExpression:return j(e.expression);case ue.Identifier:return s=se(a=e),o=a.text,l=null,R.localReporters.some(function(e){for(var t=0;t<e.length;++t)if(e[t].name===o)return l=e[t],!0;return!1}),l?H(s,l.type,!1):(ie(s,ce.InBlocksOnly),G("variables_get","VAR",s));case ue.StringLiteral:case ue.FirstTemplateToken:case ue.NoSubstitutionTemplateLiteral:return L(e.text);case ue.NumericLiteral:return V(e.text);case ue.TrueKeyword:return F(!0);case ue.FalseKeyword:return F(!1);case ue.BinaryExpression:return function(e){var t=e.operatorToken.getText(),r=Se[t];if(A(e))return P(e);var n,i,a=r.leftName||"A",s=r.rightName||"B";"&&"===t||"||"===t?(n=O(a,e.left),i=O(s,e.right)):(n=z(a,e.left,ge),i=z(s,e.right,ge));var o=N(r.type);return o.fields=[],r.op&&o.fields.push(W("OP",r.op)),o.inputs=[n,i],o}(e);case ue.PrefixUnaryExpression:return function(e){switch(e.operator){case ue.ExclamationToken:var t=N("logic_negate");return t.inputs=[O("BOOL",e.operand)],t;case ue.PlusToken:return j(e.operand);case ue.MinusToken:return e.operand.kind==ue.NumericLiteral?V("-"+e.operand.text):D(e.operand);default:_(e)}}(e);case ue.PropertyAccessExpression:return Q(e);case ue.ArrayLiteralExpression:return n=e,(i=N("lists_create_with")).inputs=n.elements.map(function(e,t){return z("ADD"+t,e)}),i.mutation={items:n.elements.length.toString()},i;case ue.ElementAccessExpression:return t=e,(r=N("lists_index_get")).inputs=[z("LIST",t.expression),z("INDEX",t.argumentExpression,ge)],r;case ue.TaggedTemplateExpression:return function(e){var t,r=je.pxtInfo(e).callInfo,n=function(e){if(e.parent&&e.parent.kind===ue.CallExpression){var t=e.parent,r=je.pxtInfo(t).callInfo,n=t.arguments.indexOf(e);if(r&&-1!==n){var i=B.apis.byQName[r.qName];if(i){var a=pxt.blocks.compileInfo(i);return a&&a.parameters[n]}}}}(e);if(n&&n.shadowBlockId){var i=R.blocks.blocksById[n.shadowBlockId];i&&"TD_ID"===i.attributes.shim&&(t=i)}t||(t=R.blocks.apis.byQName[$(r).blockIdentity]);var a=pxt.blocks.compileInfo(t),s=N(t.attributes.blockId),o=e.template.text;return s.fields=[W(a.parameters[0].actualName,o)],s}(e);case ue.CallExpression:return Y(e,void 0,void 0,!0);default:_(e,je.Util.lf("Unsupported syntax kind for output expression block: {0}",ue[e.kind]))}var t,r,n,i,a,s,o,l}function C(n,i,e){if(r){var t=r.getRenamesInSpan(i,e);if(t.length){var a=0;t.forEach(function(e){var t=e.span.start+a-i,r=t+e.span.length;a+=e.diff,n=n.slice(0,t)+e.name+n.slice(r)})}}return n}function U(e){var t=C(e.getFullText(),e.getFullStart(),e.getEnd()).trim();return ae(e),G(je.TS_OUTPUT_TYPE,"EXPRESSION",t)}function A(e){if(e.kind===ue.BinaryExpression){var t=e;if("+"===t.operatorToken.getText()||t.operatorToken.kind==ue.PlusEqualsToken)return!!je.pxtInfo(e).exprInfo}return!1}function P(e){var t=[];!function e(t,r){A(t)?(e(t.left,r),e(t.right,r)):r.push(t)}(e,t);for(var r,n=[],i=0;i<t.length;i++)(0<i||'""'!==(r=t[i].getText())&&"''"!==r&&"``"!==r)&&n.push(z("ADD"+n.length,t[i],xe));var a=N("text_join");return a.inputs=n,a.mutation={items:n.length.toString()},a}function z(e,t,r,n){var i;if("expr"==(i="number"==typeof t?V(t.toString()):"boolean"==typeof t?F(t):"string"==typeof t?L(t):j(t)).kind&&"math_number"==i.type){var a=i.fields[0].value;"math_integer"==r&&a%1==0&&(i.type="math_integer"),"math_whole_number"==r&&a%1==0&&0<a&&(i.type="math_whole_number")}return q(e,i,r,n)}function V(e){return G("math_number","NUM",e)}function L(e){return G("text","TEXT",e)}function F(e){return G("logic_boolean","BOOL",e?"TRUE":"FALSE")}function G(e,t,r,n){var i=N(e);return i.fields=[W(t,r)],i.isShadow=n,i}function J(e,t){return q(e,G("variables_get_reporter","VAR",t,!0),"variables_get_reporter")}function H(e,t,r){var n=pxt.blocks.reporterTypeForArgType(t),i=G(n,"VALUE",e,r);return"argument_reporter_custom"===n&&(i.mutation={typename:t}),i}function W(e,t){return{kind:"field",name:e,value:t}}function D(e){var t=N("math_arithmetic");return t.inputs=[z("A",0,ge),z("B",e,ge)],t.fields=[W("OP","MINUS")],t}function Q(e,t,r){void 0===t&&(t=!1);var n=je.pxtInfo(e).callInfo;if(n){if(e.expression.kind===ue.Identifier){var i=e.expression.text;if(R.declaredEnums[i]){var a=B.enumsByName[i];if(a&&a.blockId)return G(a.blockId,"MEMBER",e.name.text)}else if(R.declaredKinds[i])return G(R.declaredKinds[i].kindInfo.blockId,"MEMBER",e.name.text)}var s=$(n);if(r=s.blockId||r,s.blockCombine)return ee(e,null,"@get@");if("lists_length"===s.blockId||"text_length"===s.blockId){var o=N(je.U.htmlEscape(s.blockId));return o.inputs=[z("VALUE",e.expression)],o}var l=je.U.htmlEscape(s.blockId||n.qName),c=Ae(e)[0],u=c&&je.pxtInfo(c).callInfo;if(t||!r&&!s.blockIdentity||u&&u.qName===s.blockIdentity)return{kind:"text",value:l};s.enumval&&u&&s.useEnumVal&&(l=s.enumval);var p=R.compInfo(n);if(r&&p.thisParameter){var f=N(r);return f.inputs=[z(je.U.htmlEscape(p.thisParameter.definitionName),e.expression,p.thisParameter.shadowBlockId)],f}var d=s.blockIdentity?B.apis.byQName[s.blockIdentity]:B.blocksById[r],m=/%([a-zA-Z0-9_]+)/.exec(d.attributes.block),h=N(je.U.htmlEscape(d.attributes.blockId));return h.fields=[{kind:"field",name:je.U.htmlEscape(m[1]),value:l}],h}_(e)}function Y(e,t,r,n,i){void 0===n&&(n=!1),void 0===i&&(i=!1);var a,s,o,l,c,u,p,f,d,m,h=e,g=!1,v=Ee(h,R,n,i);if(v)a=Z(h,void 0,v);else switch(h.kind){case ue.Block:return re(h.statements,t,i);case ue.ExpressionStatement:return Y(h.expression,t,r||h,n,i);case ue.VariableStatement:if(!(a=re(h.declarationList.declarations,void 0,!1,r||h)))return x();g=!0;break;case ue.FunctionExpression:case ue.ArrowFunction:return f=t,Y(h.body,f);case ue.BinaryExpression:a=function(e){switch(e.left.text,e.operatorToken.kind){case ue.EqualsToken:return e.left.kind===ue.Identifier?M(e.left,e.right):e.left.kind==ue.PropertyAccessExpression?X(e.left,e.right,"@set@"):(i=e.left,a=e.right,(s=K("lists_index_set")).inputs=[z("LIST",i.expression),z("INDEX",i.argumentExpression,ge),z("VALUE",a)],s);case ue.PlusEqualsToken:if(A(e)){var t=K("variables_set"),r=se(e.left);return ie(r,ce.InBlocksOnly),t.inputs=[q("VALUE",P(e),ge)],t.fields=[W("VAR",r)],t}return e.left.kind==ue.PropertyAccessExpression?X(e.left,e.right,"@change@"):M(e.left,e.right,!0);case ue.MinusEqualsToken:var n=K("variables_change");return n.inputs=[q("VALUE",D(e.right),ge)],n.fields=[W("VAR",se(e.left))],n;default:return void _(e,je.Util.lf("Unsupported operator token in statement {0}",ue[e.operatorToken.kind]))}var i,a,s}(h);break;case ue.PostfixUnaryExpression:case ue.PrefixUnaryExpression:a=function(e){var t=e.operator===ue.PlusPlusToken;if(t||e.operator===ue.MinusMinusToken)return M(e.operand,t?1:-1,!0);_(e)}(h);break;case ue.VariableDeclaration:var b=h;if(Ke(b,R))return p=b,E.push([se(p.name),p]),k(r||h),x();a=function(e){if((t=e).name.kind!==ue.Identifier?(_(t,je.Util.lf("Variable declarations may not use binding patterns")),0):t.initializer||(_(t,je.Util.lf("Variable declarations must have an initializer")),0))return M(e.name,e.initializer);var t}(b);break;case ue.WhileStatement:c=h,(u=K("device_while")).inputs=[O("COND",c.expression)],u.handlers=[{name:"DO",statement:Y(c.statement)}],a=u;break;case ue.IfStatement:d=function e(t){var r={ifStatements:[{expression:t.expression,thenStatement:t.thenStatement}],elseStatement:t.elseStatement};if(t.elseStatement&&t.elseStatement.kind==ue.IfStatement){var n=e(t.elseStatement);r.ifStatements=r.ifStatements.concat(n.ifStatements),r.elseStatement=n.elseStatement}return r}(h),(m=K("controls_if")).mutation={elseif:(d.ifStatements.length-1).toString(),else:d.elseStatement?"1":"0"},m.inputs=[],m.handlers=[],d.ifStatements.forEach(function(e,t){m.inputs.push(O("IF"+t,e.expression)),m.handlers.push({name:"DO"+t,statement:Y(e.thenStatement)})}),d.elseStatement&&m.handlers.push({name:"ELSE",statement:Y(d.elseStatement)}),a=m;break;case ue.ForStatement:a=function(e){var t,r=e.initializer,n=(r.declarations[0].name.text,e.condition),i=se(r.declarations[0].name);if(n.operatorToken.kind!==ue.LessThanToken||function e(t){return t.kind===ue.Identifier&&se(t)===i||qe.forEachChild(t,e)}(e.statement))if((t=K("pxt_controls_for")).fields=[],t.inputs=[],t.handlers=[],t.inputs=[J("VAR",i)],n.operatorToken.kind===ue.LessThanToken){var a=Pe(n.right);if(a.kind===ue.NumericLiteral){var s=parseFloat(a.text)-1,o=V(s+"");t.inputs.push(q("TO",o,ye))}else{var l=N("math_arithmetic");l.fields=[W("OP","MINUS")],l.inputs=[z("A",a,ge),z("B",1,ge)],t.inputs.push(q("TO",l,ye))}}else n.operatorToken.kind===ue.LessThanEqualsToken&&t.inputs.push(z("TO",n.right,ye));else(t=K("controls_repeat_ext")).fields=[],t.inputs=[z("TIMES",n.right,ye)],t.handlers=[];return t.handlers.push({name:"DO",statement:Y(e.statement)}),t}(h);break;case ue.ForOfStatement:o=se((s=h).initializer.declarations[0].name),(l=K("pxt_controls_for_of")).inputs=[z("LIST",s.expression),J("VAR",o)],l.handlers=[{name:"DO",statement:Y(s.statement)}],a=l;break;case ue.FunctionDeclaration:a=function(e){var r=se(e.name);R.localReporters.push(e.parameters.map(function(e){return{name:e.name.getText(),type:e.type.getText()}}));var n,t=Y(e.body);return R.localReporters.pop(),(n=K("function_definition")).mutation={name:r},e.parameters&&(n.mutationChildren=[],e.parameters.forEach(function(e){var t=e.name.getText();n.mutationChildren.push({nodeName:"arg",attributes:{name:t,type:e.type.getText(),id:R.functionParamIds[r][t]}})})),n.handlers=[{name:"STACK",statement:t}],n}(h);break;case ue.CallExpression:a=function(e,t){var A=je.pxtInfo(e).callInfo,P=$(A);if("Math.pow"==A.qName){var r=N("math_arithmetic");return r.inputs=[q("A",j(e.arguments[0]),ge),q("B",j(e.arguments[1]),ge)],r.fields=[W("OP","POWER")],r}if(pxt.Util.startsWith(A.qName,"Math.")){var n=A.qName.substring(5);if(Me(n)){var i;if($e(n))i=N("math_js_round");else{i=N("math_js_op");var a=void 0;a=Be(n)?"unary":Re(n)?"infix":"binary",i.mutation={"op-type":a}}return i.inputs=A.args.map(function(e,t){return q("ARG"+t,j(e),"math_number")}),i.fields=[W("OP",n)],i}}if(P.blockId===je.PAUSE_UNTIL_TYPE){var s=K(je.PAUSE_UNTIL_TYPE),o=e.arguments[0],l=void 0;return l=o.body.kind===ue.Block?o.body.statements[0].expression:o.body,s.inputs=[q("PREDICATE",j(l),"logic_boolean")],s}if(!P.blockId||!P.block){var c=pxt.blocks.builtinFunctionInfo[A.qName];if(!c){var u,p=se(e.expression);return R.declaredFunctions[p]?(u=K("function_call"),A.args.length&&(u.mutationChildren=[],u.inputs=[],R.declaredFunctions[p].parameters.forEach(function(e,t){var r=e.name.getText(),n=R.functionParamIds[p][r];u.mutationChildren.push({nodeName:"arg",attributes:{name:r,type:e.type.getText(),id:n}});var i=j(A.args[t]),a=q(n,i);u.inputs.push(a)})),u.mutation={name:p},u):Z(e)}P.blockId=c.blockId}if(P.imageLiteral)return function(e,t){var r=e.arguments[0];if(r.kind==ue.StringLiteral||r.kind==ue.NoSubstitutionTemplateLiteral){var n=$(t),i=K(n.blockId);i.fields=[];var a=(r.text||"").replace(/\s+/g,""),s=(n.imageLiteralColumns||5)*n.imageLiteral,o=n.imageLiteralRows||5,l=s*o;if(l==a.length){for(var c="",u=0;u<o;++u){for(var p=0;p<s;++p)c+=/[#*1]/.test(a[u*s+p])?"#":".";c+="\n"}return i.fields.push(W("LEDS","`"+c+"`")),i}_(e,je.Util.lf("Invalid image pattern ({0} expected vs {1} actual)",l,a.length))}else _(e)}(e,A);qe.isFunctionLike(A.decl);var f=De(A,R.blocks),d=R.blocks.apis.byQName[A.qName],L=pxt.blocks.compileInfo(d),F={kind:t?"expr":"statement",type:P.blockId},D=function(e){return(F.inputs||(F.inputs=[])).push(e)},O=function(e){return(F.fields||(F.fields=[])).push(e)};"Math.max"==A.qName&&O({kind:"field",name:"op",value:"max"});var M=0;return f.forEach(function(e,t){var r,n,i=e.value,a=e.param,s=e.info,o=L.parameters[L.thisParameter?t-1:t],l=o&&o.range;if(l){var c=l.min,u=l.max;r={min:c.toString(),max:u.toString()}}if(0===t&&P.defaultInstance){if(i.getText()===P.defaultInstance)return;F.mutation={showing:"true"}}if(!P.mutatePropertyEnum||t!==A.args.length-2){var p;if(a&&a.isOptional&&++M,a&&a.shadowBlockId&&(p=B.blocksById[a.shadowBlockId]),i.kind===ue.CallExpression){var f=je.pxtInfo(i).callInfo,d=f&&$(f);d&&"TD_ID"===d.shim&&s.isEnum&&(i=Pe(f.args[0]))}if(a&&a.fieldOptions&&a.fieldOptions[le.DecompileArgumentAsString])O(W(je.U.htmlEscape(a.definitionName),je.Util.htmlEscape(i.getText())));else switch(i.kind){case ue.FunctionExpression:case ue.ArrowFunction:var m=function(e){var t=Ce(e);if(t)return{callbackproperties:t[0].join(","),renamemap:je.Util.htmlEscape(JSON.stringify(t[1]))}}(i),h=!1;if(m)F.mutation=m;else{var g=i,v=B.blocksById[P.blockId].parameters[L.thisParameter?t-1:t],b=function(e,t){var r,n,i,a;"reporter"===P.draggableParameters?D((r="HANDLER_DRAG_PARAM_"+e.name,n=t,i=e.type,a=pxt.blocks.reporterTypeForArgType(i),q(r,H(n,i,!0),a))):D(J("HANDLER_DRAG_PARAM_"+e.name,t))};if(g.parameters.length&&(P.optionalVariableArgs?(F.mutation={numargs:g.parameters.length.toString()},g.parameters.forEach(function(e,t){F.mutation["arg"+t]=e.name.text})):g.parameters.forEach(function(e,t){var r=v.handlerParameters[t];P.draggableParameters?b(r,e.name.text):O(W("HANDLER_"+r.name,e.name.text))})),P.draggableParameters){if(g.parameters.length<v.handlerParameters.length)for(var y=g.parameters.length;y<v.handlerParameters.length;y++){var x=v.handlerParameters[y];b(x,x.name)}"reporter"===P.draggableParameters&&(R.localReporters.push(v.handlerParameters),h=!0)}}(F.handlers||(F.handlers=[])).push({name:"HANDLER",statement:Y(i)}),h&&R.localReporters.pop();break;case ue.PropertyAccessExpression:var k=je.pxtInfo(i).callInfo,S=je.U.htmlEscape(a.definitionName),T=$(k);p&&"TD_ID"===p.attributes.shim?D(q(S,Q(i,!1,a.shadowBlockId),a.shadowBlockId,r)):s&&s.isEnum||k&&(T.fixedInstance||T.blockIdentity===A.qName)?O(W(S,Q(i,!0).value)):D(z(S,i,a.shadowBlockId,r));break;case ue.BinaryExpression:if(a&&a.shadowOptions&&a.shadowOptions.toString){var w=i;if(w.operatorToken.kind===ue.PlusToken&&((n=w.left).kind===ue.StringLiteral||n.kind===ue.NoSubstitutionTemplateLiteral)&&""===n.text){D(z(je.U.htmlEscape(a.definitionName),w.right,a.shadowBlockId||"text"));break}}D(z(je.U.htmlEscape(a.definitionName),i,a.shadowBlockId,r));break;default:var E=void 0,I=je.U.htmlEscape(a.definitionName),_=!0;if("Math.random"==A.qName)E=q(I,function(e){switch(e.kind){case ue.NumericLiteral:var t=e;return V((parseInt(t.text)-1).toString());case ue.BinaryExpression:var r=e;if(r.operatorToken.kind==ue.PlusToken&&"1"==r.right.text)return j(r.left);default:return j(e)}}(i),ge,r),_=!1;else if(Fe(i)){var K="text"==a.fieldEditor?i.text:i.getText(),N=a.shadowBlockId&&!function(e){switch(e){case ge:case ve:case be:case ye:case xe:case ke:return!0;default:return!1}}(a.shadowBlockId);if(te(a)&&a.fieldOptions.onParentBlock)return void O(W(I,K));if(N){var C=function(e){if(B.blocksById[e]){var t=pxt.blocks.compileInfo(B.blocksById[e]);if(!t.thisParameter&&1===t.parameters.length)return t.parameters[0]}}(a.shadowBlockId);if(C&&te(C)){var U=G(a.shadowBlockId,C.definitionName,K,!0);a.shadowOptions&&(U.mutation={customfield:je.Util.htmlEscape(JSON.stringify(a.shadowOptions))}),E=q(I,U,a.shadowBlockId,r),_=!1}}}else if(i.kind===ue.TaggedTemplateExpression&&a.fieldOptions&&a.fieldOptions[le.TaggedTemplate])return void O(W(I,je.Util.htmlEscape(i.getText())));_&&(E=z(I,i,a.shadowBlockId,r)),D(E)}}}),M&&(F.mutation||(F.mutation={}),F.mutation._expanded=M.toString()),F}(h,n);break;case ue.DebuggerStatement:a=K(je.TS_DEBUGGER_TYPE);break;case ue.BreakStatement:a=K(je.TS_BREAK_TYPE);break;case ue.ContinueStatement:a=K(je.TS_CONTINUE_TYPE);break;case ue.EmptyStatement:a=void 0;break;case ue.EnumDeclaration:case ue.ModuleDeclaration:return x();default:return void _(h,t?je.Util.lf("Unsupported statement in block: {0}",ue[h.kind]):je.Util.lf("Statement kind unsupported in blocks: {0}",ue[h.kind]))}if(a){for(var y=a;y.next;)y=y.next;y.next=x(),y.next&&(y.next.prev=y)}return g||k(r||h),a;function x(){if(t&&t.length)return Y(t.shift(),t,void 0,!1,i)}function k(e){var t=qe.getLeadingCommentRangesOfNode(e,S);if(t){var r=[],n=function(e,t,r){for(var s="",o="",n=Ne(t),i=0,a=e;i<a.length;i++){var l=a[i],c=T.substr(l.pos,l.end-l.pos);if(c&&(c=c.replace(/\r\n/g,"\n")),l.kind===qe.SyntaxKind.SingleLineCommentTrivia)d(c,1,3,Te);else if(l.kind===qe.SyntaxKind.MultiLineCommentTrivia&&n){for(var u=c.split("\n"),p=0;p<u.length;p++)d(u[p],p,u.length,we);o&&(s+=o);var f=I();r&&r.push(f),w.push({text:s,refId:f}),o=s=""}else for(var u=c.split("\n"),p=0;p<u.length;p++)d(u[p],p,u.length,we)}return(s+=o).trim();function d(e,t,r,n){var i=n.exec(e);if(i){var a=i[1].trim();if(a===je.ON_START_COMMENT||a===je.HANDLER_COMMENT)return;a?o+=o?" "+a:a:t&&t<r-1&&(s+=o+"\n",o="")}}}(t,h,r);a&&(r.length&&(a.data=r.join(";")),n&&a&&(a.comment=n))}}}function Z(e,t,r){u.errorOnGreyBlocks&&_(e);var n=K(je.TS_STATEMENT_TYPE);n.mutation={},ae(e);var i=e.getText();i=C(i,e.getStart(),e.getEnd()),t&&(i=t+i);var a=[];if(e.kind===ue.VariableStatement)for(var s=0,o=e.declarationList.declarations;s<o.length;s++){var l=o[s];a.push(se(l.name))}else e.kind===ue.VariableDeclaration&&a.push(se(e.name));a.length&&(n.mutation.declaredvars=a.join(","));var c=i.split("\n");return n.mutation.numlines=c.length.toString(),r&&u.includeGreyBlockMessages&&(n.mutation.error=je.U.htmlEscape(r)),c.forEach(function(e,t){n.mutation["line"+t]=je.U.htmlEscape(e)}),n}function O(e,t){return function(e){var t=Pe(e);switch(t.kind){case ue.TrueKeyword:case ue.FalseKeyword:case ue.Identifier:case ue.ElementAccessExpression:return;case ue.BinaryExpression:return function(e){switch(e.operatorToken.kind){case ue.EqualsEqualsToken:case ue.EqualsEqualsEqualsToken:case ue.ExclamationEqualsToken:case ue.ExclamationEqualsEqualsToken:case ue.LessThanToken:case ue.LessThanEqualsToken:case ue.GreaterThanToken:case ue.GreaterThanEqualsToken:case ue.AmpersandAmpersandToken:case ue.BarBarToken:return;default:return je.Util.lf("Binary expressions in conditionals must evaluate to booleans")}}(t);case ue.CallExpression:return function(e){var t=je.pxtInfo(e.expression).callInfo;if(t){var r=R.blocks.apis.byQName[t.qName];if(r&&"boolean"==r.retType)return}return je.Util.lf("Only functions that return booleans are allowed as conditions")}(t);case ue.PrefixUnaryExpression:if(t.operator===ue.ExclamationToken)return;default:return je.Util.lf("Conditions must evaluate to booleans or identifiers")}}(t)?q(e,U(t),ke):z(e,t,ke)}function M(e,t,r,n){void 0===r&&(r=!1),void 0===n&&(n=!1);var i=se(e);ie(i,ce.InBlocksOnly);var a=K(r?"variables_change":"variables_set");return a.inputs=[z("VALUE",t,ge)],a.fields=[W("VAR",i)],a}function X(e,t,r){return ee(e,t,r)}function ee(e,t,r){var n=je.pxtInfo(e).callInfo,i=R.blocks.apis.byQName[n?n.qName:""];if(i&&i.attributes.blockCombine){var a=i.namespace+"."+i.retType+"."+r,s=R.blocks.blocks.find(function(e){return e.qName==a}),o=t?K(s.attributes.blockId):N(s.attributes.blockId),l=s.attributes._def.parameters,c=n.qName;return s.combinedProperties&&s.combinedProperties.forEach(function(e){0===e.indexOf(n.qName)&&"@"===e.charAt(n.qName.length)&&(c=e)}),o.inputs=[z(l[0].name,e.expression)],o.fields=[W(l[1].name,c)],t&&o.inputs.push(z(l[2].name,t)),o}_(e)}function te(e){return e&&e.fieldOptions&&e.fieldOptions[le.DecompileLiterals]}function re(e,t,r,n,i){void 0===r&&(r=!1),void 0===i&&(i=!1);for(var a=[],s=t||[],o=e.length-1;0<=o;o--){var l=e[o];(l.kind===ue.FunctionDeclaration||l.kind==ue.ExpressionStatement&&m(l))&&!Ee(l,R,!1,r)?a.unshift(l):s.unshift(l)}if(a.map(function(e){return Y(e,void 0,void 0,!1,r)}).forEach(h),s.length){var c=Y(s.shift(),s,n,!1,r);if(i){var u=c;if(E.forEach(function(e){var t,r=e[0],n=e[1];f[r]!==ce.InBlocksOnly&&(n.initializer,(t=f[r]===ce.InTextBlocks?Z(n,"let "):M(n.name,n.initializer,!1,!0)).next=u,u=t)}),u){var p=K(qe.pxtc.ON_START_TYPE);return p.handlers=[{name:"HANDLER",statement:u}],p}ne()}return c}i&&ne()}function ne(){u.alwaysEmitOnStart&&(d(),p('<block type="'+qe.pxtc.ON_START_TYPE+'"></block>'))}function ie(e,t){f[e]!==ce.InTextBlocks&&(f[e]=t)}function ae(e){qe.forEachChild(e,function(e){e.kind===ue.Identifier&&ie(se(e),ce.InTextBlocks),ae(e)})}function se(e){if(r){var t=r.getRenameForPosition(e.getStart());if(t)return t.name}return e.text}}})((je=qe.pxtc||(qe.pxtc={})).decompiler||(je.decompiler={}))}(ts||(ts={})),function(e){var S;(function(e){var r={r0:0,r1:1,r2:2,r3:3,r4:4,r5:5,r6:6,r7:7,r8:8,r9:9,r10:10,r11:10,r12:12,sp:13,r13:13,lr:14,r14:14,pc:15,r15:15},t=function(e){function t(){var t=e.call(this)||this;return t.addEnc("$r0","R0-7",function(e){return t.inrange(7,e,e)}),t.addEnc("$r1","R0-7",function(e){return t.inrange(7,e,e<<3)}),t.addEnc("$r2","R0-15",function(e){return t.inrange(15,e,7&e|(8&e)<<4)}),t.addEnc("$r3","R0-15",function(e){return t.inrange(15,e,e<<3)}),t.addEnc("$r4","R0-7",function(e){return t.inrange(7,e,e<<6)}),t.addEnc("$r5","R0-7",function(e){return t.inrange(7,e,e<<8)}),t.addEnc("$r01","R0-7",function(e){return t.inrange(7,e,e|e<<3)}),t.addEnc("$i0","#0-255",function(e){return t.inrange(255,e,e)}),t.addEnc("$i1","#0-1020",function(e){return t.inrange(255,e/4,e>>2)}),t.addEnc("$i2","#0-510",function(e){return t.inrange(127,e/4,e>>2)}),t.addEnc("$i3","#0-7",function(e){return t.inrange(7,e,e<<6)}),t.addEnc("$i4","#0-31",function(e){return t.inrange(31,e,e<<6)}),t.addEnc("$i5","#0-124",function(e){return t.inrange(31,e/4,e>>2<<6)}),t.addEnc("$i6","#1-32",function(e){return 0==e?null:32==e?0:t.inrange(31,e,e<<6)}),t.addEnc("$i7","#0-62",function(e){return t.inrange(31,e/2,e>>1<<6)}),t.addEnc("$i32","#0-2^32",function(e){return 1}),t.addEnc("$rl0","{R0-7,...}",function(e){return t.inrange(255,e,e)}),t.addEnc("$rl1","{LR,R0-7,...}",function(e){return 16384&e?t.inrange(255,-16385&e,256|255&e):t.inrange(255,e,e)}),t.addEnc("$rl2","{PC,R0-7,...}",function(e){return 32768&e?t.inrange(255,-32769&e,256|255&e):t.inrange(255,e,e)}),t.addEnc("$la","LABEL",function(e){return t.inrange(255,e/4,e>>2)}).isWordAligned=!0,t.addEnc("$lb","LABEL",function(e){return t.inrangeSigned(127,e/2,e>>1)}),t.addEnc("$lb11","LABEL",function(e){return t.inrangeSigned(1023,e/2,e>>1)}),t.addInst("adcs  $r0, $r1",16704,65472),t.addInst("add   $r2, $r3",17408,65280),t.addInst("add   $r5, pc, $i1",40960,63488),t.addInst("add   $r5, sp, $i1",43008,63488),t.addInst("add   sp, $i2",45056,65408).canBeShared=!0,t.addInst("adds  $r0, $r1, $i3",7168,65024),t.addInst("adds  $r0, $r1, $r4",6144,65024),t.addInst("adds  $r01, $r4",6144,65024),t.addInst("adds  $r5, $i0",12288,63488),t.addInst("adr   $r5, $la",40960,63488),t.addInst("ands  $r0, $r1",16384,65472),t.addInst("asrs  $r0, $r1",16640,65472),t.addInst("asrs  $r0, $r1, $i6",4096,63488),t.addInst("bics  $r0, $r1",17280,65472),t.addInst("bkpt  $i0",48640,65280),t.addInst("blx   $r3",18304,65415),t.addInst("bx    $r3",18176,65408),t.addInst("cmn   $r0, $r1",17088,65472),t.addInst("cmp   $r0, $r1",17024,65472),t.addInst("cmp   $r2, $r3",17664,65280),t.addInst("cmp   $r5, $i0",10240,63488),t.addInst("eors  $r0, $r1",16448,65472),t.addInst("ldmia $r5!, $rl0",51200,63488),t.addInst("ldmia $r5, $rl0",51200,63488),t.addInst("ldr   $r0, [$r1, $i5]",26624,63488),t.addInst("ldr   $r0, [$r1, $r4]",22528,65024),t.addInst("ldr   $r5, [pc, $i1]",18432,63488),t.addInst("ldr   $r5, $la",18432,63488),t.addInst("ldr   $r5, [sp, $i1]",38912,63488).canBeShared=!0,t.addInst("ldr   $r5, [sp]",38912,63488).canBeShared=!0,t.addInst("ldrb  $r0, [$r1, $i4]",30720,63488),t.addInst("ldrb  $r0, [$r1, $r4]",23552,65024),t.addInst("ldrh  $r0, [$r1, $i7]",34816,63488),t.addInst("ldrh  $r0, [$r1, $r4]",23040,65024),t.addInst("ldrsb $r0, [$r1, $r4]",22016,65024),t.addInst("ldrsh $r0, [$r1, $r4]",24064,65024),t.addInst("lsls  $r0, $r1",16512,65472),t.addInst("lsls  $r0, $r1, $i4",0,63488),t.addInst("lsrs  $r0, $r1",16576,65472),t.addInst("lsrs  $r0, $r1, $i6",2048,63488),t.addInst("mov   $r2, $r3",17920,65280),t.addInst("movs  $r0, $r1",0,65472),t.addInst("movs  $r5, $i0",8192,63488),t.addInst("muls  $r0, $r1",17216,65472),t.addInst("mvns  $r0, $r1",17344,65472),t.addInst("negs  $r0, $r1",16960,65472),t.addInst("nop",18112,65535),t.addInst("orrs  $r0, $r1",17152,65472),t.addInst("pop   $rl2",48128,65024),t.addInst("push  $rl1",46080,65024),t.addInst("rev   $r0, $r1",47616,65472),t.addInst("rev16 $r0, $r1",47680,65472),t.addInst("revsh $r0, $r1",47808,65472),t.addInst("rors  $r0, $r1",16832,65472),t.addInst("sbcs  $r0, $r1",16768,65472),t.addInst("sev",48960,65535),t.addInst("stm   $r5!, $rl0",49152,63488),t.addInst("stmia $r5!, $rl0",49152,63488),t.addInst("stmea $r5!, $rl0",49152,63488),t.addInst("str   $r0, [$r1, $i5]",24576,63488).canBeShared=!0,t.addInst("str   $r0, [$r1]",24576,63488).canBeShared=!0,t.addInst("str   $r0, [$r1, $r4]",20480,65024),t.addInst("str   $r5, [sp, $i1]",36864,63488).canBeShared=!0,t.addInst("str   $r5, [sp]",36864,63488).canBeShared=!0,t.addInst("strb  $r0, [$r1, $i4]",28672,63488),t.addInst("strb  $r0, [$r1, $r4]",21504,65024),t.addInst("strh  $r0, [$r1, $i7]",32768,63488),t.addInst("strh  $r0, [$r1, $r4]",20992,65024),t.addInst("sub   sp, $i2",45184,65408),t.addInst("subs  $r0, $r1, $i3",7680,65024),t.addInst("subs  $r0, $r1, $r4",6656,65024),t.addInst("subs  $r01, $r4",6656,65024),t.addInst("subs  $r5, $i0",14336,63488),t.addInst("svc   $i0",57088,65280),t.addInst("sxtb  $r0, $r1",45632,65472),t.addInst("sxth  $r0, $r1",45568,65472),t.addInst("tst   $r0, $r1",16896,65472),t.addInst("udf   $i0",56832,65280),t.addInst("uxtb  $r0, $r1",45760,65472),t.addInst("uxth  $r0, $r1",45696,65472),t.addInst("wfe",48928,65535),t.addInst("wfi",48944,65535),t.addInst("yield",48912,65535),t.addInst("cpsid i",46706,65535),t.addInst("cpsie i",46690,65535),t.addInst("beq   $lb",53248,65280),t.addInst("bne   $lb",53504,65280),t.addInst("bcs   $lb",53760,65280),t.addInst("bcc   $lb",54016,65280),t.addInst("bmi   $lb",54272,65280),t.addInst("bpl   $lb",54528,65280),t.addInst("bvs   $lb",54784,65280),t.addInst("bvc   $lb",55040,65280),t.addInst("bhi   $lb",55296,65280),t.addInst("bls   $lb",55552,65280),t.addInst("bge   $lb",55808,65280),t.addInst("blt   $lb",56064,65280),t.addInst("bgt   $lb",56320,65280),t.addInst("ble   $lb",56576,65280),t.addInst("bhs   $lb",53760,65280),t.addInst("blo   $lb",54016,65280),t.addInst("b     $lb11",57344,63488),t.addInst("bal   $lb11",57344,63488),t.addInst("bl    $lb",61440,63488,!0),t.addInst("bb    $lb",57344,63488,!0),t.addInst("ldlit   $r5, $i32",18432,63488),t}return __extends(t,e),t.prototype.toFnPtr=function(e,t,r){return S.target.runtimeIsARM&&/::/.test(r)?e+t&-2:e+t|1},t.prototype.wordSize=function(){return 4},t.prototype.is32bit=function(e){return"bl"==e.name||"bb"==e.name},t.prototype.postProcessAbsAddress=function(e,t){return t^=1,t-=e.baseOffset},t.prototype.emit32=function(e,t,r){var n=!!(t%2);n&&(t=t+1&-4);var i=t>>1;if(S.assert(null!=i),(0|i)!=i||!(-2097152<i&&i<2097152))return S.assembler.emitErr("jump out of range",r);var a=2047&i,s=i>>11&1023;return{opcode:4026531840&i?62464|s:61440|s,opcode2:n?59392|a:63488|a,stack:0,numArgs:[t],labelName:r}},t.prototype.expandLdlit=function(e){for(var t,r=!1,n=[],i={},a=1,s=0;s<e.lines.length;++s){var o=e.lines[s];if(n.push(o),"instruction"==o.type&&o.instruction&&"ldlit"==o.instruction.name){if(!t){for(var l=o.location+900,c=s+1;c<e.lines.length&&!(e.lines[c].location>l);++c){var u=e.lines[c].getOp();("b"==u||"bb"==u||"pop"==u&&"pc"==e.lines[c].words[2])&&(t=e.lines[c])}if(t)r=!1;else for(r=!0;--c>s;)if("instruction"==e.lines[c].type){t=e.lines[c];break}}var p=o.words[1],f="#"+o.words[3];(v=S.U.lookup(i,f))||(v="_ldlit_"+ ++a,i[f]=v),o.update("ldr "+p+", "+v)}if(o===t){t=null;var d=[],m="_jmpwords_"+ ++a;r&&d.push("bb "+m),d.push(".balign 4");for(var h=0,g=Object.keys(i);h<g.length;h++){var v=i[f=g[h]];d.push(v+": .word "+f.slice(1))}r&&d.push(m+":");for(var b=0,y=d;b<y.length;b++){var x=y[b];e.buildLine(x,n);var k=n[n.length-1];k.scope=o.scope,k.lineNo=o.lineNo}i={}}}e.lines=n},t.prototype.getAddressFromLabel=function(e,t,r,n){void 0===n&&(n=!1);var i=e.lookupLabel(r);if(null==i)return null;var a=e.location()+4;return n&&(a&=4294967292),i-a},t.prototype.isPop=function(e){return 48128==e},t.prototype.isPush=function(e){return 46080==e},t.prototype.isAddSP=function(e){return 45056==e},t.prototype.isSubSP=function(e){return 45184==e},t.prototype.peephole=function(e,t,r){var n=this.encoders.$lb11,i=this.encoders.$lb;function a(e,t){return null!=e.encode(t.numArgs[0]+8)&&null!=e.encode(t.numArgs[0]-8)&&null!=e.encode(t.numArgs[0])}var s,o,l,c,u=e.getOp(),p=!1;"bne"!=u&&"beq"!=u||("b"==t.getOp()&&0==e.numArgs[0]&&(p=!0),"bb"==t.getOp()&&2==e.numArgs[0]&&(p=!0)),"bb"==u&&a(n,e)?e.update("b "+e.words[1]):"b"==u&&-2==e.numArgs[0]?e.update(""):"bne"==u&&p&&a(i,t)?(e.update("beq "+t.words[1]),t.update("")):"beq"==u&&p&&a(i,t)?(e.update("bne "+t.words[1]),t.update("")):"push"!=u||16384!=e.numArgs[0]||"push"!=t.getOp()||16384&t.numArgs[0]?"pop"==u&&"pop"==t.getOp()&&32768==t.numArgs[0]?(e.update(e.text.replace("}",", pc}")),t.update("")):"push"==u&&"pop"==t.getOp()&&e.numArgs[0]==t.numArgs[0]?(S.assert(0<e.numArgs[0]),e.update(""),t.update("")):"push"==u&&"pop"==t.getOp()&&4==e.words.length&&4==t.words.length?(S.assert("{"==e.words[1]),e.update("mov "+t.words[2]+", "+e.words[2]),t.update("")):r&&"movs $r5, $i0"==e.getOpExt()&&"mov $r0, $r1"==t.getOpExt()&&e.numArgs[0]==t.numArgs[1]&&(l=r,c=e.numArgs[0],"pop"==l.getOp()&&l.numArgs[0]&1<<c)?(e.update("movs r"+t.numArgs[0]+", #"+e.numArgs[1]),t.update("")):"pop"==u&&0<=f(e)&&"push"==t.getOp()&&f(e)==f(t)?(e.update("ldr r"+f(e)+", [sp, #0]"),t.update("")):"push"==u&&"ldr $r5, [sp, $i1]"==t.getOpExt()&&f(e)==t.numArgs[0]&&0==t.numArgs[1]?t.update(""):r&&"push"==u&&0<=f(e)&&(s=t,o=f(e),"movs $r5, $i0"==s.getOpExt()&&s.numArgs[0]!=o)&&"pop"==r.getOp()&&f(e)==f(r)&&(e.update(""),r.update("")):(e.update(t.text.replace("{","{lr, ")),t.update(""))},t.prototype.registerNo=function(e){if(!e)return null;e=e.toLowerCase();var t=r[e];return void 0===t?null:t},t.prototype.testAssembler=function(){S.assembler.expectError(this,"lsl r0, r0, #8"),S.assembler.expectError(this,"push {pc,lr}"),S.assembler.expectError(this,"push {r17}"),S.assembler.expectError(this,"mov r0, r1 foo"),S.assembler.expectError(this,"movs r14, #100"),S.assembler.expectError(this,"push {r0"),S.assembler.expectError(this,"push lr,r0}"),S.assembler.expectError(this,"pop {lr,r0}"),S.assembler.expectError(this,"b #+11"),S.assembler.expectError(this,"b #+102400"),S.assembler.expectError(this,"bne undefined_label"),S.assembler.expectError(this,".foobar"),S.assembler.expect(this,"0200      lsls    r0, r0, #8\nb500      push    {lr}\n2064      movs    r0, #100        ; 0x64\nb401      push    {r0}\nbc08      pop     {r3}\nb501      push    {r0, lr}\nbd20      pop {r5, pc}\nbc01      pop {r0}\n4770      bx      lr\n0000      .balign 4\ne6c0      .word   -72000\nfffe\n"),S.assembler.expect(this,"4291      cmp     r1, r2\nd100      bne     l6\ne000      b       l8\n1840  l6: adds    r0, r0, r1\n4718  l8: bx      r3\n"),S.assembler.expect(this,"          @stackmark base\nb403      push    {r0, r1}\n          @stackmark locals\n9801      ldr     r0, [sp, locals@1]\nb401      push    {r0}\n9802      ldr     r0, [sp, locals@1]\nbc01      pop     {r0}\n          @stackempty locals\n9901      ldr     r1, [sp, locals@1]\n9102      str     r1, [sp, base@0]\n          @stackempty locals\nb002      add     sp, #8\n          @stackempty base\n"),S.assembler.expect(this,"b090      sub sp, #4*16\nb010      add sp, #4*16\n"),S.assembler.expect(this,'6261      .string "abc"\n0063      \n'),S.assembler.expect(this,'6261      .string "abcde"\n6463      \n0065      \n'),S.assembler.expect(this,"3042      adds r0, 0x42\n1c0d      adds r5, r1, #0\nd100      bne #0\n2800      cmp r0, #0\n6b28      ldr r0, [r5, #48]\n0200      lsls r0, r0, #8\n2063      movs r0, 0x63\n4240      negs r0, r0\n46c0      nop\nb500      push {lr}\nb401      push {r0}\nb402      push {r1}\nb404      push {r2}\nb408      push {r3}\nb520      push {r5, lr}\nbd00      pop {pc}\nbc01      pop {r0}\nbc02      pop {r1}\nbc04      pop {r2}\nbc08      pop {r3}\nbd20      pop {r5, pc}\n9003      str r0, [sp, #4*3]\n")},t}(S.assembler.AbstractProcessor);function f(e){S.assert("push"==e.getOp()||"pop"==e.getOp());for(var t=0,r=-1,n=e.numArgs[0];0<n;)1&n&&(r=-1==r?t:-2),n>>=1,t++;return 0<=r?r:-1}e.ThumbProcessor=t})((S=e.pxtc||(e.pxtc={})).thumb||(S.thumb={}))}(ts||(ts={})),function(x){var k;(function(g){var v,e,b=k.Util;b.assert,(e=v=g.EK||(g.EK={}))[e.None=0]="None",e[e.NumberLiteral=1]="NumberLiteral",e[e.PointerLiteral=2]="PointerLiteral",e[e.RuntimeCall=3]="RuntimeCall",e[e.ProcCall=4]="ProcCall",e[e.SharedRef=5]="SharedRef",e[e.SharedDef=6]="SharedDef",e[e.FieldAccess=7]="FieldAccess",e[e.Store=8]="Store",e[e.CellRef=9]="CellRef",e[e.Sequence=10]="Sequence",e[e.JmpValue=11]="JmpValue",e[e.Nop=12]="Nop",e[e.InstanceOf=13]="InstanceOf";var a,t,l,r,n=0,i=function(){function e(){}return e.prototype.isExpr=function(){return!1},e.prototype.isStmt=function(){return!1},e.prototype.getId=function(){return this._id||(this._id=++n),this._id},e}(),y=function(i){function r(e,t,r){var n=i.call(this)||this;return n.exprKind=e,n.args=t,n.data=r,n.callingConvention=0,n}return __extends(r,i),r.clone=function(e){var t=new r(e.exprKind,e.args?e.args.slice(0):null,e.data);return e.jsInfo&&(t.jsInfo=e.jsInfo),e.totalUses&&(t.totalUses=e.totalUses,t.currUses=e.currUses),t.callingConvention=e.callingConvention,t.mask=e.mask,t.isStringLiteral=e.isStringLiteral,t},r.prototype.ptrlabel=function(){return this.jsInfo instanceof s?this.jsInfo:null},r.prototype.hexlit=function(){var e=this.jsInfo;return null!=e.hexlit?e.hexlit:null},r.prototype.isExpr=function(){return!0},r.prototype.isPure=function(){return this.isStateless()||this.exprKind==v.CellRef},r.prototype.isLiteral=function(){switch(this.exprKind){case v.NumberLiteral:case v.PointerLiteral:return!0;default:return!1}},r.prototype.isStateless=function(){switch(this.exprKind){case v.NumberLiteral:case v.PointerLiteral:case v.SharedRef:return!0;default:return!1}},r.prototype.sharingInfo=function(){var e=this,t=this.getId();return this.exprKind!=v.SharedRef&&this.exprKind!=v.SharedDef||((e=this.args[0])?t=e.getId():e={currUses:"",totalUses:""}),e.currUses+"/"+e.totalUses+" #"+t},r.prototype.toString=function(){return o(this)},r.prototype.canUpdateCells=function(){switch(this.exprKind){case v.NumberLiteral:case v.PointerLiteral:case v.CellRef:case v.JmpValue:case v.SharedRef:case v.Nop:return!1;case v.SharedDef:case v.FieldAccess:case v.InstanceOf:return this.args[0].canUpdateCells();case v.RuntimeCall:case v.ProcCall:case v.Sequence:case v.Store:return!0;default:throw k.oops()}},r}(g.Node=i);g.Expr=y,(t=a=g.SK||(g.SK={}))[t.None=0]="None",t[t.Expr=1]="Expr",t[t.Label=2]="Label",t[t.Jmp=3]="Jmp",t[t.StackEmpty=4]="StackEmpty",t[t.Breakpoint=5]="Breakpoint",(r=l=g.JmpMode||(g.JmpMode={}))[r.Always=1]="Always",r[r.IfZero=2]="IfZero",r[r.IfNotZero=3]="IfNotZero",g.lblNumUsesJmpNext=-101;var s=function(n){function e(e,t){var r=n.call(this)||this;return r.stmtKind=e,r.expr=t,r}return __extends(e,n),e.prototype.isStmt=function(){return!0},e.prototype.toString=function(){return o(this)},e}(i);function o(e){return function e(t){if(t.isExpr()){var r=t,n=r.args?r.args[0]:null;switch(r.exprKind){case v.NumberLiteral:case v.PointerLiteral:return r.data+"";case v.CellRef:return r.data.toString();case v.JmpValue:return"JMPVALUE";case v.Nop:return"NOP";case v.SharedRef:return"SHARED_REF(#"+n.getId()+")";case v.SharedDef:return"SHARED_DEF(#"+n.getId()+": "+e(n)+")";case v.FieldAccess:return e(n)+"."+r.data.name;case v.RuntimeCall:return r.data+"("+r.args.map(e).join(", ")+")";case v.ProcCall:var i=r.data;return(null!=i.ifaceIndex?"IFACE@"+i.ifaceIndex:null!=i.virtualIndex?"VTABLE@"+i.virtualIndex:k.getDeclName(i.proc.action))+"("+r.args.map(e).join(", ")+")";case v.Sequence:return"("+r.args.map(e).join("; ")+")";case v.InstanceOf:return"("+e(r.args[0])+" instanceof "+r.data.id+")";case v.Store:return"{ "+e(r.args[0])+" := "+e(r.args[1])+" }";default:throw k.oops()}}else{var a=t,s=a.expr?e(a.expr):"{null}";switch(a.stmtKind){case g.SK.Expr:return"    "+s+"\n";case g.SK.Jmp:var o="goto "+a.lblName+"\n";switch(a.jmpMode){case l.Always:return a.expr?"    { JMPVALUE := "+s+" } "+o:"    "+o;case l.IfZero:return"    if (! "+s+") "+o;case l.IfNotZero:return"    if ("+s+") "+o;default:throw k.oops()}case g.SK.StackEmpty:return"    ;\n";case g.SK.Breakpoint:return"    // brk "+a.breakpointInfo.id+"\n";case g.SK.Label:return a.lblName+":\n";default:throw k.oops()}}}(e)}g.Stmt=s;var c=function(){function e(e,t,r){this.index=e,this.def=t,this.info=r,this.isarg=!1,this.iscap=!1,this._isLocal=!1,this._isGlobal=!1,this._debugType="?",this.isUserVariable=!1,this.bitSize=0,t&&(k.isInPxtModules(t)||(this.isUserVariable=!0),r&&k.setCellProps(this))}return e.prototype.getName=function(){return k.getDeclName(this.def)},e.prototype.getDebugInfo=function(){return{name:this.getName(),type:this._debugType,index:this.index}},e.prototype.toString=function(){var e="";return this.def&&(e+=this.getName()||"?"),this.isarg&&(e="ARG "+e),"["+e+"]"},e.prototype.uniqueName=function(){return this.isarg?"arg"+this.index:this.getName().replace(/[^\w]/g,"_")+"___"+k.getNodeId(this.def)},e.prototype.isLocal=function(){return this._isLocal},e.prototype.isGlobal=function(){return this._isGlobal},e.prototype.loadCore=function(){return d(v.CellRef,null,this)},e.prototype.load=function(){var e=this.loadCore();return k.target.isNative&&0!=this.bitSize?6==this.bitSize?m("pxt::fromUInt",[e]):m("pxt::fromInt",[e]):this.isByRefLocal()?m("pxtrt::ldlocRef",[e]):e},e.prototype.isByRefLocal=function(){return this.isLocal()&&this.info.captured&&this.info.written},e.prototype.storeDirect=function(e){return d(v.Store,[this.loadCore(),e])},e.prototype.storeByRef=function(e){if(this.isByRefLocal())return m("pxtrt::stlocRef",[this.loadCore(),e]);if(k.target.isNative&&0!=this.bitSize){var t=6==this.bitSize?"pxt::toUInt":"pxt::toInt";return this.storeDirect(m(t,[e],1))}return this.storeDirect(e)},Object.defineProperty(e.prototype,"isTemporary",{get:function(){return!1},enumerable:!0,configurable:!0}),e}(),u=function(n){function i(e,t){var r=n.call(this,e,null,null)||this;return r.index=e,r.owningProc=t,r.uid=i.unnamedCellCounter++,r}return __extends(i,n),i.prototype.getName=function(){return"unnamed"+this.uid},i.prototype.uniqueName=function(){return this.getName()+"___U"+this.index},i.prototype.isByRefLocal=function(){return!1},Object.defineProperty(i.prototype,"isTemporary",{get:function(){return!0},enumerable:!0,configurable:!0}),i.unnamedCellCounter=0,i}(g.Cell=c);g.UnnamedCell=u;var p=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.numArgs=0,e.info=null,e.seqNo=-1,e.isRoot=!1,e.locals=[],e.captured=[],e.args=[],e.parent=null,e.debugInfo=null,e.fillDebugInfo=null,e.classInfo=null,e.perfCounterName=null,e.perfCounterNo=0,e.body=[],e.lblNo=0,e.action=null,e.cachedJS=null,e.usingCtx=null,e}return __extends(e,t),e.prototype.reset=function(){this.body=[],this.lblNo=0,this.locals=[],this.captured=[],this.args=[]},e.prototype.isGetter=function(){return this.action&&this.action.kind==x.SyntaxKind.GetAccessor},e.prototype.vtLabel=function(){return this.label()+(k.isStackMachine()?"":"_args")},e.prototype.label=function(){return k.getFunctionLabel(this.action)},e.prototype.toString=function(){return"\nPROC "+k.getDeclName(this.action)+"\n"+this.body.map(function(e){return e.toString()}).join("")+"\n"},e.prototype.emit=function(e){this.body.push(e)},e.prototype.emitExpr=function(e){this.emit(f(a.Expr,e))},e.prototype.mkLabel=function(e){var t=f(a.Label,null);return t.lblName="."+e+"_"+this.lblNo+++"_"+this.seqNo,t.lbl=t},e.prototype.emitLbl=function(e){this.emit(e)},e.prototype.emitLblDirect=function(e){var t=f(a.Label,null);t.lblName=e,t.lbl=t,this.emit(t)},e.prototype.getFullName=function(){var e=this.getName();if(this.action){var t=x.pxtc.nodeLocationInfo(this.action);e+=" "+t.fileName.replace("pxt_modules/","")+":"+(t.line+1)}return e},e.prototype.getName=function(){return(this.action&&this.action.name?this.action.name.text:null)||"inline"},e.prototype.mkLocal=function(e,t){var r=new c(this.locals.length,e,t);return this.locals.push(r),r},e.prototype.mkLocalUnnamed=function(){var e=new u(this.locals.length,this);return this.locals.push(e),e},e.prototype.localIndex=function(t,e){return void 0===e&&(e=!1),this.captured.filter(function(e){return e.def==t})[0]||this.locals.filter(function(e){return e.def==t})[0]||(e?null:this.args.filter(function(e){return e.def==t})[0])},e.prototype.stackEmpty=function(){this.emit(f(a.StackEmpty,null))},e.prototype.emitJmpZ=function(e,t){this.emitJmp(e,t,l.IfZero)},e.prototype.emitJmp=function(e,t,r,n){void 0===r&&(r=l.Always),void 0===n&&(n=null);var i=f(a.Jmp,t);i.jmpMode=r,n&&n.exprKind==v.NumberLiteral&&(n=null),i.terminateExpr=n,"string"==typeof e?i.lblName=e:(i.lbl=e,i.lblName=i.lbl.lblName),this.emit(i)},e.prototype.inlineSelf=function(e){var t=h(e),r=t.precomp,n=t.flattened;b.assert(n.length==this.args.length),this.args.map(function(e,t){e.repl=n[t],e.replUses=0});var i=function e(t){switch((t=y.clone(t)).exprKind){case v.PointerLiteral:case v.NumberLiteral:return t;case v.RuntimeCall:for(var r=0;r<t.args.length;++r)t.args[r]=e(t.args[r]);return t;case v.CellRef:var n=t.data;return n.repl?(n.replUses++,n.repl):t;case v.FieldAccess:return t.args[0]=e(t.args[0]),t;default:throw b.oops()}}(this.inlineBody);return this.args.forEach(function(e,t){e.repl.exprKind==v.SharedRef&&(e.repl.args[0].totalUses+=e.replUses-1),e.repl=null,e.replUses=0}),r.length?(r.push(i),d(v.Sequence,r)):i},e.prototype.resolve=function(){var e,n=function(e,t){if(e.args)for(var r=0;r<e.args.length;++r)e.args[r]=t(e.args[r])},i=function(e){switch(e.exprKind){case v.SharedDef:throw b.oops();case v.SharedRef:var t=e.args[0];if(t.totalUses)return t.totalUses--,e;t.totalUses=-1,t.currUses=0,t.irCurrUses=0;var r=y.clone(e);return r.exprKind=v.SharedDef,r.args[0]=i(r.args[0]),r}return n(e,i),e},t=function(r){if(r.exprKind==v.SharedRef)return r;switch(n(r,t),r.exprKind){case v.Sequence:r.args=r.args.filter(function(e,t){return t==r.args.length-1||!e.isPure()||(e.exprKind==v.SharedRef&&0<e.args[0].totalUses&&e.args[0].totalUses--,!1)})}return r},a=function(e){switch(e.exprKind){case v.SharedDef:var t=e.args[0];if(b.assert(t.totalUses<0,"arg.totalUses < 0"),b.assert(0===t.currUses,"arg.currUses === 0"),-1==t.totalUses)return a(t);t.totalUses=1;break;case v.SharedRef:return b.assert(0<e.args[0].totalUses,"e.args[0].totalUses > 0"),e.args[0].totalUses++,e;case v.PointerLiteral:var r=e.ptrlabel();r&&(r.lblNumUses||(r.lblNumUses=0),r.lblNumUses++)}return n(e,a),e},r=function(e){switch(e.exprKind){case v.SharedDef:n(e,r);case v.SharedRef:var t=e.args[0];return b.assert(0<t.totalUses,"arg.totalUses > 0"),1==t.totalUses?(b.assert(e.exprKind==v.SharedDef),t):(t.irCurrUses++,e);default:return n(e,r),e}};this.body=this.body.filter(function(e){return!e.expr||(e.expr=t(i(e.expr)),e.stmtKind!=g.SK.Expr||!e.expr.isPure())});for(var s=b.toDictionary(this.body.filter(function(e){return e.stmtKind==g.SK.Label}),function(e){return e.lblName}),o=0;o<this.body.length;++o)this.body[o].stmtNo=o;for(var l=0,c=this.body;l<c.length;l++)switch((e=c[l]).expr&&(e.expr=a(e.expr)),e.stmtKind){case g.SK.Expr:break;case g.SK.Jmp:e.lbl=b.lookup(s,e.lblName),e.lbl||k.oops("missing label: "+e.lblName),e.lbl.lblNumUses?e.lbl.lblNumUses++:e.lbl.lblNumUses=1;break;case g.SK.StackEmpty:case g.SK.Label:case g.SK.Breakpoint:break;default:k.oops()}for(var u=[],p=null,f=!k.target.debugMode,d=null,m=0,h=this.body;m<h.length;m++)(e=h[m]).expr&&(e.expr=t(r(e.expr))),p&&p.lbl==e&&p.stmtKind==g.SK.Jmp&&e.stmtKind==g.SK.Label&&p.jmpMode==g.JmpMode.Always&&1==e.lblNumUses&&(e.lblNumUses=g.lblNumUsesJmpNext),(p=e).stmtKind==g.SK.Breakpoint?u[e.breakpointInfo.id]=e.breakpointInfo:f&&(e.stmtKind==g.SK.Jmp?e.expr&&(d?f=!1:d=e.expr):e.stmtKind==g.SK.StackEmpty||(e.stmtKind==g.SK.Label?e.lblNumUses!=g.lblNumUsesJmpNext&&(f=!1):f=!1));f&&d&&function n(i){var e=function(){if(!i.args)return 0;for(var e=0,t=0,r=i.args;t<r.length;t++)e+=n(r[t]);return i.mask&&i.mask.conversions&&(e+=4*i.mask.conversions.length),e};switch(i.exprKind){case v.NumberLiteral:return 2;case v.PointerLiteral:return 6;case v.RuntimeCall:return e()+2+2+4;case v.CellRef:return 2;case v.FieldAccess:return e()+(i.data.needsCheck?4:0)+2;case v.ProcCall:case v.SharedRef:case v.SharedDef:case v.Store:case v.Sequence:case v.JmpValue:case v.Nop:case v.InstanceOf:return 1e6;default:throw b.oops()}}(d)<=4*this.args.length+4+2+(k.target.isNative?4:30)&&(this.inlineBody=d),pxt.options.debug&&pxt.debug(this.toString())},e}(i);function f(e,t){return new s(e,t)}function d(e,t,r){return new y(e,t,r)}function m(e,t,r){void 0===r&&(r=0);var n=d(v.RuntimeCall,t,e);return r&&(n.mask={refMask:r}),n}function h(e,t){void 0===t&&(t=!1);for(var r=!!t&&e.some(function(e){return e.canUpdateCells()}),n=[],i=0,a=b.reversed(e);i<a.length;i++){var s=a[i];s.isStateless()||(s.exprKind!=v.CellRef||r)&&(s.canUpdateCells()&&(r=!0),n.push(s))}n.reverse(),k.isStackMachine()&&(n=[]);var o=[],l=e.map(function(e){if(0<=n.indexOf(e)){var t=e,r=e;return e.exprKind==v.SharedDef?(e.args[0].totalUses++,t=g.op(v.SharedRef,[e.args[0]])):(t=g.op(v.SharedRef,[e]),r=g.op(v.SharedDef,[e]),e.totalUses=2,e.currUses=0),o.push(r),t}return e});return{precomp:o,flattened:l}}g.Procedure=p,g.iterExpr=function e(t,r){if(r(t),t.args)for(var n=0,i=t.args;n<i.length;n++)e(i[n],r)},g.stmt=f,g.op=d,g.numlit=function(e){return d(v.NumberLiteral,null,e)},g.shared=function(e){switch(e.exprKind){case v.SharedRef:e=e.args[0];break;case v.NumberLiteral:return e}return d(v.SharedRef,[e])},g.ptrlit=function(e,t){var r=d(v.PointerLiteral,null,e);return r.jsInfo=t,r},g.rtcall=m,g.rtcallMask=function(e,t,r,n){b.startsWith(e,"@nomask@")&&(e=e.slice(8),t=0);var i=m(e,n,t);return i.callingConvention=r,i},g.flattenArgs=h})((k=x.pxtc||(x.pxtc={})).ir||(k.ir={}))}(ts||(ts={})),function(yr){!function(yt){var n,e,r=function(){function e(e,t){this.wave=e,this.id=t,this.flags=0,this.resetAll()}return e.prototype.refresh=function(){this.flags&=-9,!this.proc||this.usedActions||Rt(this.proc.action)?this.proc&&!this.proc.cachedJS?this.resetEmit():this.usedNodes&&(this.flags|=32):this.resetEmit(),this.classInfo&&this.classInfo.reset()},e.prototype.resetEmit=function(){this.flags&=-41,this.proc&&this.proc.classInfo&&this.proc.classInfo.ctor==this.proc&&(this.proc.classInfo.ctor=null),this.functionInfo=null,this.variableInfo=null,this.classInfo=null,this.callInfo=null,this.proc=null,this.cell=null,this.exprInfo=null,this.usedNodes=null,this.usedActions=null},e.prototype.resetTSC=function(){this.flags&=16,this.typeCache=null,this.symbolCache=null,this.commentAttrs=null,this.valueOverride=null,this.declCache=void 0,this.fullName=null,this.constantFolded=void 0},e.prototype.resetAll=function(){this.resetTSC(),this.resetEmit()},e}();function t(e){return e<<2|2}yt.PxtNode=r,(e=n||(n={}))[e.Enum=0]="Enum",e[e.Number=1]="Number",e[e.String=2]="String",e[e.Boolean=3]="Boolean",e[e.Unsupported=4]="Unsupported",yt.taggedUndefined=0,yt.taggedNull=t(1),yt.taggedFalse=t(2),yt.taggedNaN=t(3),yt.taggedTrue=t(16),yt.thumbArithmeticInstr={adds:!0,subs:!0,muls:!0,ands:!0,orrs:!0,eors:!0,lsls:!0,asrs:!0,lsrs:!0},yt.numberArithmeticInstr={div:!0,mod:!0,le:!0,lt:!0,ge:!0,gt:!0,eq:!0,neq:!0};var xt={"Array_::getAt":{name:"_pxt_array_get",argsFmt:["T","T","T"],value:0},"Array_::setAt":{name:"_pxt_array_set",argsFmt:["T","T","T","T"],value:0},"BufferMethods::getByte":{name:"_pxt_buffer_get",argsFmt:["T","T","T"],value:0},"BufferMethods::setByte":{name:"_pxt_buffer_set",argsFmt:["T","T","T","I"],value:0},"pxtrt::mapGetGeneric":{name:"_pxt_map_get",argsFmt:["T","T","S"],value:0},"pxtrt::mapSetGeneric":{name:"_pxt_map_set",argsFmt:["T","T","S","T"],value:0}},kt=yt.ir.EK;yt.SK=yr.SyntaxKind,yt.numReservedGlobals=1;var i=0,St=1;function Tt(e){if(e.pxt)return!!(16&e.pxt.flags);var t=yr.getSourceFileOfNode(e);return!!t&&yt.isPxtModulesFilename(t.fileName)}function wt(e){if(e.pxt)return(t=e.pxt).wave!=St&&(t.wave=St,yt.compileOptions&&yt.compileOptions.skipPxtModulesTSC&&16&t.flags?yt.compileOptions.skipPxtModulesEmit?t.refresh():t.resetEmit():t.resetAll()),t;var t=new r(St,++i);return Tt(e)&&(t.flags|=16),e.pxt=t}function Et(e){return wt(e).id}function It(e){return e?yr.SyntaxKind[e.kind]:"<null>"}function _t(e,t,r){void 0===r&&(r=!1);var n=new Error(t);if(n.ksEmitterUserError=!0,n.ksErrorCode=e,r&&Qt)return Jt||(Jt=t,Wt=e),n;throw n}function Kt(){return yt.target.isNative&&yt.target.nativeType==yt.NATIVE_TYPE_VM}function Nt(){return yt.target.isNative&&yt.target.nativeType!=yt.NATIVE_TYPE_VM}function Ct(){return yt.target.isNative&&yt.target.nativeType==yt.NATIVE_TYPE_THUMB}function Ut(e){return Nt()?yt.ir.rtcall("pxt::fromInt",[e]):e}function At(e){return Nt()?yt.ir.rtcall("pxt::fromBool",[e]):e}function Pt(e){switch(e){case 0:return yt.target.shortPointers?2:4;case 1:return 1;case 3:return 2;case 5:return 4;case 2:return 1;case 4:return 2;case 6:return 4;default:throw yt.oops()}}function a(e){switch(e){case 1:case 3:case 5:return!0;case 2:case 4:case 6:return!1;default:throw yt.oops()}}function Lt(e){switch(e.kind){case yt.SK.TemplateHead:case yt.SK.TemplateMiddle:case yt.SK.TemplateTail:case yt.SK.StringLiteral:case yt.SK.NoSubstitutionTemplateLiteral:return!0;default:return!1}}function Ft(e){return e&&e.modifiers&&e.modifiers.some(function(e){return e.kind==yt.SK.StaticKeyword})}function Dt(e){return e.modifiers&&e.modifiers.some(function(e){return e.kind==yt.SK.ReadonlyKeyword})}function Ot(e,t){return e.explicitDefaults?e.explicitDefaults.indexOf(t)<0?null:e.paramDefl[t]:null}function s(e){if(!e)return null;switch(e.kind){case yt.SK.MethodDeclaration:return"";case yt.SK.Constructor:return"new/";case yt.SK.GetAccessor:return"get/";case yt.SK.SetAccessor:return"set/";default:return null}}function Mt(e){return s(e)+er(e)}function Bt(e){return null!=s(e)}function Rt(e){for(var t=e,r=!1;;)switch((t=t.parent)||_t(9229,Ht("cannot determine parent of {0}",It(e))),t.kind){case yt.SK.MethodDeclaration:case yt.SK.Constructor:case yt.SK.GetAccessor:case yt.SK.SetAccessor:case yt.SK.FunctionDeclaration:case yt.SK.ArrowFunction:case yt.SK.FunctionExpression:return t;case yt.SK.WhileStatement:case yt.SK.DoStatement:case yt.SK.ForInStatement:case yt.SK.ForOfStatement:case yt.SK.ForStatement:r=!0;break;case yt.SK.SourceFile:return r?Gt:null}}function o(e){return"objectFlags"in e}function $t(e){return!!e&&(e.kind==yt.SK.VariableDeclaration||e.kind==yt.SK.BindingElement&&$t(e.parent.parent))}function qt(e){return!!e&&($t(e)&&!Rt(e)||e.kind==yt.SK.PropertyDeclaration&&Ft(e))}function jt(e){return!!e&&(e.kind==yt.SK.Parameter||e.kind==yt.SK.BindingElement&&jt(e.parent.parent))}yt.isInPxtModules=Tt,yt.pxtInfo=wt,yt.getNodeId=Et,yt.stringKind=It,yt.isStackMachine=Kt,yt.needsNumberConversions=Nt,yt.isThumb=Ct,yt.sizeOfBitSize=Pt,yt.isBitSizeSigned=a,yt.setCellProps=function(e){var t;if(e._isLocal=$t(t=e.def)&&!qt(t)||jt(e.def),e._isGlobal=qt(e.def),!e.def.isThisParameter){var r=lr(e.def);r.flags&yr.TypeFlags.Void&&yt.oops("void-typed variable, "+e.toString()),e.bitSize=function(e){if(!e||!e.type)return 0;if(!hr(lr(e)))return 0;if(e.type.kind!=yt.SK.TypeReference)return 0;switch(e.type.typeName.getText()){case"int8":return 1;case"int16":return 3;case"int32":return 5;case"uint8":return 2;case"uint16":return 4;case"uint32":return 6;default:return 0}}(e.def),0!=e.bitSize?e._debugType=(a(e.bitSize)?"int":"uint")+8*Pt(e.bitSize):mr(r)?e._debugType="string":r.flags&yr.TypeFlags.NumberLike&&(e._debugType="number")}e.isLocal()&&0!=e.bitSize&&(e.bitSize=0,_t(9256,Ht("bit sizes are not supported for locals and parameters")))},yt.isStatic=Ft,yt.isReadOnly=Dt,yt.getExplicitDefault=Ot,yt.isObjectType=o;var zt=function(){function e(e,t){this.id=e,this.decl=t,this.baseClassInfo=null,this.allfields=[],this.methods={},this.attrs=Xt(t),this.reset()}return e.prototype.reset=function(){this.vtable=null,this.itable=null},Object.defineProperty(e.prototype,"isUsed",{get:function(){return!!(8&wt(this.decl).flags)},enumerable:!0,configurable:!0}),e.prototype.allMethods=function(){for(var e=[],t=0,r=Object.keys(this.methods);t<r.length;t++)for(var n=r[t],i=0,a=this.methods[n];i<a.length;i++){var s=a[i];e.push(s)}return e},e.prototype.usedMethods=function(){for(var e=[],t=0,r=Object.keys(this.methods);t<r.length;t++)for(var n=r[t],i=0,a=this.methods[n];i<a.length;i++){var s=a[i];8&wt(s).flags&&e.push(s)}return e},e}();yt.ClassInfo=zt;var Vt,Gt,Jt,Ht=yt.assembler.lf,Wt=0,Qt=0;function Yt(e,t){var r=wt(t);return null==r.fullName&&(r.fullName=yt.getFullName(e,t.symbol)),r.fullName}function l(e){e.kind==yt.SK.VariableDeclaration&&(e=e.parent.parent);var t=function(e){var t=yr.getSourceFileOfNode(e);if(!t)return"";var r=yr.getLeadingCommentRangesOfNode(e,t);return r?r.map(function(e){return t.text.slice(e.pos,e.end)}).join("\n"):""};return e.symbol&&e.symbol.declarations&&1<e.symbol.declarations.length?e.symbol.declarations.map(t).join("\n"):t(e)}function Zt(e){for(var t="",r=0,n=e.declarations;r<n.length;r++){t+=l(n[r])}return yt.parseCommentString(t)}function Xt(e){var t=e?wt(e):null;if(!t||2&t.flags)return yt.parseCommentString("");if(t.commentAttrs)return t.commentAttrs;var r=yt.parseCommentString(l(e));return r._name=er(e),t.commentAttrs=r}function er(e){return e.name&&e.name.kind==yt.SK.Identifier?e.name.text:"???"}function tr(e){if(o(e)&&e.objectFlags&yr.ObjectFlags.Reference){var t=e;if(t.typeArguments&&t.typeArguments.length)return t.target}return null}function rr(e){return!!o(e)&&(e.objectFlags&yr.ObjectFlags.Reference&&e.symbol&&"Array"==e.symbol.name)}function nr(e){return!!o(e)&&(!!(e.objectFlags&yr.ObjectFlags.Interface)||!!(e.objectFlags&yr.ObjectFlags.Anonymous))}function ir(e){return!!e.isThisType||!!o(e)&&!!(e.objectFlags&yr.ObjectFlags.Class||e.symbol&&e.symbol.flags&yr.SymbolFlags.Class)}function ar(e){var t=tr(e);return ir(t||e)}function sr(e,t){return void 0===t&&(t=-1),rr(e)?c(e.typeArguments[0]):Vt.getIndexTypeOfType(e,yr.IndexKind.Number)}function c(e){return e}function or(e){return null===e?yt.taggedNull:void 0===e?yt.taggedUndefined:!1===e?yt.taggedFalse:!0===e?yt.taggedTrue:isNaN(e)?yt.taggedNaN:null}function lr(e){var t,r=wt(e);if(r.typeCache)return r.typeCache;if(yr.isExpression(e)&&(t=Vt.getContextualType(e)),!t)try{t=Vt.getTypeAtLocation(e)}catch(e){_t(9203,Ht("Unknown type for expression"))}return t?c(r.typeCache=t):t}function u(e){if(!(e.flags&yr.TypeFlags.Union))return n.Unsupported;var t,r=!0;return e.types.forEach(function(e){if(void 0===t)e.flags&yr.TypeFlags.NumberLike?t=n.Number:e.flags&yr.TypeFlags.BooleanLike?t=n.Boolean:e.flags&yr.TypeFlags.StringLike?t=n.String:e.flags&yr.TypeFlags.EnumLike&&(t=n.Enum);else switch(t){case n.Number:r=r&&!!(e.flags&yr.TypeFlags.NumberLike);break;case n.Boolean:r=r&&!!(e.flags&yr.TypeFlags.BooleanLike);break;case n.String:r=r&&!!(e.flags&yr.TypeFlags.StringLike);break;case n.Enum:r=r&&!!(e.flags&yr.TypeFlags.EnumLike)}}),r?t:n.Unsupported}function cr(e){var t=Vt.getSignatureFromDeclaration(e);return!(Vt.getReturnTypeOfSignature(t).flags&yr.TypeFlags.Void)}function ur(e){var t,r=(t=e)&&t.name?e.name.text:null;return r||(r=e.kind==yt.SK.Constructor?"constructor":"inline"),function e(t){if(!t)return"";switch(t.kind){case yt.SK.ModuleBlock:return e(t.parent);case yt.SK.ClassDeclaration:case yt.SK.ModuleDeclaration:return e(t.parent)+t.name.text+".";default:return""}}(e.parent)+r}function pr(e){return ur(e).replace(/[^\w]+/g,"_")}function fr(e){return pr(e)+"__P"+Et(e)}yt.getNodeFullName=Yt,yt.getComments=l,yt.parseCommentsOnSymbol=Zt,yt.parseComments=Xt,yt.getName=er,yt.checkType=c,yt.taggedSpecial=or,yt.getDeclName=ur,yt.getFunctionLabel=fr;var dr=function(){function e(e){this.decl=e,this.capturedVars=[]}return Object.defineProperty(e.prototype,"isUsed",{get:function(){return!!(8&wt(this.decl).flags)},enumerable:!0,configurable:!0}),e}();function p(e,t,r){return!!(e.flags&t)||u(e)===r}function mr(e){return p(e,yr.TypeFlags.String|yr.TypeFlags.StringLiteral,n.String)}function hr(e){return p(e,yr.TypeFlags.Number|yr.TypeFlags.NumberLiteral,n.Number)}yt.FunctionAddInfo=dr,yt.compileBinary=function(e,g,L,t){yt.compilerHooks.preBinary&&yt.compilerHooks.preBinary(e,g,L),yt.target=g.target,yt.compileOptions=g,yt.target.debugMode=!!g.breakpoints;var o=yr.createDiagnosticCollection();Vt=e.getTypeChecker();var r=yt.U.cpuUs(),U=[],n=[],v={},c={},b=null,A=null,p=!1,a=[];if(St++,g.target.isNative){if(!g.hexinfo)return{diagnostics:[{file:e.getSourceFiles()[0],start:0,length:0,category:yt.DiagnosticCategory.Error,code:9043,messageText:Ht("The hex file is not available, please connect to internet and try again.")}],emittedFiles:[],emitSkipped:!0};yt.hex.setupFor(g.target,g.extinfo||yt.emptyExtInfo(),g.hexinfo),yt.hex.setupInlineAssembly(g)}var F,D=new gr;function i(){D.reset(),F=null,L.breakpoints=[{id:0,isDebuggerStmt:!1,fileName:"bogus",start:0,length:0,line:0,column:0}]}D.res=L,D.options=g,D.target=g.target,g.computeUsedSymbols&&(L.usedSymbols={},L.usedArguments={});var s=[];g.forceEmit&&0!=L.diagnostics.length||e.getSourceFiles().forEach(function(e){e.statements.forEach(function(e){s.push(e)})});var l=e.getSourceFiles().filter(function(e){return yt.Util.endsWith(e.fileName,t)})[0],u={kind:yt.SK.FunctionDeclaration,parameters:[],name:{text:"<main>",pos:0,end:0},body:{kind:yt.SK.Block,statements:s},parent:l,pos:0,end:0},f=wt(Gt=u);for(f.flags|=3,ae(u),U=[],i(),p=!0,gt(u);we(),!$(););!function(){var e=D.globals.slice(0);e.forEach(function(e,t){return e.index=t});var r=function(e){return 0==e?10:Pt(e)};e.sort(function(e,t){return r(e.bitSize)-r(t.bitSize)||e.index-t.index});for(var t=4*yt.numReservedGlobals,n=0,i=0,a=e;i<a.length;i++){for(var s=a[i],o=Pt(s.bitSize);t&o-1;)t++;n||0!=s.bitSize||(n=t),s.index=t,t+=o}D.globalsWords=t+3>>2,D.nonPtrGlobals=n?n>>2:D.globalsWords}(),p=!1,function(){for(var e=0,t=D.usedClassInfos;e<t.length;e++){var r=t[e];q(r)}var n=Object.keys(D.ifaceMemberMap);n.sort(yt.U.strcmp),n.unshift(""),D.emitString(""),D.ifaceMembers=n,D.ifaceMemberMap={};for(var i=0,a=0,s=n;a<s.length;a++){var o=s[a];D.ifaceMemberMap[o]=i++}for(var l=0,c=D.usedClassInfos;l<c.length;l++)for(var r=c[l],u=0,p=r.itable;u<p.length;u++){var f=p[u];f.idx=R(f.name)}for(var d=0,m=D.usedClassInfos;d<m.length;d++){var r=m[d];r.lastSubtypeNo=void 0,r.classNo=void 0}for(var h=pxt.BuiltInType.User0,g=function(e){yt.U.assert(!e.classNo),e.classNo=h++;for(var t=0,r=e.derivedClasses;t<r.length;t++){var n=r[t];n.isUsed&&g(n)}e.lastSubtypeNo=h-1},v=0,b=D.usedClassInfos;v<b.length;v++){for(var r=b[v],y=r;y.baseClassInfo;)y=y.baseClassInfo;y.classNo||g(y)}}();var d=yt.U.cpuUs();L.times.pass0=d-r;var m=o.getDiagnostics();i(),p=!1,D.finalPass=!0,vt(u),yt.U.assert(0==U.length),L.configData=[];for(var h=0,y=Object.keys(c);h<y.length;h++){var x=y[h];c["!"+x]||L.configData.push({name:x.replace(/^\!/,""),key:c[x].key,value:c[x].value})}L.configData.sort(function(e,t){return e.key-t.key});var k=yt.U.cpuUs();if(L.times.pass1=k-d,dt(u,function(){if(!g.noEmit){D.writeFile=function(e,t){L.outfiles[e]=t};for(var e=0,t=D.procs;e<t.length;e++){var r=t[e];r.cachedJS&&!r.inlineBody||r.resolve()}yt.target.isNative&&(D.procs=D.procs.filter(function(e){return!(e.inlineBody&&!e.info.usedAsIface&&!e.info.usedAsValue)})),g.target.isNative?(g.extinfo.yotta&&D.writeFile("yotta.json",JSON.stringify(g.extinfo.yotta,null,2)),g.extinfo.platformio&&D.writeFile("platformio.json",JSON.stringify(g.extinfo.platformio,null,2)),g.target.nativeType==yt.NATIVE_TYPE_VM?yt.vmEmit(D,g):yt.processorEmit(D,g,L)):yt.jsEmit(D)}}),L.times.passFinal=yt.U.cpuUs()-k,g.ast){var S=yt.U.cpuUs();yt.annotate(e,t,yt.target),L.times.passAnnotate=yt.U.cpuUs()-S}return yt.compileOptions=null,0==m.length&&(m=o.getDiagnostics()),yt.compilerHooks.postBinary&&yt.compilerHooks.postBinary(e,g,L),{diagnostics:m,emittedFiles:void 0,emitSkipped:!!g.noEmit};function T(e,t,r,n,i,a,s){o.add(yr.createDiagnosticForNode(t,{code:r,message:n,key:n.replace(/^[a-zA-Z]+/g,"_"),category:e},i,a,s))}function w(e,t,r,n,i,a){T(yt.DiagnosticCategory.Error,e,t,r,n,i,a)}function O(e,t,r){if(void 0===r&&(r=9202),t)return _t(r,t);e||_t(r,Ht("Sorry, this language feature is not supported"));var n=It(e),i=!1,a=null;switch(e.kind){case yr.SyntaxKind.ForInStatement:n=Ht("for in loops");break;case yr.SyntaxKind.ForOfStatement:n=Ht("for of loops"),i=!0;break;case yr.SyntaxKind.PropertyAccessExpression:n=Ht("property access");break;case yr.SyntaxKind.DeleteExpression:n=Ht("delete");break;case yr.SyntaxKind.GetAccessor:n=Ht("get accessor method"),i=!0;break;case yr.SyntaxKind.SetAccessor:n=Ht("set accessor method"),i=!0;break;case yr.SyntaxKind.TaggedTemplateExpression:n=Ht("tagged templates");break;case yr.SyntaxKind.SpreadElement:n=Ht("spread");break;case yr.SyntaxKind.TryStatement:case yr.SyntaxKind.CatchClause:case yr.SyntaxKind.FinallyKeyword:case yr.SyntaxKind.ThrowStatement:n=Ht("throwing and catching exceptions");break;case yr.SyntaxKind.ClassExpression:n=Ht("class expressions"),a=Ht("declare a class as class C {} not let C = class {}")}var s="";return s=i?Ht("{0} not currently supported",n):Ht("{0} not supported",yr.SyntaxKind[e.kind]),a&&(s+=" - "+a),_t(r,s)}function E(e){return Et(e)+""}function M(e){var t=wt(e);return t.functionInfo||(t.functionInfo=new dr(e)),t.functionInfo}function P(e){var t=wt(e);return t.variableInfo||(t.variableInfo={}),t.variableInfo}function I(e,t){void 0===t&&(t=!1);var r=P(e);t&&(r.written=!0);var n=Rt(e);if(null==n||n==F.action);else{for(var i=F.action;i&&i!=n;){var a=M(i);a.capturedVars.indexOf(e)<0&&a.capturedVars.push(e),i=Rt(i)}r.captured=!0}}function B(e){var t=e(D);return p&&D.recordAction(A,e),t}function R(r,n){return void 0===n&&(n=!1),B(function(e){n&&(yt.U.lookup(e.explicitlyUsedIfaceMembers,r)||(yt.U.assert(!e.finalPass),e.explicitlyUsedIfaceMembers[r]=!0));var t=yt.U.lookup(e.ifaceMemberMap,r);return null!=t||(yt.U.assert(!e.finalPass),t=e.ifaceMemberMap[r]=-1,e.emitString(r)),t})}function _(e){e.flags&yr.TypeFlags.Void&&_t(9203,Ht("void-typed variables not supported"))}function K(e){var t=wt(e);_(lr(e)),t.cell||(t.cell=new yt.ir.Cell(null,e,P(e))),D.globals.indexOf(t.cell)<0&&D.globals.push(t.cell)}function N(e){if(qt(e)){ae(e);var t=wt(e);return t.cell||K(e),t.cell}var r=F.localIndex(e);return r||(D.finalPass?_t(9204,Ht("cannot locate identifer")):r=F.mkLocal(e,P(e))),r}function C(e){return e.kind==yt.SK.MethodDeclaration&&0==e.parameters.length&&"toString"==er(e)}function $(){p=!1;for(var e,t=D.usedClassInfos.length,r=0,n=D.usedClassInfos;r<n.length;r++){for(var i=n[r],a=0,s=i.allMethods();a<s.length;a++){var o=s[a],l=wt(o),c=M(o);8&l.flags?c.virtualParent&&se(c.virtualParent.decl):c.virtualParent&&c.virtualParent.isUsed?se(o):(C(o)||(e=er(o),null!=yt.U.lookup(D.explicitlyUsedIfaceMembers,e)))&&se(o)}var u=ye(i.decl);u&&se(u)}return p=!0,0==U.length&&t==D.usedClassInfos.length}function q(s){if(yt.assert(s.isUsed,"inf.isUsed"),s.vtable)return s.vtable;var e=s.baseClassInfo?q(s.baseClassInfo).slice(0):[];s.derivedClasses=[],s.baseClassInfo&&s.baseClassInfo.derivedClasses.push(s);for(var t=0,r=s.usedMethods();t<r.length;t++){var n=r[t];D.numMethods++;var i=M(n),a=Xt(n);if(C(n)&&!a.shim&&(s.toStringMethod=ve(n),s.toStringMethod.info.usedAsIface=!0),i.virtualParent){D.numVirtMethods++;var o=Mt(n),l=!1,c=ve(n);yt.U.assert(!!c);for(var u=0;u<e.length;++u)Mt(e[u].action)==o&&(e[u]=c,i.virtualIndex=u,l=!0);l||(i.virtualIndex=e.length,e.push(c))}}s.vtable=e,s.itable=[];for(var p=0,f=s.allfields;p<f.length;p++){var d=f[p],m=er(d),h=Oe(s,d,!1);s.itable.push({name:m,info:(h.idx+1)*(Kt()?1:4),idx:R(m),proc:null})}for(var g=s;g;g=g.baseClassInfo)for(var v=function(e){var t=er(e);if(Xt(e).shim)return"continue";var r=ve(e),n=s.itable.find(function(e){return e.name==t}),i=e.kind==yt.SK.SetAccessor,a=e.kind==yt.SK.GetAccessor;n?i&&!n.setProc?n.setProc=r:a&&!n.proc&&(n.proc=r):s.itable.push({name:t,info:0,idx:R(t),proc:i?null:r,setProc:i?r:null}),r.info.usedAsIface=!0},b=0,y=g.usedMethods();b<y.length;b++)v(n=y[b]);return s.vtable}function j(e){if(32&e.flags||16&e.flags&&yt.compileOptions.skipPxtModulesEmit)throw L.needsFullRecompile=!0,_t(9200,Ht("full recompile required"))}function z(e,t){void 0===t&&(t=null),t||(t=e.symbol.valueDeclaration);var r=wt(t);if(!r.classInfo){var n=pr(t)+"__C"+Et(t),i=new zt(n,t);(r.classInfo=i).attrs.autoCreate&&(v[i.attrs.autoCreate]=!0),i.baseClassInfo=function(e){if(e.heritageClauses)for(var t=0,r=e.heritageClauses;t<r.length;t++){var n=r[t];switch(n.token){case yt.SK.ExtendsKeyword:if(!n.types||1!=n.types.length)throw _t(9228,Ht("invalid extends clause"));var i=lr(n.types[0]);if(!i||!ir(i)||(a=tr(i))&&a.typeParameters&&a.typeParameters.length)throw _t(9228,Ht("cannot inherit from this type"));return Vt.getTypeAtLocation(e),z(i);case yt.SK.ImplementsKeyword:break;default:throw _t(9228,Ht("invalid heritage clause"))}}var a;return null}(t);for(var a=i.baseClassInfo?yt.U.toDictionary(i.baseClassInfo.allfields,function(e){return er(e)}):{},s=function(e,t){return void 0===t&&(t=i.baseClassInfo),t?t.methods[e]||s(e,t.baseClassInfo):null},o=0,l=t.members;o<l.length;o++){var c=l[o];if(c.kind==yt.SK.PropertyDeclaration){var u=c;Ft(u)||i.allfields.push(u);var p=er(u);(s(p)||yt.U.lookup(a,p))&&w(u,9279,Ht("redefinition of '{0}' as field",p))}else if(c.kind==yt.SK.Constructor)for(var f=0,d=c.parameters;f<d.length;f++){var m=d[f];vr(m)&&i.allfields.push(m)}else if(Bt(c)){M(c).parentClassInfo=i,p=er(c),i.methods.hasOwnProperty(p)||(i.methods[p]=[]),i.methods[p].push(c);var h=yt.U.lookup(a,p);if(h){var g=wt(h);64&g.flags||(g.flags|=64,8&g.flags&&R(p,!0),j(g))}}}i.baseClassInfo&&(i.allfields=i.baseClassInfo.allfields.concat(i.allfields),function(e){for(var t=0,r=e.allMethods();t<r.length;t++){for(var n=r[t],i=null,a=Mt(n),s=er(n),o=e.baseClassInfo;o;o=o.baseClassInfo)if(o.methods.hasOwnProperty(s))for(var l=0,c=o.methods[s];l<c.length;l++){var u=c[l];Mt(u)==a&&(i=u)}if(i){var p=M(n),f=M(i);i.parameters.length!=n.parameters.length&&w(n,9255,Ht("the overriding method is currently required to have the same number of arguments as the base one")),(p.virtualParent=f).virtualParent||(j(wt(i)),f.virtualParent=f),yt.assert(f.virtualParent==f,"pinf.virtualParent == pinf")}}}(i))}return r.classInfo}function V(e){if(!e)return!1;if(Lt(e))return!1;switch(e.kind){case yt.SK.ArrayLiteralExpression:return e.elements.some(V);default:return null==ze(e)}}function G(e){var t=je(e);if(t)return We(t.val);if(qt(e)&&Xt(e).shim)return fe(e,e,[]);var r=N(e);return I(e),r.load()}function J(e){Xt(e).shim&&_t(9207,Ht("built-in functions cannot be yet used as values; did you forget ()?"));var t=M(e);return H(t),t.location?t.location.load():(yt.assert(!D.finalPass||0==t.capturedVars.length,"!bin.finalPass || info.capturedVars.length == 0"),t.usedAsValue=!0,se(e),Te(e))}function H(e){void 0===e.usedBeforeDecl?e.usedBeforeDecl=!0:D.finalPass&&e.usedBeforeDecl&&e.capturedVars.length&&Rt(e.decl)&&!e.alreadyEmitted&&_t(9278,Ht("function referenced before all variables it uses are defined"))}function W(e){var t=ce(e),r=je(t);if(r)return We(r.val);if(t&&($t(t)||jt(t)))return G(t);if(t&&t.kind==yt.SK.FunctionDeclaration)return J(t);if("undefined"==e.text)return We(void 0);throw O(e,Ht("Unknown or undeclared identifier"),9235)}function Q(e){var t=function e(t){return t?Bt(t)?t:e(t.parent):null}(e);t||_t(9208,Ht("'this' used outside of a method"));var r=M(t);return r.thisParameter||yt.oops("no this"),G(r.thisParameter)}function Y(e){var t,r;if(""==e)t=yt.ir.rtcall("String_::mkEmpty",[]);else{var n=(r=e,B(function(e){return e.emitString(r)}));t=yt.ir.ptrlit(n,JSON.stringify(e))}return t.isStringLiteral=!0,t}function Z(e){var t=ue(e),r=mt(e);return yt.target.isNative||Lt(e)?Fe(r,t):Fe(r=yt.ir.rtcallMask("String_::stringConv",1,1,[r]),!0)}function X(e){for(var n=0,t=function(e,t){return Lt(r=t)&&""==r.text?e:(n++,Ze("String_::concat",[Fe(e,!0),Z(t)],null));var r},r=wt(Z(e.head)).valueOverride,i=0,a=e.templateSpans;i<a.length;i++){var s=a[i];r=t(r=t(r,s.expression),s.literal)}return 0==n?Ze("String_::concat",[Fe(r,!0),Fe(yt.ir.rtcall("String_::mkEmpty",[]),!1)],null):r}function ee(e){var t=ce(e),r=je(t);if(r)return We(r.val);if(t.kind==yt.SK.GetAccessor)return me(e,e,[],null);if(t.kind==yt.SK.EnumMember)throw _t(9210,Ht("Cannot compute enum value"));if(t.kind==yt.SK.PropertySignature||t.kind==yt.SK.PropertyAssignment)return me(e,e,[],null,t,e.expression);if(t.kind==yt.SK.PropertyDeclaration||t.kind==yt.SK.Parameter){if(Ft(t))return G(t);if(te(t))return me(e,e,[],null,t,e.expression);var n=function(e){var t=lr(e.expression);if(ar(t)){var r=z(t),n=e.expression.kind==yt.SK.ThisKeyword;return yt.target.switches.noThisCheckOpt&&(n=!1),Oe(r,Me(r,e.name.text),!n)}throw O(e,Ht("bad field access"),9247)}(e);return yt.ir.op(kt.FieldAccess,[mt(e.expression)],n)}if(Bt(t)||t.kind==yt.SK.MethodSignature)throw _t(9211,Ht("cannot use method as lambda; did you forget '()' ?"));if(t.kind==yt.SK.FunctionDeclaration)return J(t);if($t(t))return G(t);throw O(e,Ht("Unknown property access for {0}",It(t)),9237)}function te(e){if(e.kind==yt.SK.Parameter||e.kind==yt.SK.PropertyDeclaration){var t=wt(e);return!!yt.target.switches.slowFields||!!(64&t.flags)}return!1}function re(e,t){void 0===t&&(t=null);var r=lr(e.expression),n={callingConvention:0,paramDefl:{}},i=null,a=!1;if(!t&&mr(r)?i="String_::charAt":rr(r)?i=t?"Array_::setAt":"Array_::getAt":nr(r)&&(n=Zt(r.symbol),i=t?n.indexerSet:n.indexerGet),!i&&r.flags&(yr.TypeFlags.Any|yr.TypeFlags.StructuredOrTypeVariable)&&(i=t?"pxtrt::mapSetGeneric":"pxtrt::mapGetGeneric",a=!0),i){if(a||Qe(e.argumentExpression))return Ze(i,[e.expression,e.argumentExpression],n,t?[t]:[]);throw O(e,Ht("non-numeric indexer on {0}",i),9238)}throw O(e,Ht("unsupported indexer"),9239)}function ne(e){var t,r,n=!(!qt(r=e)||V(r.initializer)&&!Xt(r).whenUsed)||(t=e).kind==yt.SK.FunctionDeclaration&&!Rt(t)||Bt(t)||yr.isClassDeclaration(e);return!yt.target.switches.noTreeShake&&!(g.testMode&&n&&!Tt(e))&&n}function ie(e){if(!ne(e))return!0;var t=wt(e);return D.finalPass?!!(8&t.flags):t==A}function ae(e){if(e){var t=wt(e);t.classInfo?xe(t.classInfo):(g.computeUsedSymbols&&e.symbol&&(L.usedSymbols[Yt(Vt,e)]=null),Kt()&&Bt(e)&&R(er(e),!0),oe(e),8&t.flags||(t.flags|=8,ne(e)&&U.push(e)))}}function se(e){ae(e)}function oe(e){p&&(A?A.usedNodes[E(e)]=e:yt.U.oops("no using ctx for: "+er(e)))}function le(e){if(!e)return null;var t=wt(e);if(void 0!==t.declCache)return t.declCache;var r,n=Vt.getSymbolAtLocation(e);if(n&&!(r=n.valueDeclaration)&&n.declarations){var i=n.declarations[0];i&&i.kind==yr.SyntaxKind.ImportEqualsDeclaration&&(n=Vt.getSymbolAtLocation(i.moduleReference))&&(r=n.valueDeclaration)}return r}function ce(e){var t=le(e);if(ae(t),!t&&e&&e.kind==yt.SK.PropertyAccessExpression){var r=e;wt(t={kind:yt.SK.PropertySignature,symbol:{isBogusSymbol:!0,name:r.name.getText()},name:r.name}).flags|=2}return f.declCache=t||null,t}function ue(e){return e.kind==yt.SK.NullKeyword||e.kind==yt.SK.NumericLiteral?!!e.isRefOverride:!Lt(e)}function pe(e){yt.assert(e.length<=8,"args.length <= 8");var r=0;return e.forEach(function(e,t){ue(e)&&(r|=1<<t)}),r}function fe(e,t,r){var n,i,a,s=Xt(e),o=!(lr(t).flags&yr.TypeFlags.Void),l=s.shim;if(0<=l.indexOf("(")){var c=/(.*)\((.*)\)$/.exec(l);if(c){r.length&&yt.U.userError("no arguments expected");var u=[];if(c[2].replace(/\s/g,"")){for(var p=0,f=c[2].split(/,/);p<f.length;p++){var d=f[p],m=parseInt(d);isNaN(m)&&(null==(m=Je(t,d))&&(a=void 0,null==(a=Ge(n=t,i=d,"userconfig"))&&(a=Ge(n,i,"config")),m=a),null==m&&yt.U.userError("invalid argument: "+d+" in "+l)),u.push(yt.ir.numlit(m))}4<u.length&&yt.U.userError("too many args")}return l=c[1],g.target.isNative&&yt.hex.validateShim(ur(e),l,s,!0,u.map(function(e){return!0})),yt.ir.rtcallMask(l,0,s.callingConvention,u)}}return"TD_NOOP"==l?(yt.assert(!o,"!hasRet"),yt.target.switches.profile&&"perfCounter"==s.shimArgument&&(r[0]&&r[0].kind==yt.SK.StringLiteral&&(F.perfCounterName=r[0].text),F.perfCounterName||(F.perfCounterName=F.getFullName())),We(void 0)):"TD_ID"==l||"ENUM_GET"===l?(yt.assert(1==r.length,"args.length == 1"),mt(r[0])):(g.target.isNative&&yt.hex.validateShim(ur(e),l,s,o,r.map(Qe)),Ze(l,r,s))}function de(e,i,a){if(e){var t=e.getParameters(),r=i.length;t.length>i.length&&t.slice(i.length).forEach(function(e){if(e.valueDeclaration&&e.valueDeclaration.kind==yt.SK.Parameter){var t=e.valueDeclaration;if(t.initializer)(function(e){switch(e.kind){case yt.SK.UndefinedKeyword:case yt.SK.NullKeyword:case yt.SK.TrueKeyword:case yt.SK.FalseKeyword:case yt.SK.NumericLiteral:return!0;case yt.SK.PropertyAccessExpression:return mt(e).exprKind==kt.NumberLiteral;default:return!1}})(t.initializer)||_t(9212,Ht("only numbers, null, true and false supported as default arguments")),i.push(t.initializer);else{var r=Ot(a,er(t)),n=r?We(parseInt(r)):null;null==n&&(n=We(void 0)),i.push(Fe(n))}}else _t(9213,Ht("unsupported default argument (shouldn't happen)"))});for(var n=0;n<r;n++){var s=t[n];s&&s.valueDeclaration&&s.valueDeclaration.kind==yt.SK.Parameter&&(i[n],s.valueDeclaration)}a.imageLiteral&&(Lt(i[0])||_t(9214,Ht("Only image literals (string literals) supported here; {0}",It(i[0]))),i[0]=function(e){e||(e="0 0 0 0 0\n0 0 0 0 0\n0 0 0 0 0\n0 0 0 0 0\n0 0 0 0 0\n");var t=0,r=0,n=0,i="",a=0;e+="\n";for(var s=0;s<e.length;++s)switch(e[s]){case".":case"_":case"0":i+="0,",t++,a++;break;case"#":case"*":case"1":i+="255,",t++,a++;break;case"\t":case"\r":case" ":break;case"\n":t&&(0==r?r=t:t!=r&&_t(9205,Ht("lines in image literal have to have the same width (got {0} and then {1} pixels)",r,t)),t=0,n++);break;default:_t(9206,Ht("Only 0 . _ (off) and 1 # * (on) are allowed in image literals"))}var o="_img"+D.lblNo++;a%2!=0&&(i+="0"),D.otherLiterals.push("\n.balign 4\n"+o+": .short 0xffff\n        .short "+r+", "+n+"\n        .byte "+i+"\n");var l="new pxsim.Image("+r+", ["+i+"])";return{kind:yt.SK.NumericLiteral,imageLiteral:o,jsLit:l}}(i[0].text))}}function me(e,t,r,n,i,a){void 0===i&&(i=null),void 0===a&&(a=null),i||(i=ce(t));var s=!1,o=!1,l=!1,c=e===t;if(i)switch(i.kind){case yt.SK.PropertySignature:case yt.SK.PropertyAssignment:case yt.SK.PropertyDeclaration:case yt.SK.MethodSignature:s=!0;break;case yt.SK.Parameter:vr(i)&&(s=!0);break;case yt.SK.GetAccessor:case yt.SK.SetAccessor:case yt.SK.MethodDeclaration:o=s=!0,l=Ft(i);break;case yt.SK.FunctionDeclaration:l=!0;break;case yt.SK.ModuleDeclaration:break;default:i=null}else t.kind==yt.SK.PropertyAccessExpression&&(s=!0);yt.target.switches.slowMethods&&(o=!1);var u=Xt(i),p=r.slice(0);if(s&&Ft(i)&&(s=!1),s&&!a&&t.kind==yt.SK.PropertyAccessExpression&&(a=t.expression),L.usedArguments&&u.trackArgs){var f=a?[a].concat(p):p,d=u.trackArgs.map(function(e){return f[e]}).map(function(e){var t=ce(e);return!t||t.kind!=yt.SK.EnumMember&&t.kind!=yt.SK.VariableDeclaration?e&&e.kind==yt.SK.StringLiteral?e.text:"*":Yt(Vt,t)}).join(","),m=Yt(Vt,i),h=L.usedArguments[m];h||(h=L.usedArguments[m]=[]),h.indexOf(d)<0&&h.push(d)}function g(){var e=be(i,p.map(function(e){return mt(e)})),t=e.data;return p[0]&&t.proc&&t.proc.classInfo&&(t.isThis=p[0].kind==yt.SK.ThisKeyword),e}if(de(n,p,u),l&&!(k=M(i)).location)return u.shim&&!Ce(i)?fe(i,e,p):(se(i),g());if(t.kind==yt.SK.SuperKeyword){for(var v=F.classInfo.baseClassInfo.ctor,b=F.classInfo.baseClassInfo;b&&!v;b=b.baseClassInfo)v=b.ctor;if(!v&&D.finalPass)throw _t(9280,Ht("super() call requires an explicit constructor in base class"));var y=p.map(function(e){return mt(e)});return y.unshift(Q(t)),he(v,y)}if(s){if(yt.U.assert(!Ft(i)),a?p.unshift(a):O(e,Ht("strange method call"),9241),!i){yt.U.assert(t.kind==yt.SK.PropertyAccessExpression);var x=t.name.text;return ge(p.map(function(e){return mt(e)}),{ifaceIndex:R(x,!0),noArgs:c})}var k;if((k=M(i)).parentClassInfo&&xe(k.parentClassInfo),se(i),a.kind==yt.SK.SuperKeyword)return g();var S=!!k.virtualParent,T=!!Kt()||!!yt.target.switches.slowMethods;if(S&&!T)return i.kind==yt.SK.MethodDeclaration?yt.U.assert(!c):i.kind==yt.SK.GetAccessor||i.kind==yt.SK.SetAccessor?yt.U.assert(c):yt.U.assert(!1),yt.U.assert(!D.finalPass||null!=k.virtualIndex,"!bin.finalPass || info.virtualIndex != null"),ge(p.map(function(e){return mt(e)}),{classInfo:k.parentClassInfo,virtualIndex:k.virtualIndex,noArgs:c,isThis:p[0].kind==yt.SK.ThisKeyword});if(u.shim&&!Ce(i))return fe(i,e,p);if(u.helper){for(var w=void 0,E=0,I=Vt.getSymbolsInScope(e,yr.SymbolFlags.Module);E<I.length;E++){var _=I[E];if("helpers"==_.name)for(var K=0,N=_.declarations||[_.valueDeclaration];K<N.length;K++){var C=N[K];if(C.kind==yt.SK.ModuleDeclaration)for(var U=0,A=C.body.statements;U<A.length;U++){var P=A[U];P.symbol.name==u.helper&&(w=P)}}}return w||_t(9215,Ht("helpers.{0} not found",u.helper)),w.kind!=yt.SK.FunctionDeclaration&&_t(9216,Ht("helpers.{0} isn't a function",u.helper)),se(i=w),g()}return S||yt.target.switches.slowMethods||!o?ge(p.map(function(e){return mt(e)}),{ifaceIndex:R(er(i),!0),isSet:c&&2==p.length,noArgs:c}):(yt.U.assert(i.kind!=yt.SK.MethodSignature),g())}return i&&i.kind==yt.SK.ModuleDeclaration&&("String"==er(i)?_t(9219,Ht('to convert X to string use: X + ""')):_t(9220,Ht("namespaces cannot be called directly"))),p.unshift(t),yt.U.assert(!c),ge(p.map(function(e){return mt(e)}),{virtualIndex:-1,noArgs:c})}function he(e,t){yt.U.assert(!D.finalPass||!!e);var r={proc:e,virtualIndex:null,ifaceIndex:null};return yt.ir.op(kt.ProcCall,t,r)}function ge(e,t){return yt.ir.op(kt.ProcCall,e,t)}function ve(e){return wt(e).proc}function be(e,t){var r=ve(e);return e.kind==yt.SK.FunctionDeclaration&&H(M(e)),yt.assert(!!r||!D.finalPass,"!!proc || !bin.finalPass"),he(r,t)}function ye(e){return e.members.filter(function(e){return e.kind==yt.SK.Constructor})[0]}function xe(e){oe(e.decl),e.isUsed||(wt(e.decl).flags|=8,e.baseClassInfo&&xe(e.baseClassInfo),D.usedClassInfos.push(e))}function ke(c){function h(e){return/^[0-9a-f]$/i.test(e)}var e=ce(c.tag);if(!e)throw O(c,Ht("invalid tagged template"),9265);var t,u=Xt(e),r={decl:e,qName:e?Yt(Vt,e):"?",args:[c.template],isExpression:!0};function n(e){if(c.template.kind!=yt.SK.NoSubstitutionTemplateLiteral)throw O(c,Ht("substitution not supported in hex literal",u.shim),9265);t=function(e,t){var r=b;if("_"==t[0]&&"_"==t[1]&&g.jres[t]&&(r=g.jres[t],t=""),""==t&&r){var n=/font\/x-mkcd-b(\d+)/.exec(r.mimeType);if(n)if(D.finalPass){for(var i=parseInt(n[1]),a=atob(r.data),s=D.usedChars,o="",l=0;l<a.length;l+=i){var c=a.charCodeAt(l)+(a.charCodeAt(l+1)<<8);(c<128||s[c>>5]&1<<(31&c))&&(o+=a.slice(l,l+i))}t=yt.U.toHex(yt.U.stringToUint8Array(o))}else t="aabbccdd";else r.dataEncoding&&"base64"!=r.dataEncoding?"hex"==r.dataEncoding?t=r.data:_t(9271,Ht("invalid jres encoding '{0}' on '{1}'",r.dataEncoding,r.id)):t=yt.U.toHex(yt.U.stringToUint8Array(yr.pxtc.decodeBase64(r.data)))}if(/^e[14]/i.test(t)&&e.parent&&e.parent.kind==yt.SK.CallExpression&&"image.ofBuffer"==e.parent.expression.getText()){var u=/^e([14])(..)(..)..(.*)/i.exec(t);t="870"+u[1]+u[2]+"00"+u[3]+"000000"+u[4]}for(var p="",f=0;f<t.length;++f){var d=t[f];if(!h(d)){if(/^[\s\.]$/.test(d))continue;throw O(e,Ht("invalid character in hex literal '{0}'",d),9265)}h(t[f+1])&&(p+=d+t[f+1],f++)}if(yt.target.isNative){var m=D.emitHexLiteral(p.toLowerCase());return yt.ir.ptrlit(m,m)}return m="_hex"+E(e),yt.ir.ptrlit(m,{hexlit:p.toLowerCase()})}(c,e(c.template.text))}switch(wt(c).callInfo=r,u.shim){case"@hex":n(function(e){return e});break;case"@f4":n(function(e){if(!Array.isArray(u.groups))throw O(c,Ht("missing groups in @f4 literal"),9272);var r=[],t=[],a={},n=0;u.groups.forEach(function(e,t){for(var r=0,n=e;r<n.length;r++){var i=n[r];a[i]=t}}),e+="\n";for(var i=0;i<e.length;++i){var s=e[i];switch(s){case" ":case"\t":break;case"\n":0<t.length&&(r.push(t),n=Math.max(t.length,n),t=[]);break;default:var o=yt.U.lookup(a,s);if(null==o){if(2!=u.groups.length)throw O(c,Ht("invalid character in image literal: '{0}'",o),9273);o=1}t.push(o)}}var l=8;return u.groups.length<=2?l=1:u.groups.length<=16&&(l=4),yt.f4EncodeImg(n,r.length,l,function(e,t){return r[t][e]||0})});break;default:throw O(c,Ht("invalid shim '{0}' on tagged template",u.shim),9265)}return u.helper&&(t=yt.ir.rtcall(u.helper,[t])),t}function Se(e){var t=e.parameters.slice(0);if(!Ft(e)&&Bt(e)){var r=M(e);r.thisParameter||(r.thisParameter={kind:yt.SK.Parameter,name:{text:"this"},isThisParameter:!0,parent:e}),t.unshift(r.thisParameter)}return t}function Te(e,t){void 0===t&&(t=!1);var r=fr(e);return yt.ir.ptrlit(r+"_Lit",r)}function we(){for(F=ve(u);0<U.length;)gt(U.pop())}function Ee(){var e=a;if(0<e.length){a=[];for(var t=0,r=e;t<r.length;t++){var n=r[t],i=F;try{_e(n)}finally{F=i}}}}function Ie(e){D.finalPass&&e.functionsToDefine&&yt.U.pushRange(a,e.functionsToDefine)}function _e(n){var e=M(n),i=null;if(D.finalPass){if(e.alreadyEmitted)return yt.U.assert(e.usedBeforeDecl),null;e.alreadyEmitted=!0}var t=n.kind==yt.SK.ArrowFunction||n.kind==yt.SK.FunctionExpression,r=e.capturedVars.slice(0),a=r.map(function(e,t){var r=new yt.ir.Cell(t,e,P(e));return r.iscap=!0,r});void 0===e.usedBeforeDecl&&(e.usedBeforeDecl=!1),0<r.length?(yt.assert(null!=Rt(n),"getEnclosingFunction(node) != null)"),i=yt.ir.shared(yt.ir.rtcall("pxt::mkAction",[yt.ir.numlit(r.length),Te(n,!0)])),e.usedAsValue=!0,r.forEach(function(e,t){var r=F.localIndex(e);r||_t(9223,Ht("cannot find captured value: {0}",Vt.symbolToString(e.symbol)));var n=r.loadCore();F.emitExpr(yt.ir.rtcall("pxtrt::stclo",[i,yt.ir.numlit(t),n]))}),n.kind==yt.SK.FunctionDeclaration&&(e.location=F.mkLocal(n,P(n)),F.emitExpr(e.location.storeDirect(i)),i=null)):t&&(i=Te(n),e.usedAsValue=!0),yt.assert(!!i==t,"!!lit == isExpression");var s=ve(n);if(s)(F=s).reset();else{yt.assert(!D.finalPass,"!bin.finalPass");var o=wt(n),l=new yt.ir.Procedure;l.isRoot=!!(1&o.flags),l.action=n,l.info=e,(o.proc=l).usingCtx=A,F=l,B(function(e){return e.addProc(l)})}F.captured=a;var c=[];if(n.parent.kind==yt.SK.ClassDeclaration){var u=z(null,n.parent);if(F.classInfo?yt.assert(F.classInfo==u,"proc.classInfo == classInfo"):F.classInfo=u,n.kind==yt.SK.Constructor){if(u.baseClassInfo)for(var p=0,f=u.baseClassInfo.decl.members;p<f.length;p++){var d=f[p];d.kind==yt.SK.Constructor&&se(d)}u.ctor?yt.assert(u.ctor==F,"classInfo.ctor == proc"):u.ctor=F;for(var m=0,h=u.allfields;m<h.length;m++)if((I=h[m]).kind==yt.SK.PropertyDeclaration&&!Ft(I)){var g=I;g.initializer&&c.push(g)}}}var v=[],b=[];F.args=Se(n).map(function(e,t){e.name.kind===yt.SK.ObjectBindingPattern&&v.push(e),n.kind==yt.SK.Constructor&&vr(e)&&b.push(e);var r=new yt.ir.Cell(t,e,P(e));return Ie(r.info),r.isarg=!0,r}),F.args.forEach(function(e){if(e.isByRefLocal()){var t=yt.ir.shared(yt.ir.rtcall("pxtrt::mklocRef",[]));F.emitExpr(yt.ir.rtcall("pxtrt::stlocRef",[t,e.loadCore()],1)),F.emitExpr(e.storeDirect(t))}}),v.forEach(function(e){return pt(e)});for(var y=0,x=b;y<x.length;y++){var k=x[y],S=Oe(F.classInfo,Me(F.classInfo,er(k)),!1),T=yt.ir.op(kt.FieldAccess,[G(e.thisParameter)],S);F.emitExpr(yt.ir.op(kt.Store,[T,G(k)]))}for(var w=0,E=c;w<E.length;w++){var I=E[w];S=Oe(F.classInfo,Me(F.classInfo,er(I)),!1),T=yt.ir.op(kt.FieldAccess,[G(e.thisParameter)],S),F.emitExpr(yt.ir.op(kt.Store,[T,mt(I.initializer)]))}if(Ee(),n.body.kind==yt.SK.Block){if(vt(n.body),cr(F.action)){var _=F.body[F.body.length-1];_&&_.stmtKind==yt.ir.SK.Jmp&&_.jmpMode==yt.ir.JmpMode.Always||F.emitJmp(at(n).ret,We(void 0),yt.ir.JmpMode.Always)}}else{var K=mt(n.body);F.emitJmp(at(n).ret,K,yt.ir.JmpMode.Always)}F.emitLblDirect(at(n).ret),F.stackEmpty();var N=F.mkLabel("final");if(cr(F.action)?F.emitJmp(N):F.emitJmp(N,We(void 0)),F.emitLbl(N),e.capturedVars.length&&e.usedBeforeDecl&&n.kind==yt.SK.FunctionDeclaration&&!D.finalPass){e.capturedVars.sort(function(e,t){return t.pos-e.pos});var C=P(e.capturedVars[0]);C.functionsToDefine||(C.functionsToDefine=[]),C.functionsToDefine.push(n)}return yt.assert(!D.finalPass||0==U.length,"!bin.finalPass || usedWorkList.length == 0"),i}function Ke(e){var t=yt.ir.shared(e);return F.emitExpr(t),t}function Ne(){return Ke(yt.ir.op(kt.JmpValue,[]))}function Ce(e){if(g.target.isNative)return!1;var t=e;return t.body&&(t.body.kind!=yt.SK.Block||0<t.body.statements.length)}function Ue(e){if(ie(e)&&!(32&wt(e).flags)){var t=Xt(e);if(null!=t.shim){if("@"==t.shim[0])return;if(g.target.isNative&&yt.hex.validateShim(ur(e),t.shim,t,cr(e),Se(e).map(function(e){return br(lr(e))})),!Ce(e))return}if(!yr.isInAmbientContext(e)&&e.body){var r=null,n=F;try{r=_e(e)}finally{F=n}return r}}}function Ae(){}function Pe(e){var t=e;t.needsIRCache=!0,n.push(t)}function Le(e,t){void 0===t&&(t=null);var r=n.length;return e.kind!=yt.SK.PropertyAccessExpression&&e.kind!=yt.SK.ElementAccessExpression||Pe(e.expression),t&&Pe(t),n.length==r?Ae:function(){for(var e=r;e<n.length;++e)n[e].cachedIR=null,n[e].needsIRCache=!1;n.splice(r,n.length-r)}}function Fe(e,t){void 0===t&&(t=!1);var r={kind:yt.SK.NullKeyword,isRefOverride:t};return wt(r).valueOverride=e,r}function De(e,t,r,n){void 0===n&&(n=null);var i=Le(e),a=n?mt(n):We(1),s=yt.ir.shared(mt(e)),o=yt.ir.shared($e(t,s,a));return Be(e,Fe(o,!0)),i(),r?s:o}function Oe(e,t,r){void 0===r&&(r=!0),Ft(t)&&yt.U.oops("fieldIndex on static field: "+er(t));var n=Xt(t),i=e.allfields.indexOf(t);return i<0&&D.finalPass&&yt.U.oops("missing field"),{idx:i,name:er(t),isRef:!0,shimName:n.shim,classInfo:e,needsCheck:r}}function Me(e,t){var r=e.allfields.filter(function(e){return e.name.text==t})[0];return r||_t(9224,Ht("field {0} not found",t)),r}function Be(e,t,r){void 0===r&&(r=!1);var n=ce(e),i=qt(n);if(e.kind==yt.SK.Identifier||i)if(n&&(i||$t(n)||jt(n))){var a=N(n);I(n,!0),F.emitExpr(a.storeByRef(mt(t)))}else O(e,Ht("bad target identifier"),9248);else if(e.kind==yt.SK.PropertyAccessExpression){var s=ce(e);if(s&&s.kind==yt.SK.GetAccessor)(s=yr.getDeclarationOfKind(s.symbol,yt.SK.SetAccessor))||O(e,Ht("setter not available"),9253),F.emitExpr(me(e,e,[t],null,s));else if(s&&(s.kind==yt.SK.PropertySignature||s.kind==yt.SK.PropertyAssignment||te(s)))F.emitExpr(me(e,e,[t],null,s));else{var o=mt(e);F.emitExpr(yt.ir.op(kt.Store,[o,mt(t)]))}}else if(e.kind==yt.SK.ElementAccessExpression)F.emitExpr(re(e,t));else if(e.kind==yt.SK.ArrayLiteralExpression)if(t.kind==yt.SK.ArrayLiteralExpression){var l=t.elements.map(function(e){var t=yt.ir.shared(mt(e));return F.emitExpr(t),t});e.elements.forEach(function(e,t){Be(e,Fe(l[t]))})}else{var c=yt.ir.shared(mt(t));e.elements.forEach(function(e,t){Be(e,Fe(Ye("Array_::getAt",[c,yt.ir.numlit(t)])))})}else O(e,Ht("bad assignment target"),9249)}function Re(e){if(Ct())switch(e){case"numops::adds":case"numops::subs":case"numops::eors":case"numops::ands":case"numops::orrs":return"@nomask@"+e}if(Kt())switch(e){case"pxt::switch_eq":return"numops::eq"}return e}function $e(e,t,r){return Ye(Re(e),[t,r])}function qe(e,t){if(!t)return null;var r=t.val;switch(function e(t){if(t.kind==yt.SK.Identifier)return t.text;if(t.kind==yt.SK.PropertyAccessExpression){var r=t,n=e(r.expression);if(n)return n+"."+r.name.text}return null}(e)){case"Math.floor":return{val:Math.floor(r)};case"Math.ceil":return{val:Math.ceil(r)};case"Math.round":return{val:Math.round(r)}}return null}function je(e){if(!e)return null;var t=wt(e);if(t.constantFolded)return t.constantFolded;if($t(e)&&e.parent.flags&yr.NodeFlags.Const){var r=e;r.initializer&&(t.constantFolded=ze(r.initializer))}else if(e.kind==yt.SK.EnumMember){var n=e,i=function(e){var t=Xt(e).enumval;if(!t){var r=Vt.getConstantValue(e);if(null==r)return null;t=r+""}return/^[+-]?\d+$/.test(t)?t:/^0x[A-Fa-f\d]{2,8}$/.test(t)?t:(yt.U.userError("enumval only support number literals"),"0")}(n);if(null==i)t.constantFolded=ze(n.initializer);else{var a=parseInt(i);isNaN(a)||(t.constantFolded={val:a})}}else if(e.kind==yt.SK.PropertyDeclaration&&Ft(e)&&Dt(e)){var s=e;t.constantFolded=ze(s.initializer)}return t.constantFolded}function ze(e){var t=wt(e);if(void 0===t.constantFolded){t.constantFolded=null;var r=function(e){if(!e)return null;switch(e.kind){case yt.SK.PrefixUnaryExpression:var t=e,r=ze(t.operand);return function(e,t){if(!t)return null;var r=t.val;switch(e){case yt.SK.PlusToken:return{val:+r};case yt.SK.MinusToken:return{val:-r};case yt.SK.TildeToken:return{val:~r};case yt.SK.ExclamationToken:return{val:!r};default:return null}}(t.operator,r);case yt.SK.BinaryExpression:var t=e,n=ze(t.left);if(!n)return null;var i=ze(t.right);return i?function(e,t,r){if(!t||!r)return null;var n=t.val,i=r.val;switch(e){case yt.SK.PlusToken:return{val:n+i};case yt.SK.MinusToken:return{val:n-i};case yt.SK.SlashToken:return{val:n/i};case yt.SK.PercentToken:return{val:n%i};case yt.SK.AsteriskToken:return{val:n*i};case yt.SK.AsteriskAsteriskToken:return{val:Math.pow(n,i)};case yt.SK.AmpersandToken:return{val:n&i};case yt.SK.BarToken:return{val:n|i};case yt.SK.CaretToken:return{val:n^i};case yt.SK.LessThanLessThanToken:return{val:n<<i};case yt.SK.GreaterThanGreaterThanToken:return{val:n>>i};case yt.SK.GreaterThanGreaterThanGreaterThanToken:return{val:n>>>i};case yt.SK.LessThanEqualsToken:return{val:n<=i};case yt.SK.LessThanToken:return{val:n<i};case yt.SK.GreaterThanEqualsToken:return{val:i<=n};case yt.SK.GreaterThanToken:return{val:i<n};case yt.SK.EqualsEqualsToken:return{val:n==i};case yt.SK.EqualsEqualsEqualsToken:return{val:n===i};case yt.SK.ExclamationEqualsEqualsToken:return{val:n!==i};case yt.SK.ExclamationEqualsToken:return{val:n!=i};case yt.SK.BarBarToken:return{val:n||i};case yt.SK.AmpersandAmpersandToken:return{val:n&&i};default:return null}}(t.operatorToken.kind,n,i):null;case yt.SK.NumericLiteral:var t=e,a=parseFloat(t.text);return isNaN(a)?null:{val:a};case yt.SK.NullKeyword:return{val:null};case yt.SK.TrueKeyword:return{val:!0};case yt.SK.FalseKeyword:return{val:!1};case yt.SK.UndefinedKeyword:return{val:void 0};case yt.SK.CallExpression:var t=e;return 1==t.arguments.length?qe(t.expression,ze(t.arguments[0])):null;case yt.SK.PropertyAccessExpression:case yt.SK.Identifier:return je(le(e));case yt.SK.AsExpression:return ze(e.expression);default:return null}}(e);t.constantFolded=r}return t.constantFolded}function Ve(e){var t=yt.target.switches.boxDebug,r=null;if(t)try{yt.target.switches.boxDebug=!1,r=mt(e)}finally{yt.target.switches.boxDebug=t}else r=mt(e);var n=He(r);if(void 0===n)throw _t(9267,Ht("a constant number-like expression is required here"));return n}function Ge(e,t,r){var n=Vt.getSymbolsInScope(e,yr.SymbolFlags.Module).filter(function(e){return e.name==r&&!!e.valueDeclaration})[0];if(!n)return null;for(var i=0,a=n.valueDeclaration.body.statements;i<a.length;i++){var s=a[i];if(s.kind==yt.SK.VariableStatement)for(var o=0,l=s.declarationList.declarations;o<l.length;o++){var c=l[o];if(c.symbol.name==t)return Ve(c.initializer)}}return null}function Je(e,t){var r=Vt.getSymbolsInScope(e,yr.SymbolFlags.Enum).filter(function(e){return"DAL"==e.name&&!!e.valueDeclaration})[0];if(!r)return null;var n=r.valueDeclaration.members.filter(function(e){return e.symbol.name==t})[0];return n?Vt.getConstantValue(n):null}function He(e){if(e.exprKind==yt.ir.EK.NumberLiteral){var t=e.data;if(g.target.isNative&&!Kt()){if(t==yt.taggedNull||t==yt.taggedUndefined||t==yt.taggedFalse)return 0;if(t==yt.taggedTrue)return 1;if("number"==typeof t)return t>>1}else if("number"==typeof t)return t}else if(e.exprKind==yt.ir.EK.RuntimeCall&&2==e.args.length){var r=He(e.args[0]),n=He(e.args[1]);if(void 0===r||void 0===n)return;switch(e.data){case"numops::orrs":return r|n;case"numops::adds":return r+n;default:return void console.log(e)}}}function We(e){if(g.target.isNative&&!Kt()){var t=or(e);if(null!=t)return yt.ir.numlit(t);if("number"==typeof e){if(n=e,!yt.target.switches.boxDebug&&(0|n)==n&&-1073741824<=n&&n<=1073741823)return yt.ir.numlit(e<<1|1);var r=D.emitDouble(e);return yt.ir.ptrlit(r,JSON.stringify(e))}throw yt.U.oops("bad literal: "+e)}return yt.ir.numlit(e);var n}function Qe(e){if(e.kind==yt.SK.NullKeyword){var t=wt(e).valueOverride;if(null!=t)return t.exprKind==kt.NumberLiteral?!g.target.isNative||!!(1&t.data):t.exprKind==kt.RuntimeCall&&"pxt::ptrOfLiteral"==t.data?t.args[0].exprKind==kt.PointerLiteral&&!isNaN(parseFloat(t.args[0].jsInfo)):t.exprKind==kt.PointerLiteral&&!isNaN(parseFloat(t.jsInfo))}return e.kind==yt.SK.NumericLiteral||br(lr(e))}function Ye(e,t){return yt.ir.rtcallMask(e,(1<<t.length)-1,0,t)}function Ze(s,e,o,t){void 0===t&&(t=null);var l=[],r=yt.hex.lookupFunc(s);if(Ct()){var n=yt.U.lookup(xt,s);n&&(s=(r=n).name)}r&&(l=r.argsFmt),t&&(e=e.concat(t));var i,a,c=pe(e),u=[],p=e.map(function(e,t){var r=mt(e);if(!Nt())return r;var n=l[t+1],i=Qe(e);if(!n&&s.indexOf("::")<0&&(n=i?"I":"_"),n){if("_"==n[0]||"T"==n||"N"==n){var a=function(e){switch(e){case"_Buffer":return pxt.BuiltInType.BoxedBuffer;case"_Image":return yt.target.imageRefTag||pxt.BuiltInType.RefImage;case"_Action":return pxt.BuiltInType.RefAction;case"_RefCollection":return pxt.BuiltInType.RefCollection;default:return null}}(n);return a&&u.push({argIdx:t,method:"_validate",refTag:a,refTagNullable:!!o.argsNullable}),r}if("I"==n)return r.exprKind==kt.NumberLiteral&&"number"==typeof r.data?yt.ir.numlit(r.data>>1):(u.push({argIdx:t,method:"pxt::toInt"}),r);if("B"==n)return c&=~(1<<t),it(e,r);if("S"==n)return r.isStringLiteral||(u.push({argIdx:t,method:"_pxt_stringConv",returnsRef:!0}),c|=1<<t),r;if("F"==n||"D"==n)return"D"==n&&yt.U.oops("double arguments not yet supported"),i||yt.U.userError("argsFmt=...F/D... but argument not a number in "+s),u.push({argIdx:t,method:"D"==n?"pxt::toDouble":"pxt::toFloat"}),r;throw yt.U.oops("invalid format specifier: "+n)}throw yt.U.userError("not enough args for "+s)}),f=yt.ir.rtcallMask(s,c,o?o.callingConvention:0,p);if(f.mask||(f.mask={refMask:0}),f.mask.conversions=u,g.target.isNative){var d=l[0];"I"==d?f=Ut(f):"B"==d?f=At(f):"F"==d?(a=f,f=Nt()?yt.ir.rtcall("pxt::fromFloat",[a]):a):"D"==d&&(yt.U.oops("double returns not yet supported"),i=f,f=Nt()?yt.ir.rtcall("pxt::fromDouble",[i]):i)}return f}function Xe(e){if(D.numStmts++,g.breakpoints){var t=yr.getSourceFileOfNode(e);if(!g.justMyCode||!Tt(t)){for(var r=e.pos;/^\s$/.exec(t.text[r]);)r++;var n=yr.getLineAndCharacterOfPosition(t,r),i=yr.getLineAndCharacterOfPosition(t,e.end),a={id:L.breakpoints.length,isDebuggerStmt:e.kind==yt.SK.DebuggerStatement,fileName:t.fileName,start:r,length:e.end-r,line:n.line,endLine:i.line,column:n.character,endColumn:i.character};L.breakpoints.push(a);var s=yt.ir.stmt(yt.ir.SK.Breakpoint,null);s.breakpointInfo=a,F.emit(s)}}}function et(e,t){switch(t){case yt.SK.PlusToken:return"numops::adds";case yt.SK.MinusToken:return"numops::subs";case yt.SK.SlashToken:return g.warnDiv&&(r=e,n=9274,i="usage of / operator",T(yt.DiagnosticCategory.Warning,r,n,i,a,s,o)),"numops::div";case yt.SK.PercentToken:return"numops::mod";case yt.SK.AsteriskToken:return"numops::muls";case yt.SK.AsteriskAsteriskToken:return"Math_::pow";case yt.SK.AmpersandToken:return"numops::ands";case yt.SK.BarToken:return"numops::orrs";case yt.SK.CaretToken:return"numops::eors";case yt.SK.LessThanLessThanToken:return"numops::lsls";case yt.SK.GreaterThanGreaterThanToken:return"numops::asrs";case yt.SK.GreaterThanGreaterThanGreaterThanToken:return"numops::lsrs";case yt.SK.LessThanEqualsToken:return"numops::le";case yt.SK.LessThanToken:return"numops::lt";case yt.SK.GreaterThanEqualsToken:return"numops::ge";case yt.SK.GreaterThanToken:return"numops::gt";case yt.SK.EqualsEqualsToken:return"numops::eq";case yt.SK.EqualsEqualsEqualsToken:return"numops::eqq";case yt.SK.ExclamationEqualsEqualsToken:return"numops::neqq";case yt.SK.ExclamationEqualsToken:return"numops::neq";default:return null}var r,n,i,a,s,o}function tt(r){if(r.operatorToken.kind==yt.SK.EqualsToken)return function(e){var t=e.right;e.parent.kind==yt.SK.ExpressionStatement&&(t=null);var r=Le(e.left,t);Be(e.left,e.right,!0);var n=t?mt(t):We(void 0);return r(),n}(r);var e=ze(r);if(e)return We(e.val);var t=null,n=null;if(r.operatorToken.kind!=yt.SK.PlusToken&&r.operatorToken.kind!=yt.SK.PlusEqualsToken||(t=lr(r.left),n=lr(r.right),(mr(t)||mr(n)&&r.operatorToken.kind==yt.SK.PlusToken)&&(wt(r).exprInfo={leftType:Vt.typeToString(t),rightType:Vt.typeToString(n)})),r.operatorToken.kind==yt.SK.CommaToken){if(st(r.left))return mt(r.right);var i=ot(r.left);return yt.ir.op(kt.Sequence,[i,mt(r.right)])}switch(r.operatorToken.kind){case yt.SK.BarBarToken:case yt.SK.AmpersandAmpersandToken:return function(e){var t=mt(e.left),r=(mr(lr(e.left)),F.mkLabel("lazy"));t=yt.ir.shared(t);var n=yt.ir.rtcall("numops::toBool",[t]),i=F.mkLabel("lazySkip"),a=e.operatorToken.kind==yt.SK.BarBarToken?yt.ir.JmpMode.IfZero:e.operatorToken.kind==yt.SK.AmpersandAmpersandToken?yt.ir.JmpMode.IfNotZero:yt.U.oops();return F.emitJmp(i,n,a),F.emitJmp(r,t,yt.ir.JmpMode.Always,t),F.emitLbl(i),F.emitExpr(Ye("langsupp::ignore",[t])),F.emitJmp(r,mt(e.right),yt.ir.JmpMode.Always),F.emitLbl(r),Ne()}(r);case yt.SK.InstanceOfKeyword:return function(e){var t=lr(e.right),r=ar(t)?ce(e.right):null;r&&r.kind==yt.SK.ClassDeclaration||_t(9275,Ht("unsupported instanceof expression"));var n=z(t,r);xe(n);var i=yt.ir.op(yt.ir.EK.InstanceOf,[mt(e.left)],n);return i.jsInfo="bool",i}(r)}if(r.operatorToken.kind==yt.SK.PlusToken&&(mr(t)||mr(n)))return Ze("String_::concat",[Z(r.left),Z(r.right)],null);if(r.operatorToken.kind==yt.SK.PlusEqualsToken&&mr(t)){var a=Le(r.left),s=yt.ir.shared(Ze("String_::concat",[Z(r.left),Z(r.right)],null));return Be(r.left,Fe(s)),a(),s}var o=function(e){switch(e){case yt.SK.PlusEqualsToken:return yt.SK.PlusToken;case yt.SK.MinusEqualsToken:return yt.SK.MinusToken;case yt.SK.AsteriskEqualsToken:return yt.SK.AsteriskToken;case yt.SK.AsteriskAsteriskEqualsToken:return yt.SK.AsteriskAsteriskToken;case yt.SK.SlashEqualsToken:return yt.SK.SlashToken;case yt.SK.PercentEqualsToken:return yt.SK.PercentToken;case yt.SK.LessThanLessThanEqualsToken:return yt.SK.LessThanLessThanToken;case yt.SK.GreaterThanGreaterThanEqualsToken:return yt.SK.GreaterThanGreaterThanToken;case yt.SK.GreaterThanGreaterThanGreaterThanEqualsToken:return yt.SK.GreaterThanGreaterThanGreaterThanToken;case yt.SK.AmpersandEqualsToken:return yt.SK.AmpersandToken;case yt.SK.BarEqualsToken:return yt.SK.BarToken;case yt.SK.CaretEqualsToken:return yt.SK.CaretToken;default:return yt.SK.Unknown}}(r.operatorToken.kind),l=et(r,o||r.operatorToken.kind);return l||O(r.operatorToken,Ht("unsupported operator"),9250),o?De(r.left,l,!1,r.right):function(e){e=Re(e);var t=[r.left,r.right];return yt.ir.rtcallMask(e,pe(t),0,t.map(function(e){return mt(e)}))}(l)}function rt(e){e.statements.forEach(vt)}function nt(e){if(e.flags&yr.NodeFlags.Let||e.flags&yr.NodeFlags.Const)return!0;throw _t(9260,Ht("variable needs to be defined using 'let' instead of 'var'"))}function it(e,t){if(void 0===t&&(t=null),!t&&Ct()&&e.kind==yt.SK.BinaryExpression){var r=e,n=yt.U.lookup(yt.thumbCmpMap,et(r,r.operatorToken.kind));if(n)return yt.ir.rtcall(n,[mt(r.left),mt(r.right)])}return t||(t=mt(e)),Kt()?t:yt.ir.rtcall("numops::toBoolDecr",[t])}function at(e){var t=Et(e);return{fortop:".fortop."+t,cont:".cont."+t,brk:".brk."+t,ret:".ret."+t}}function st(e){if(!e)return!0;switch(e.kind){case yt.SK.Identifier:case yt.SK.StringLiteral:case yt.SK.NumericLiteral:case yt.SK.NullKeyword:return!0}return!1}function ot(e){return mt(e)}function lt(e){if(!st(e)){Xe(e);var t=ot(e);F.emitExpr(t),F.stackEmpty()}}function ct(e){switch(e.kind){case yt.SK.WhileStatement:case yt.SK.ForInStatement:case yt.SK.ForOfStatement:case yt.SK.ForStatement:case yt.SK.DoStatement:return!0;default:return!1}}function ut(e,t,r){if(e.name.kind===yt.SK.ObjectBindingPattern||e.name.kind==yt.SK.ArrayBindingPattern)return t||(t=e.initializer?yt.ir.shared(mt(e.initializer)):G(e),r=e.initializer?lr(e.initializer):lr(e)),e.name.elements.forEach(function(e){return ut(e,t,r)}),F.stackEmpty(),null;if(!ie(e))return null;if(je(e))return null;var n;if(qt(e)?(K(e),n=N(e)):n=F.mkLocal(e,P(e)),Ie(n.info),n.isByRefLocal()&&F.emitExpr(n.storeDirect(yt.ir.rtcall("pxtrt::mklocRef",[]))),_(lr(e)),e.kind===yt.SK.BindingElement){Xe(e);var i=function e(t,r,n){var i=t.parent.parent;if(i.kind===yt.SK.BindingElement){var a=e(i,r,n);r=a[0],n=a[1]}if(t.parent.kind==yt.SK.ArrayBindingPattern){var s=t.parent.elements.indexOf(t);t.dotDotDotToken&&_t(9203,Ht("spread operator not supported yet"));var o=sr(n,s);return[Ye("Array_::getAt",[r,yt.ir.numlit(s)]),o]}var l=t.propertyName||t.name;return function(e,t,r,n){var i=Vt.getPropertyOfType(r,n);yt.U.assert(!!i,"field sym");var a,s=Vt.getTypeOfSymbolAtLocation(i,e);if(ar(r)){var o=z(r);a=yt.ir.op(kt.FieldAccess,[t],Oe(o,Me(o,n)))}else a=ge([t],{ifaceIndex:R(n,!0),noArgs:!0});return[a,s]}(t,r,n,l.text)}(e,t,r),a=i[0];i[1],F.emitExpr(n.storeByRef(a))}else if(e.initializer){if(Xe(e),qt(e)){var s=Xt(e).jres;if(s){"true"==s&&(s=Yt(Vt,e));var o=yt.U.lookup(g.jres||{},s);o?b=o:_t(9270,Ht("resource '{0}' not found in any .jres file",s))}}e.initializer,F.emitExpr(n.storeByRef(mt(e.initializer))),b=null,F.stackEmpty()}else(function(e){for(;e;){if(ct(e))return!0;e=e.parent}return!1})(e)&&(Xe(e),F.emitExpr(n.storeByRef(We(void 0))),F.stackEmpty());return n}function pt(e){return ut(e,null,null)}function ft(e){!function(e,t){var r=function(e){e&&e.kind==yt.SK.ClassDeclaration&&_t(9261,Ht("Interface with same name as a class not supported"))};if(r(t.symbol.valueDeclaration),t.symbol.declarations&&t.symbol.declarations.forEach(r),t.heritageClauses)for(var n=0,i=t.heritageClauses;n<i.length;n++){var a=i[n];switch(a.token){case yt.SK.ExtendsKeyword:ir(lr(a.types[0]))&&_t(9262,Ht("Extending a class by an interface not supported."))}}}(0,e);var t=Xt(e);t.autoCreate&&(v[t.autoCreate]=!0)}function dt(t,e){var r=Jt;Qt++;try{Jt=null;var n=e(t);return Jt&&_t(Wt,Jt),Jt=r,Qt--,n}catch(e){return Qt--,Jt=null,w(t,e.ksErrorCode||9200,e.message),pxt.debug(e.stack),null}}function mt(e,t){void 0===t&&(t=!0);var r=e;if(t&&r.cachedIR)return r.cachedIR;var n=dt(r,ht)||We(void 0);return t&&r.needsIRCache?(r.cachedIR=yt.ir.shared(n),r.cachedIR):n}function ht(e){var t=function(e){switch(e.kind){case yt.SK.NullKeyword:var t=wt(e).valueOverride;return t||We(null);case yt.SK.TrueKeyword:return We(!0);case yt.SK.FalseKeyword:return We(!1);case yt.SK.TemplateHead:case yt.SK.TemplateMiddle:case yt.SK.TemplateTail:case yt.SK.NumericLiteral:case yt.SK.StringLiteral:case yt.SK.NoSubstitutionTemplateLiteral:return function(e){if(e.kind!=yt.SK.NumericLiteral){if(Lt(e))return Y(e.text);throw yt.oops()}return e.imageLiteral?yt.ir.ptrlit(e.imageLiteral,e.jsLit):We(parseFloat(e.text))}(e);case yt.SK.TaggedTemplateExpression:return ke(e);case yt.SK.PropertyAccessExpression:return ee(e);case yt.SK.BinaryExpression:return tt(e);case yt.SK.PrefixUnaryExpression:return function(e){var t=ze(e);if(t)return We(t.val);var r=lr(e.operand);if(e.operator==yt.SK.ExclamationToken)return At(yt.ir.rtcall("Boolean_::bang",[it(e.operand)]));if(hr(r))switch(e.operator){case yt.SK.PlusPlusToken:return De(e.operand,"numops::adds",!1);case yt.SK.MinusMinusToken:return De(e.operand,"numops::subs",!1);case yt.SK.MinusToken:return null!=(i=He(n=mt(e.operand)))?We(-i):$e("numops::subs",We(0),n);case yt.SK.PlusToken:return mt(e.operand);case yt.SK.TildeToken:var n,i;return null!=(i=He(n=mt(e.operand)))?We(~i):Ye(Re("numops::bnot"),[n])}throw O(e,Ht("unsupported prefix unary operation"),9245)}(e);case yt.SK.PostfixUnaryExpression:return function(e){if(hr(lr(e.operand)))switch(e.operator){case yt.SK.PlusPlusToken:return De(e.operand,"numops::adds",!0);case yt.SK.MinusMinusToken:return De(e.operand,"numops::subs",!0)}throw O(e,Ht("unsupported postfix unary operation"),9246)}(e);case yt.SK.ElementAccessExpression:return re(e);case yt.SK.ParenthesizedExpression:return mt(e.expression);case yt.SK.TypeAssertionExpression:return(u=e).expression,mt(u.expression);case yt.SK.ArrayLiteralExpression:return function(e){sr(lr(e));for(var t=yt.ir.shared(yt.ir.rtcall("Array_::mk",[])),r=0,n=e.elements;r<n.length;r++){var i=n[r],a=ue(i)?2:0;F.emitExpr(yt.ir.rtcall("Array_::push",[t,mt(i)],a))}return t}(e);case yt.SK.NewExpression:return function(e){var t=Vt.getTypeAtLocation(e);if(t&&rr(t))throw yt.oops();if(t&&ar(t)){var r=ce(e.expression);r.kind!=yt.SK.ClassDeclaration&&_t(9221,Ht("new expression only supported on class types"));for(var n=void 0,i=z(lr(e),r),a=i;a&&!(n=ye(a.decl));a=a.baseClassInfo);xe(i);var s=i.id+"_VT",o=yt.ir.rtcall("pxt::mkClassInstance",[yt.ir.ptrlit(s,s)]);if(n){o=Ke(o),ae(n);var l=(e.arguments||[]).slice(0),c=Xt(n);de(Vt.getResolvedSignature(e),l,c);var u=l.map(function(e){return mt(e)});return c.shim?yt.ir.rtcall(c.shim,u):(u.unshift(o),F.emitExpr(be(n,u)),o)}return e.arguments&&e.arguments.length&&_t(9222,Ht("constructor with arguments not found")),o}throw O(e,Ht("unknown type for new"),9243)}(e);case yt.SK.SuperKeyword:case yt.SK.ThisKeyword:return Q(e);case yt.SK.CallExpression:return o=e,l=Vt.getResolvedSignature(o),me(o,o.expression,o.arguments,l);case yt.SK.FunctionExpression:case yt.SK.ArrowFunction:return Ue(e);case yt.SK.Identifier:return W(e);case yt.SK.ConditionalExpression:return i=e,a=F.mkLabel("condexprz"),s=F.mkLabel("condexprfin"),F.emitJmp(a,it(i.condition),yt.ir.JmpMode.IfZero),F.emitJmp(s,mt(i.whenTrue),yt.ir.JmpMode.Always),F.emitLbl(a),F.emitJmp(s,mt(i.whenFalse),yt.ir.JmpMode.Always),F.emitLbl(s),Ne();case yt.SK.AsExpression:return(n=e).expression,mt(n.expression);case yt.SK.TemplateExpression:return X(e);case yt.SK.ObjectLiteralExpression:return r=e,c=yt.ir.shared(yt.ir.rtcall("pxtrt::mkMap",[])),r.properties.forEach(function(e){var t,r;if(yt.assert(!e.questionToken),e.kind==yt.SK.ShorthandPropertyAssignment){var n=e;yt.assert(!n.equalsToken&&!n.objectAssignmentInitializer),t=e.name.text;var i=Vt.getShorthandAssignmentValueSymbol(e),a=i&&i.valueDeclaration&&i.valueDeclaration.name;if(!a||a.kind!=yt.SK.Identifier)throw O(e);r=W(a)}else{if(e.name.kind==yt.SK.ComputedPropertyName){var s=e.name.expression;return void F.emitExpr(Ze("pxtrt::mapSetByString",[Fe(c,!0),s,e.initializer],null))}t=e.name.kind==yt.SK.StringLiteral?e.name.text:e.name.getText(),r=mt(e.initializer)}var o=yt.target.isNative?yt.ir.numlit(R(t)):yt.ir.ptrlit(null,JSON.stringify(t)),l=[c,o,r];F.emitExpr(yt.ir.rtcall(yt.target.isNative?"pxtrt::mapSet":"pxtrt::mapSetByString",l))}),c;case yt.SK.TypeOfExpression:return Ze("pxt::typeOf",[e.expression],null);case yr.SyntaxKind.DeleteExpression:return function(e){var t,r;if(e.expression.kind==yt.SK.PropertyAccessExpression){var n=e.expression;t=n.expression,r=function(){return Y(n.name.text)}}else{if(e.expression.kind!=yt.SK.ElementAccessExpression)throw _t(9276,Ht("expression not supported as argument to 'delete'"));var i=e.expression;t=i.expression,r=function(){return mt(i.argumentExpression)}}var a=lr(t);if(ir(a))throw _t(9277,Ht("'delete' not supported on class types"));if(rr(a))throw _t(9277,Ht("'delete' not supported on array"));return Ye("pxtrt::mapDeleteByString",[mt(t),r()])}(e);default:return O(e),null}var r,c,n,i,a,s,o,l,u}(e);if(t.isExpr())return t;throw new Error("expecting expression")}function gt(e){var t=wt(e);if(t.usedNodes){p=!1;for(var r=0,n=yt.U.values(t.usedNodes);r<n.length;r++)ae(n[r]);for(var i=0,a=t.usedActions;i<a.length;i++)(0,a[i])(D);p=!0}else qt(e)||yr.isClassDeclaration(e)?(p=!1,(A=t).usedNodes=null,A.usedActions=null,qt(e)&&!je(e)&&K(e),vt(e),p=!0):((A=t).usedNodes={},A.usedActions=[],vt(e),A=null)}function vt(e){dt(e,bt)}function bt(e){switch(e.kind){case yt.SK.SourceFile:return void e.statements.forEach(vt);case yt.SK.InterfaceDeclaration:return ft(e);case yt.SK.VariableStatement:return function(e){function t(e){var t=yt.U.lookup(c,e.name);if(t||(c[(t=e).name]=t),t.value!=e.value)throw _t(9269,Ht("conflicting values for config.{0}",e.name))}if(e.declarationList.flags&yr.NodeFlags.Const){var r=e.parent&&e.parent.kind==yt.SK.ModuleBlock?er(e.parent.parent):"?";if("config"==r||"userconfig"==r)for(var n=0,i=e.declarationList.declarations;n<i.length;n++){var a=i[n],s=ur(a);if(a.initializer){var o=Ve(a.initializer),l=Je(e,"CFG_"+s);if(null==l||0==l)throw _t(9268,Ht("can't find DAL.CFG_{0}",s));"userconfig"==r&&(s="!"+s),t({name:s,key:l,value:o})}}}yr.isInAmbientContext(e)||(nt(e.declarationList),e.declarationList.declarations.forEach(vt))}(e);case yt.SK.ModuleDeclaration:return void vt(e.body);case yt.SK.EnumDeclaration:return;case yt.SK.FunctionDeclaration:case yt.SK.Constructor:case yt.SK.MethodDeclaration:return void Ue(e);case yt.SK.ExpressionStatement:return void lt(e.expression);case yt.SK.Block:case yt.SK.ModuleBlock:return rt(e);case yt.SK.VariableDeclaration:return pt(e),void Ee();case yt.SK.IfStatement:return function(e){Xe(e);var t=F.mkLabel("else");F.emitJmpZ(t,it(e.expression)),vt(e.thenStatement);var r=F.mkLabel("afterif");F.emitJmp(r),F.emitLbl(t),e.elseStatement&&vt(e.elseStatement),F.emitLbl(r)}(e);case yt.SK.WhileStatement:return function(e){Xe(e);var t=at(e);F.emitLblDirect(t.cont),Xe(e.expression),F.emitJmpZ(t.brk,it(e.expression)),vt(e.statement),F.emitJmp(t.cont),F.emitLblDirect(t.brk)}(e);case yt.SK.DoStatement:return function(e){Xe(e);var t=at(e);F.emitLblDirect(t.cont),vt(e.statement),Xe(e.expression),F.emitJmpZ(t.brk,it(e.expression)),F.emitJmp(t.cont),F.emitLblDirect(t.brk)}(e);case yt.SK.ForStatement:return function(e){e.initializer&&e.initializer.kind==yt.SK.VariableDeclarationList?(nt(e.initializer),e.initializer.declarations.forEach(vt)):lt(e.initializer),Xe(e);var t=at(e);F.emitLblDirect(t.fortop),e.condition&&(Xe(e.condition),F.emitJmpZ(t.brk,it(e.condition))),vt(e.statement),F.emitLblDirect(t.cont),lt(e.incrementor),F.emitJmp(t.fortop),F.emitLblDirect(t.brk)}(e);case yt.SK.ForOfStatement:return function(e){if(e.initializer&&e.initializer.kind==yt.SK.VariableDeclarationList){var t=e.initializer;if(1==t.declarations.length){nt(t);var r=lr(e.expression),n="",i="";if(mr(r))n="String_::charAt",i="String_::length";else{if(!rr(r))return void O(e.expression,"cannot use for...of with this expression");n="Array_::getAt",i="Array_::length"}ae(t.declarations[0]);var a=pt(t.declarations[0]);yt.U.assert(!!a||!D.finalPass),F.stackEmpty();var s=F.mkLocalUnnamed();F.emitExpr(s.storeByRef(mt(e.expression)));var o=F.mkLocalUnnamed();F.emitExpr(o.storeByRef(We(0))),F.stackEmpty(),Xe(e);var l=at(e);F.emitLblDirect(l.fortop);var c,u=yt.ir.rtcall(i,[s.loadCore()]),p=$e("numops::lt_bool",o.load(),Ut(u));F.emitJmpZ(l.brk,p),a&&F.emitExpr(a.storeByRef(yt.ir.rtcall(n,[s.loadCore(),(c=o.loadCore(),Nt()?yt.ir.rtcall("pxt::toInt",[c]):c)]))),Ee(),vt(e.statement),F.emitLblDirect(l.cont),F.emitExpr(o.storeByRef($e("numops::adds",o.load(),We(1)))),F.emitJmp(l.fortop),F.emitLblDirect(l.brk),F.emitExpr(s.storeByRef(We(void 0)))}else O(e,"only a single variable may be used to iterate a collection")}else O(e,"only a single variable may be used to iterate a collection")}(e);case yt.SK.ContinueStatement:case yt.SK.BreakStatement:return function(e){Xe(e);var r=e.label?e.label.text:null,n=e.kind==yt.SK.BreakStatement,t=function e(t){return t?r&&t.kind==yt.SK.LabeledStatement&&t.label.text==r?t.statement:t.kind==yt.SK.SwitchStatement&&!r&&n?t:!r&&yr.isIterationStatement(t,!1)?t:e(t.parent):null}(e);if(t){var i=at(t);e.kind==yt.SK.ContinueStatement?yr.isIterationStatement(t,!1)?F.emitJmp(i.cont):w(e,9231,Ht("continue on non-loop")):e.kind==yt.SK.BreakStatement?F.emitJmp(i.brk):yt.oops()}else w(e,9230,Ht("cannot find outer loop"))}(e);case yt.SK.LabeledStatement:return a=at((i=e).statement),vt(i.statement),void F.emitLblDirect(a.brk);case yt.SK.ReturnStatement:return function(e){Xe(e);var t=null;e.expression?t=mt(e.expression):cr(F.action)&&(t=We(void 0)),F.emitJmp(at(F.action).ret,t,yt.ir.JmpMode.Always)}(e);case yt.SK.ClassDeclaration:return(n=z(null,r=e)).isUsed&&D.usedClassInfos.indexOf(n)<0&&D.usedClassInfos.push(n),void r.members.forEach(vt);case yt.SK.PropertyDeclaration:case yt.SK.PropertyAssignment:return function(e){if(Ft(e))pt(e);else if(e.initializer){var t=z(lr(e.parent));D.finalPass&&t.isUsed&&!t.ctor&&_t(9209,Ht("class field initializers currently require an explicit constructor"))}}(e);case yt.SK.SwitchStatement:return function(e){Xe(e);var s,t=at(e),o=yt.ir.shared(mt(e.expression)),r=e.caseBlock.clauses.map(function(e){var t=F.mkLabel("switch");if(e.kind==yt.SK.CaseClause){var r=e,n=mt(r.expression),i=ue(r.expression)?1:0,a=yt.ir.rtcallMask(Re("pxt::switch_eq"),i,0,[n,o]);F.emitJmp(t,a,yt.ir.JmpMode.IfNotZero,o)}else e.kind==yt.SK.DefaultClause?(yt.assert(!s,"!defaultLabel"),s=t):yt.oops();return t});s?F.emitJmp(s,o):F.emitJmp(t.brk,o),e.caseBlock.clauses.forEach(function(e,t){F.emitLbl(r[t]),e.statements.forEach(vt)}),F.emitLblDirect(t.brk)}(e);case yt.SK.TypeAliasDeclaration:return;case yr.SyntaxKind.TryStatement:return function(e){var t=function(e){return Ye("pxt::beginTry",[yt.ir.ptrlit(e.lblName,e)])};Xe(e);var r=F.mkLabel("catch");r.lblName="_catch_"+Et(e);var n=F.mkLabel("finally");if(n.lblName="_finally_"+Et(e),e.finallyBlock&&F.emitExpr(t(n)),e.catchClause&&F.emitExpr(t(r)),F.stackEmpty(),rt(e.tryBlock),F.stackEmpty(),e.catchClause){var i=F.mkLabel("catchend");F.emitExpr(Ye("pxt::endTry",[])),F.emitJmp(i),F.emitLbl(r);var a=e.catchClause.variableDeclaration;if(a){pt(a);var s=N(a);F.emitExpr(s.storeByRef(Ye("pxt::getThrownValue",[])))}Ee(),rt(e.catchClause.block),F.emitLbl(i)}e.finallyBlock&&(F.emitExpr(Ye("pxt::endTry",[])),F.emitLbl(n),rt(e.finallyBlock),F.emitExpr(Ye("pxt::endFinally",[])))}(e);case yr.SyntaxKind.ThrowStatement:return Xe(t=e),void F.emitExpr(Ye("pxt::throwValue",[mt(t.expression)]));case yt.SK.DebuggerStatement:return void Xe(e);case yt.SK.GetAccessor:case yt.SK.SetAccessor:return void Ue(e);case yt.SK.ImportEqualsDeclaration:case yt.SK.EmptyStatement:case yt.SK.SemicolonClassElement:return;default:O(e)}var t,r,n,i,a}},yt.isStringType=mr;var gr=function(){function e(){this.procs=[],this.globals=[],this.finalPass=!1,this.writeFile=function(e,t){},this.usedClassInfos=[],this.sourceHash="",this.numStmts=1,this.commSize=0,this.itEntries=0,this.itFullEntries=0,this.numMethods=0,this.numVirtMethods=0,this.usedChars=new Uint32Array(2048),this.explicitlyUsedIfaceMembers={},this.ifaceMemberMap={},this.strings={},this.hexlits={},this.doubles={},this.otherLiterals=[],this.codeHelpers={},this.lblNo=0}return e.prototype.reset=function(){this.lblNo=0,this.otherLiterals=[],this.strings={},this.hexlits={},this.doubles={},this.numStmts=0},e.prototype.getTitle=function(){var e=this.options.name||yt.U.lf("Untitled");return 90<=e.length?e.slice(0,87)+"...":e},e.prototype.addProc=function(e){yt.assert(!this.finalPass,"!this.finalPass"),this.procs.push(e),e.seqNo=this.procs.length},e.prototype.recordHelper=function(e,t,r){var n=function(e){e.codeHelpers[t]||(e.codeHelpers[t]=r(e))};n(this),this.recordAction(e,n)},e.prototype.recordAction=function(e,t){e?e.usedActions&&e.usedActions.push(t):yt.U.oops("no using ctx!")},e.prototype.emitLabelled=function(e,t,r){var n=yt.U.lookup(t,e);if(null!=n)return n;var i=r+this.lblNo++;return t[e]=i},e.prototype.emitDouble=function(e){return this.emitLabelled(yt.target.switches.numFloat?(n=e,(i=new Float32Array(1))[0]=n,yt.U.toHex(new Uint8Array(i.buffer))):(t=e,(r=new Float64Array(1))[0]=t,yt.U.toHex(new Uint8Array(r.buffer))),this.doubles,"_dbl");var t,r,n,i},e.prototype.emitString=function(e){if(!this.finalPass)for(var t=0;t<e.length;++t){var r=e.charCodeAt(t);128<=r&&(this.usedChars[r>>5]|=1<<(31&r))}return this.emitLabelled(e,this.strings,"_str")},e.prototype.emitHexLiteral=function(e){return this.emitLabelled(e,this.hexlits,"_hexlit")},e.prototype.setPerfCounters=function(e){if(!yt.target.switches.profile)return[];var t=e.slice();return this.procs.forEach(function(e){e.perfCounterName&&(yt.U.assert(yt.target.switches.profile),e.perfCounterNo=t.length,t.push(e.perfCounterName))}),t},e}();function vr(e){if(!e.modifiers)return!1;if(e.parent.kind!=yt.SK.Constructor)return!1;for(var t=0,r=e.modifiers;t<r.length;t++){var n=r[t];if(n.kind==yt.SK.PrivateKeyword||n.kind==yt.SK.PublicKeyword||n.kind==yt.SK.ProtectedKeyword)return!0}return!1}function br(e){return e.flags&yr.TypeFlags.Union?e.types.every(function(e){return br(e)}):!!(e.flags&(yr.TypeFlags.NumberLike|yr.TypeFlags.EnumLike|yr.TypeFlags.BooleanLike))}yt.Binary=gr,yt.isCtorField=vr}(yr.pxtc||(yr.pxtc={}))}(ts||(ts={})),function(ts){var pxtc;!function(pxtc){function getTsCompilerOptions(e){var t=ts.getDefaultCompilerOptions();return t.target=ts.ScriptTarget.ES5,t.module=ts.ModuleKind.None,t.noImplicitAny=!0,t.noImplicitReturns=!0,t.allowUnreachableCode=!0,t}function nodeLocationInfo(e){var t=ts.getSourceFileOfNode(e),r=e.getStart?e.getStart():e.pos,n=ts.getLineAndCharacterOfPosition(t,r),i=n.line,a=n.character,s=ts.getLineAndCharacterOfPosition(t,e.end),o=s.line,l=s.character;return{start:r,length:e.end-r,line:i,column:a,endLine:o,endColumn:l,fileName:t.fileName}}function patchUpDiagnostics(e,t){void 0===t&&(t=!1),t&&(e=e.filter(function(e){return 5012!==e.code}));var r=e.filter(function(e){return 1148==e.code});return 0<r.length&&(e=r),e.map(function(e){if(!e.file)return{code:e.code,start:e.start,length:e.length,line:0,column:0,messageText:e.messageText,category:e.category,fileName:"?"};var t=ts.getLineAndCharacterOfPosition(e.file,e.start),r={code:e.code,start:e.start,length:e.length,line:t.line,column:t.character,messageText:e.messageText,category:e.category,fileName:e.file.fileName};return 1148==r.code&&(r.messageText=pxtc.Util.lf("all symbols in top-level scope are always exported; please use a namespace if you want to export only some")),r})}function py2tsIfNecessary(e){return e.target.preferredEditor==pxt.PYTHON_PROJECT_NAME?pxtc.transpile.pyToTs(e).diagnostics:[]}function mkCompileResult(){return{outfiles:{},diagnostics:[],success:!1,times:{}}}function storeGeneratedFiles(e,t){for(var r=0,n=e.generatedFiles||[];r<n.length;r++){var i=n[r];t.outfiles[i]=e.fileSystem[i]}}function runConversionsAndStoreResults(e,t){var r=pxtc.U.cpuUs();t||(t=mkCompileResult());var n=py2tsIfNecessary(e);storeGeneratedFiles(e,t),t.diagnostics=n,e.sourceFiles||(e.sourceFiles=Object.keys(e.fileSystem));var i=e.sourceFiles.indexOf("main.ts");0<=i&&(e.sourceFiles.splice(i,1),e.sourceFiles.push("main.ts"));var a=e.sourceFiles.indexOf("_onCodeStop.ts");return 0<=a&&(e.sourceFiles.splice(a,1),e.sourceFiles.push("_onCodeStop.ts")),t.times.conversions=pxtc.U.cpuUs()-r,t}function timesToMs(e){for(var t=0,r=Object.keys(e.times);t<r.length;t++){var n=r[t];e.times[n]=Math.round(e.times[n])/1e3}}function buildProgram(e,i){var a={};for(var t in e.fileSystem)a[normalizePath(t)]=e.fileSystem[t];var r=getTsCompilerOptions(e),n={getSourceFile:function(e,t,r){e=normalizePath(e);var n="";return a.hasOwnProperty(e)?n=a[e]:r&&r("File not found: "+e),null==n&&(r("File not found: "+e),n=""),ts.createSourceFile(e,n,t,!0)},fileExists:function(e){return e=normalizePath(e),a.hasOwnProperty(e)},getCanonicalFileName:function(e){return e},getDefaultLibFileName:function(){return"no-default-lib.d.ts"},writeFile:function(e,t,r,n){i.outfiles[e]=t},getCurrentDirectory:function(){return"."},useCaseSensitiveFileNames:function(){return!0},getNewLine:function(){return"\n"},readFile:function(e){return e=normalizePath(e),a[e]||""},directoryExists:function(e){return!0},getDirectories:function(){return[]}},s=e.sourceFiles.filter(function(e){return pxtc.U.endsWith(e,".ts")});return ts.createProgram(s,r,n)}function isPxtModulesFilename(e){return pxtc.U.startsWith(e,"pxt_modules/")}function compile(opts,service){pxtc.compilerHooks||(pxtc.compilerHooks={},opts.target.compilerExtension&&eval(opts.target.compilerExtension)),pxtc.compilerHooks.init&&pxtc.compilerHooks.init(opts,service);var startTime=pxtc.U.cpuUs(),res=mkCompileResult(),program;if(service)storeGeneratedFiles(opts,res),program=service.getProgram();else{if(runConversionsAndStoreResults(opts,res),0<res.diagnostics.length)return res;program=buildProgram(opts,res)}var entryPoint=opts.sourceFiles.filter(function(e){return pxtc.U.endsWith(e,".ts")}).pop().replace(/.*\//,"");if(res.diagnostics=patchUpDiagnostics(program.getSyntacticDiagnostics(),opts.ignoreFileResolutionErrors),0<res.diagnostics.length)return opts.forceEmit&&(pxt.debug("syntactic errors, forcing emit"),pxtc.compileBinary(program,opts,res,entryPoint)),res;res.diagnostics=patchUpDiagnostics(program.getOptionsDiagnostics().concat(pxtc.Util.toArray(program.getGlobalDiagnostics())),opts.ignoreFileResolutionErrors);var semStart=pxtc.U.cpuUs();if(0==res.diagnostics.length)if(opts.skipPxtModulesTSC){var allDiag=program.getSourceFiles().map(function(e){return isPxtModulesFilename(e.fileName)?[]:program.getSemanticDiagnostics(e)});res.diagnostics=patchUpDiagnostics(pxtc.U.concatArrayLike(allDiag),opts.ignoreFileResolutionErrors)}else res.diagnostics=patchUpDiagnostics(program.getSemanticDiagnostics(),opts.ignoreFileResolutionErrors);var emitStart=pxtc.U.cpuUs();if(res.times["typescript-syn"]=semStart-startTime,res.times["typescript-sem"]=emitStart-semStart,res.times.typescript=emitStart-startTime,opts.ast&&(res.ast=program),opts.ast||opts.forceEmit||0==res.diagnostics.length){var binOutput=pxtc.compileBinary(program,opts,res,entryPoint);res.times.compilebinary=pxtc.U.cpuUs()-emitStart,res.diagnostics=res.diagnostics.concat(patchUpDiagnostics(binOutput.diagnostics))}0==res.diagnostics.length&&(res.success=!0);for(var _i=0,_a=opts.sourceFiles;_i<_a.length;_i++){var f=_a[_i];pxtc.Util.startsWith(f,"built/")&&(res.outfiles[f.slice(6)]=opts.fileSystem[f])}return res.times.all=pxtc.U.cpuUs()-startTime,pxt.tickEvent("compile",res.times),res}function decompile(e,t,r,n,i){void 0===n&&(n=!1);var a=e.getSourceFile(r);pxtc.annotate(e,r,pxtc.target||pxt.appTarget&&pxt.appTarget.compile);var s=pxtc.getApiInfo(e,t.jres),o=pxtc.getBlocksInfo(s,t.bannedCategories),l={snippetMode:!1,alwaysEmitOnStart:t.alwaysDecompileOnStart,includeGreyBlockMessages:n,allowedArgumentTypes:t.allowedArgumentTypes||["number","boolean","string"],generatedVarDeclarations:i},c=pxtc.decompiler.buildRenameMap(e,a),u=c[0];c[1];return pxtc.decompiler.decompileToBlocks(o,a,l,u)}function getTSProgram(e,t){var i={},a={};for(var r in e.fileSystem)a[normalizePath(r)]=e.fileSystem[r];var n=getTsCompilerOptions(e),s={getSourceFile:function(e,t,r){e=normalizePath(e);var n="";return a.hasOwnProperty(e)?n=a[e]:r&&r("File not found: "+e),null==n&&(r("File not found: "+e),n=""),ts.createSourceFile(e,n,t,!0)},fileExists:function(e){return e=normalizePath(e),a.hasOwnProperty(e)},getCanonicalFileName:function(e){return e},getDefaultLibFileName:function(){return"no-default-lib.d.ts"},writeFile:function(e,t,r,n){i[e]=t},getCurrentDirectory:function(){return"."},useCaseSensitiveFileNames:function(){return!0},getNewLine:function(){return"\n"},readFile:function(e){return e=normalizePath(e),a[e]||""},directoryExists:function(e){return!0},getDirectories:function(){return[]}};e.sourceFiles||(e.sourceFiles=Object.keys(e.fileSystem));var o=e.sourceFiles.filter(function(e){return pxtc.U.endsWith(e,".ts")}),l=o.filter(function(e){return"main.ts"!=e});o.length>l.length&&(o=l).push("main.ts");var c=o.indexOf("_onCodeStop.ts");0<=c&&(o.splice(c,1),o.push("_onCodeStop.ts"));var u=ts.createProgram(o,n,s,t);return pxtc.annotate(u,"main.ts",pxtc.target||pxt.appTarget&&pxt.appTarget.compile),u}function normalizePath(e){e=e.replace(/\\/g,"/");var t=[];return e.split("/").forEach(function(e){".."===e&&t.length?t.pop():"."!==e&&t.push(e)}),t.join("/")}pxtc.getTsCompilerOptions=getTsCompilerOptions,pxtc.nodeLocationInfo=nodeLocationInfo,pxtc.patchUpDiagnostics=patchUpDiagnostics,pxtc.py2tsIfNecessary=py2tsIfNecessary,pxtc.storeGeneratedFiles=storeGeneratedFiles,pxtc.runConversionsAndStoreResults=runConversionsAndStoreResults,pxtc.timesToMs=timesToMs,pxtc.isPxtModulesFilename=isPxtModulesFilename,pxtc.compile=compile,pxtc.decompile=decompile,pxtc.getTSProgram=getTSProgram}(pxtc=ts.pxtc||(ts.pxtc={}))}(ts||(ts={})),function(m){var e,h,g,v,b;e=m.elf||(m.elf={}),h=["type","offset","vaddr","paddr","filesz","memsz","flags","align"],g=m.HF2.read32,v=m.HF2.read16,b=4096,e.parse=function(o){1179403647!=g(o,0)&&m.U.userError("no magic"),1!=o[4]&&m.U.userError("not 32 bit"),1!=o[5]&&m.U.userError("not little endian"),1!=o[6]&&m.U.userError("bad version"),2!=v(o,16)&&m.U.userError("wrong object type"),40!=v(o,18)&&m.U.userError("not ARM");var t=g(o,28);g(o,32),0==t&&m.U.userError("expecting program headers");for(var r=v(o,42),e=v(o,44),n=m.U.range(e).map(function(e){return function(e){for(var t={},r=e,n=0,i=h;n<i.length;n++){var a=i[n];t[a]=g(o,e),e+=4}var s=t;return s._filepos=r,s}(t+e*r)}),i=o.length+1;15&i;)i++;for(var a=0,s=0,l=n;s<l.length;s++)1==(d=l[s]).type&&(a=Math.max(a,d.vaddr+d.memsz));for(var c=(a+b-1&~(b-1))+(i&b-1),u=-1,p=0,f=n;p<f.length;p++){var d;4==(d=f[p]).type&&(u=d._filepos)}return{imageMemStart:c,imageFileStart:i,phOffset:u,template:o}},e.patch=function(e,t){var r=new Uint8Array(e.imageFileStart+t.length);return r.fill(0),m.U.memcpy(r,0,e.template),m.U.memcpy(r,e.imageFileStart,t),function(e,t){for(var r=t._filepos,n=0,i=h;n<i.length;n++){var a=i[n];m.HF2.write32(e,r,t[a]||0),r+=4}}(r,{_filepos:e.phOffset,type:1,offset:e.imageFileStart,vaddr:e.imageMemStart,paddr:e.imageMemStart,filesz:t.length,memsz:t.length,flags:5,align:b}),r}}(pxt||(pxt={})),function(g){!function(v){var b,e;(e=b||(b={}))[e.None=0]="None",e[e.Whitespace=1]="Whitespace",e[e.Identifier=2]="Identifier",e[e.Keyword=3]="Keyword",e[e.Operator=4]="Operator",e[e.CommentLine=5]="CommentLine",e[e.CommentBlock=6]="CommentBlock",e[e.NewLine=7]="NewLine",e[e.Literal=8]="Literal",e[e.Tree=9]="Tree",e[e.Block=10]="Block",e[e.EOF=11]="EOF";var y=g.SyntaxKind;function x(e){switch(e){case y.CommaToken:return 2;case y.EqualsToken:case y.PlusEqualsToken:case y.MinusEqualsToken:case y.AsteriskEqualsToken:case y.AsteriskAsteriskEqualsToken:case y.SlashEqualsToken:case y.PercentEqualsToken:case y.LessThanLessThanEqualsToken:case y.GreaterThanGreaterThanEqualsToken:case y.GreaterThanGreaterThanGreaterThanEqualsToken:case y.AmpersandEqualsToken:case y.BarEqualsToken:case y.CaretEqualsToken:return 5;case y.QuestionToken:case y.ColonToken:return 7;case y.BarBarToken:return 10;case y.AmpersandAmpersandToken:return 20;case y.BarToken:return 30;case y.CaretToken:return 40;case y.AmpersandToken:return 50;case y.EqualsEqualsToken:case y.ExclamationEqualsToken:case y.EqualsEqualsEqualsToken:case y.ExclamationEqualsEqualsToken:return 60;case y.LessThanToken:case y.GreaterThanToken:case y.LessThanEqualsToken:case y.GreaterThanEqualsToken:case y.InstanceOfKeyword:case y.InKeyword:case y.AsKeyword:return 70;case y.LessThanLessThanToken:case y.GreaterThanGreaterThanToken:case y.GreaterThanGreaterThanGreaterThanToken:return 80;case y.PlusToken:case y.MinusToken:return 90;case y.AsteriskToken:case y.SlashToken:case y.PercentToken:return 100;case y.AsteriskAsteriskToken:return 101;case y.DotToken:return 120;default:return 0}}function f(e){switch(e){case y.EndOfFileToken:return b.EOF;case y.SingleLineCommentTrivia:return b.CommentLine;case y.MultiLineCommentTrivia:return b.CommentBlock;case y.NewLineTrivia:return b.NewLine;case y.WhitespaceTrivia:return b.Whitespace;case y.ShebangTrivia:case y.ConflictMarkerTrivia:return b.CommentBlock;case y.NumericLiteral:case y.StringLiteral:case y.RegularExpressionLiteral:case y.NoSubstitutionTemplateLiteral:case y.TemplateHead:case y.TemplateMiddle:case y.TemplateTail:return b.Literal;case y.Identifier:return b.Identifier;default:return e<y.Identifier?b.Operator:b.Keyword}}var d=!1;function m(e,t){for(;e[t]&&e[t].kind==b.Whitespace;)t++;return t}function k(){return{kind:b.EOF,synKind:y.EndOfFileToken,pos:0,lineNo:0,text:""}}function S(e,t){return{kind:b.Whitespace,synKind:y.WhitespaceTrivia,pos:e.pos-t.length,lineNo:e.lineNo,text:t}}function T(e){if(!e)return!1;switch(e.synKind){case y.IfKeyword:case y.ElseKeyword:case y.LetKeyword:case y.ConstKeyword:case y.VarKeyword:case y.DoKeyword:case y.WhileKeyword:case y.SwitchKeyword:case y.CaseKeyword:case y.DefaultKeyword:case y.ForKeyword:case y.ReturnKeyword:case y.BreakKeyword:case y.ContinueKeyword:case y.TryKeyword:case y.CatchKeyword:case y.FinallyKeyword:case y.DeleteKeyword:case y.FunctionKeyword:case y.ClassKeyword:case y.YieldKeyword:case y.DebuggerKeyword:return!0;default:return!1}}function w(a,s,o){void 0===o&&(o=null);var l,n=[],c=0,u=!1;for(a=a.concat([k()]);a[c].kind!=b.EOF;){var e=c;g(),v.Util.assert(e<c,"Error at "+a[c].text),t(a.slice(e,c))}return n;function t(e){if(s&&(e=E(e)),0!=e.length){e.forEach(i),e=function e(t){var r=[];var n=0;for(;n<t.length;)if(t[n].blockSpanLength){var i=t.slice(n,n+t[n].blockSpanLength),a=!!i[0].blockSpanIsVirtual;delete i[0].blockSpanLength,delete i[0].blockSpanIsVirtual,n+=i.length,i=e(i),a?r.push((o=i,{kind:b.Tree,synKind:y.WhitespaceTrivia,pos:o[0].pos,lineNo:o[0].lineNo,children:o,endToken:null,text:""})):(r.push(S(i[0]," ")),r.push((s=E(i),{kind:b.Block,synKind:y.OpenBraceToken,pos:s[0].pos,lineNo:s[0].lineNo,stmts:[{tokens:s}],text:"{",endToken:null})))}else r.push(t[n++]);var s;var o;return r}(e);if(s&&0<n.length){var t=n[n.length-1].tokens[0].synKind,r=e[0].synKind;if(t==y.IfKeyword&&r==y.ElseKeyword||t==y.TryKeyword&&r==y.CatchKeyword||t==y.TryKeyword&&r==y.FinallyKeyword||t==y.CatchKeyword&&r==y.FinallyKeyword)return e.unshift(S(e[0]," ")),void v.Util.pushRange(n[n.length-1].tokens,e)}n.push({tokens:e})}}function i(e){if(e.kind==b.Tree){var t=e;t.children=v.Util.concat(w(t.children,!1,t).map(function(e){return e.tokens}))}}function p(e){for(void 0===e&&(e=!1);;)switch(a[++c].kind){case b.Whitespace:case b.CommentBlock:case b.CommentLine:break;case b.NewLine:if(e)break;break;default:return}}function f(){for(;a[c].kind==b.Whitespace;)c++;a[c].kind==b.NewLine&&c++}function d(){for(;;)switch(a[++c].kind){case b.EOF:return;case b.Tree:if(a[c].synKind==y.OpenBraceToken)return c--,void h()}}function m(){v.Util.assert(a[c].synKind==y.OpenBraceToken);var e=a[c];v.Util.assert(e.kind==b.Tree);var t=a[c];t.stmts=w(e.children,!0,l),delete e.children,t.kind=b.Block,c++,u=!0}function h(){var e=c+1;p(),a[c].synKind==y.OpenBraceToken?(m(),f()):(g(),a[e].blockSpanLength=c-e)}function g(){for(;;){var e=a[c],t=c;if(u=!1,(l=e).kind==b.EOF)return;if(s&&e.synKind==y.SemicolonToken)return c++,void f();if(e.synKind==y.EqualsGreaterThanToken){if(p(),a[c].synKind==y.OpenBraceToken){m();continue}var r=c;g();for(var n=c;a[n].kind==b.NewLine;)n--;return a[r].blockSpanLength=n-r,void(a[r].blockSpanIsVirtual=!0)}if(s&&x(e.synKind)){r=c;if(p(),!T(a[c]))continue;c=r}if(s&&e.kind==b.NewLine){if(p(),x((e=a[c]).synKind)&&e.synKind!=y.PlusToken&&e.synKind!=y.MinusToken)continue;return void(c=t+1)}if(e.synKind==y.OpenBraceToken&&o&&o.synKind==y.ClassKeyword){for(var i=c-1;0<=i&&a[i].kind==b.Whitespace;)i--;if(i<0||a[i].synKind!=y.EqualsToken)return c--,void h()}switch(v.Util.assert(t==c),e.synKind){case y.ForKeyword:case y.WhileKeyword:case y.IfKeyword:case y.CatchKeyword:if(p(),a[c].synKind!=y.OpenParenToken)continue;return void h();case y.DoKeyword:if(h(),c--,p(),a[c].synKind==y.WhileKeyword){c++;continue}return;case y.ElseKeyword:if(p(),a[c].synKind==y.IfKeyword)continue;return c=t,void h();case y.TryKeyword:case y.FinallyKeyword:return void h();case y.ClassKeyword:case y.NamespaceKeyword:case y.ModuleKeyword:case y.InterfaceKeyword:case y.FunctionKeyword:return void d()}v.Util.assert(!u,"forgot continue/return after expectBlock"),c++}}}function t(e){return e&&(e.kind==b.Whitespace||e.kind==b.NewLine)}function h(e){for(var t=[],r=!1,n=0;n<e.length;++n)r&&(n=m(e,n)),e[n]&&(t.push(e[n]),r=e[n].kind==b.NewLine);return t}function E(e){for(e=e.slice(0);t(e[0]);)e.shift();for(;t(e[e.length-1]);)e.pop();return e}v.toStr=function e(t){return Array.isArray(t)?"[[ "+t.map(e).join("  ")+" ]]":"string"==typeof t.text?JSON.stringify(t.text):t+""},v.format=function(e,t){var r=function(e){e;for(var r=g.createScanner(g.ScriptTarget.Latest,!1,g.LanguageVariant.Standard,e,function(e){var t=r.getTextPos();console.log("scanner error",t,e.message)}),t=[],n=0,i=-1;;){var a=r.scan();if(a==y.CloseBraceToken&&n==i&&(i=-1,a=r.reScanTemplateToken()),d&&a==y.SlashToken||a==y.SlashEqualsToken){var s=r.reScanSlashToken();s==y.RegularExpressionLiteral&&(a=s)}a==y.GreaterThanToken&&(a=r.reScanGreaterToken());var o={kind:f(a),synKind:a,lineNo:0,pos:r.getTokenPos(),text:r.getTokenText()};if(a==y.OpenBraceToken&&n++,a==y.CloseBraceToken&&--n<0&&(n=-1e7),t.push(o),a!=y.TemplateHead&&a!=y.TemplateMiddle||(i=n),o.kind==b.EOF)break}return{tokens:t,braceBalance:n}}(e).tokens,n=w(r=function(e){var t=[];t.push({synKind:y.EndOfFileToken,token:{children:[]}});for(var r,n,i,a=0;a<e.length;++a){var s=e[a],o=t[t.length-1];switch(o.token.children.push(s),s.kind){case b.Operator:switch(s.synKind){case y.OpenBraceToken:case y.OpenParenToken:case y.OpenBracketToken:n=(r=s).synKind+1,i=void 0,(i=r).children=[],i.kind=b.Tree,t.push({synKind:n,token:i});break;case y.CloseBraceToken:case y.CloseParenToken:case y.CloseBracketToken:for(o.token.children.pop();;){if((o=t.pop()).synKind==s.synKind){o.token.endToken=s;break}if(0==t.length||o.synKind==y.CloseBraceToken){t.push(o);break}}}}}return t[0].token.children}(r=function(e,t){for(var r=[],n=!0,i=1,a=0;a<e.length;++a){if(n){var s=a;if(e[a=m(e,a)].kind==b.NewLine){var o=!1;0<=t&&e[a].pos>=t&&(t=-1,o=!0),r.push({text:"",kind:b.CommentLine,pos:e[a].pos,lineNo:i,synKind:y.SingleLineCommentTrivia,isCursor:o})}else a=s}r.push(e[a]),e[a].lineNo=i,e[a].kind==b.NewLine?(n=!0,i++):n=!1,0<=t&&e[a].pos>=t&&(t=-1)}return r}(r,t)),!0),s="",o="",i=-1,a=0;return n.forEach(u),n.forEach(function(e){return e.tokens.forEach(l)}),-1==i&&(i=o.length),{formatted:o,pos:i};function l(e){if(e.kind==b.Tree){var t=e;e.synKind,y.OpenBraceToken,t.children.forEach(l)}else e.kind==b.Block&&e.stmts.forEach(function(e){return e.tokens.forEach(l)})}function c(e,t){if(a==e.lineNo)t();else{a=e.lineNo;var r=s;s+="    ",t(),s=r}}function u(e){var t=h(e.tokens);1!=t.length||t[0].isCursor||""!=t[0].text?(o+=s,c(t[0],function(){!function i(a){a=function(e){var t,r=[],n=0,i=k();for(e=e.concat([k()]);n<e.length;){var a=e[n=m(e,n)];if(a.kind==b.EOF)break;var s=m(e,n+1);if(a.kind!=b.NewLine||e[s].synKind!=y.OpenBraceToken){var o=!0,l=0==r.length?(t=a,{kind:b.NewLine,synKind:y.NewLineTrivia,pos:t.pos,lineNo:t.lineNo,text:"\n"}):r[r.length-1];switch(l.synKind){case y.ExclamationToken:case y.TildeToken:case y.DotToken:o=!1;break;case y.PlusToken:case y.MinusToken:case y.PlusPlusToken:case y.MinusMinusToken:l.isPrefix&&(o=!1)}switch(a.synKind){case y.DotToken:case y.CommaToken:case y.NewLineTrivia:case y.ColonToken:case y.SemicolonToken:case y.OpenBracketToken:o=!1;break;case y.PlusPlusToken:case y.MinusMinusToken:l.kind!=b.Tree&&l.kind!=b.Identifier&&l.kind!=b.Keyword||(o=!1);case y.PlusToken:case y.MinusToken:(i.kind==b.EOF||x(i.synKind)||i.synKind==y.SemicolonToken)&&(a.isPrefix=!0);break;case y.OpenParenToken:if(l.kind==b.Identifier&&(o=!1),l.kind==b.Keyword)switch(l.synKind){case y.IfKeyword:case y.ForKeyword:case y.WhileKeyword:case y.SwitchKeyword:case y.ReturnKeyword:case y.ThrowKeyword:case y.CatchKeyword:break;default:o=!1}}l.kind==b.NewLine&&(o=!1),o&&r.push(S(a," ")),r.push(a),a.kind!=b.NewLine&&(i=a),n++}else n=s}return r}(a);for(var e=function(e){var t=a[e];switch(function(e,t){if(t.synKind==y.NoSubstitutionTemplateLiteral&&/^`[\s\.#01]*`$/.test(t.text)){var r=t.text.slice(1,t.text.length-1).split("\n").map(function(e){return e.replace(/\s/g,"")}).filter(function(e){return!!e});if(r.length<4||5<r.length)return;var n=Math.floor((Math.max.apply(Math,r.map(function(e){return e.length}))+2)/5);n<=0&&(n=1);for(var i="`\n",a=0;a<5;++a){for(var s=r[a]||"";s.length<5*n;)s+=".";i+=e+(s=(s=(s=s.replace(/0/g,".")).replace(/1/g,"#")).replace(/...../g,function(e){return"/"+e})).replace(/./g,function(e){return" "+e}).replace(/\//g," ").slice(3)+"\n"}i+=e+"`",t.text=i}}(s,t),p(t),t.kind){case b.Tree:var r=t;c(t,function(){i(h(r.children))}),r.endToken&&p(r.endToken);break;case b.Block:var n=t;0==n.stmts.length?o+=" ":(o+="\n",n.stmts.forEach(u),o+=s.slice(4)),n.endToken?p(n.endToken):o+="}";break;case b.NewLine:if(a[e+1]&&a[e+1].kind==b.CommentLine&&""==a[e+1].text&&!a[e+1].isCursor)break;e==a.length-1?o+=s.slice(4):o+=s;break;case b.Whitespace:}},t=0;t<a.length;++t)e(t)}(t)}),"\n"!=o[o.length-1]&&(o+="\n")):o+="\n"}function p(e){-1==i&&e.pos+e.text.length>=t&&(i=o.length+(t-e.pos)),o+=e.text}}}(g.pxtc||(g.pxtc={}))}(ts||(ts={})),function(D){!function($){var P;!function(I){var _,K,N,C,U,A,P,b={},l={};function L(e){for(var t="",r=0;r<e.length;r+=2)t=e[r]+e[r+1]+t;return $.assert(r==e.length),t}function y(e){if(!(e=e.replace(/^[\s:]/,"")))return[];var t=[];if(e.replace(/([a-f0-9][a-f0-9])/gi,function(e){return t.push(parseInt(e,16)),""}))throw $.oops("bad bytes "+e);return t}function x(e){return e.flashCodeAlign||I.defaultPageSize}function c(e){return b[e]}function a(e){if("_pxt_comm_base"==e)return I.commBase;var t=c(e);return t?t.value:null}function F(){for(var e=I.currentSetup?I.currentSetup.slice(0,16):"";e.length<16;)e+="0";return e.toUpperCase()}function D(e){var t=0,r=":";return e.forEach(function(e){return t+=e}),e.push(255&-t),e.forEach(function(e){return r+=("0"+e.toString(16)).slice(-2)}),r.toUpperCase()}function O(e){if($.assert(4==[254,255,1,0].length),64==e[0]&&80==e[1]&&88==e[2]&&84==e[3]||$.oops(),58==e[5]){var t=!1;if(64==e[4])t=!0;else{if(35!=e[4])return null;!0}var r=a(t?"pxt::string_inline_ascii_vt":"pxt::buffer_vt"),n=new Uint8Array(6);r||$.oops("missing vt: "+t),3&(r^=1)&&$.oops("Unaligned vt: "+r),pxt.HF2.write32(n,0,r);var i=0;if(t)for(;6+i<e.length&&0!=e[6+i];)i++;return 6+i>=e.length&&$.U.oops("constant string too long!"),pxt.HF2.write16(n,4,i),n}return null}function M(n,r){void 0===r&&(r=null);var i=function(e,t,r){return 64==e[t]&&80==e[t+1]&&88==e[t+2]&&84==e[t+3]?O(r()):null};if(r)for(var e=function(e){var t=i(r,e,function(){return r.slice(e,e+200)});t&&$.U.memcpy(r,e,t)},t=0;t<r.length-8;t+=4)e(t);else for(var a=0;a<n.blocks.length;++a){var s=n.blocks[a],o=n.ptrs[a]<<8,l=function(e){var t=o+e-32,r=i(s,e,function(){return $.UF2.readBytesFromFile(n,t,200)});r&&$.UF2.writeBytes(n,t,r)};for(t=32;t<288;t+=4)l(t)}}function B(e,t,r,n){for(var i=0;i<n.length;){var a=y(e[t]);if(a.pop(),0==a[3]){for(var s=4+r,o=a.length-s,l=0;l<o;++l)i<n.length&&(a[s++]=n[i++]);e[t]=D(a)}t++,r=0}}function R(e,t,r,n){for(var i=[];i.length<n;){var a=y(e[t]);if(a.pop(),0==a[3]){var s=a.slice(4+r);$.U.pushRange(i,s)}t++,r=0}return i}I.asmTotalSource="",I.defaultPageSize=1024,I.commBase=0,I.hexDump=function(e,t){function r(e,t){void 0===t&&(t=8);for(var r=e.toString(16);r.length<t;)r="0"+r;return r}void 0===t&&(t=0);for(var n="",i=0;i<e.length;i+=16){n+=r(t+i)+": ";for(var a="",s=0;s<16;s++){0==(3&s)&&(n+=" ");var o=e[i+s];null!=o?(n+=r(o,2)+" ",a+=32<=o&&o<127?String.fromCharCode(o):"."):n+="   "}n+=" "+a+"\n"}return n},I.setupInlineAssembly=function(e){l={};var t=e.sourceFiles.filter(function(e){return $.U.endsWith(e,".asm")});I.asmTotalSource="";for(var r=0,n=0,i=t;n<i.length;n++){var a=i[n],s=e.fileSystem[a];s.replace(/^\s*(\w+):/gm,function(e,t){return l[t]=!0,""});var o=".section code\n@stackmark func\n@scope user"+r+++"\n"+s+"\n@stackempty func\n@scope\n";I.asmTotalSource+=o}},I.flashCodeAlign=x,I.encodeVTPtr=function(e,t){var r=e>>t.target.vtableShift;return $.assert(r<65535),$.assert(r<<t.target.vtableShift==e),r},I.setupFor=function(o,e,t){if(!I.isSetupFor(e)){var a=e.functions;if(I.commBase=e.commBase||0,I.currentSetup=e.sha,I.currentHexInfo=t,_=t.hex,$.target.nativeType!=$.NATIVE_TYPE_VM){if(function(e){for(var t=0;t<e.length;++t)if("2"==e[t][8]){var r=/^:02....02(....)..$/.exec(e[t]);$.U.assert(!!r);var n=16*parseInt(r[1],16);$.U.assert(0==(65535&n)),e[t]=D([2,0,0,4,0,n>>16])}}(_),_.length<=2){A=pxt.elf.parse($.U.fromHex(_[0])),P=-1,U=A.imageMemStart,I.bytecodeStartAddrPadded=A.imageMemStart;var r=_[C=0].indexOf("0108010842424242010801083ed8e98d");return r<0&&$.oops("no jmp table in elf"),K=r/2,N=-1,g(_[0].slice(r+32,r+32+8*a.length+16)),void v()}var n=0,i="0000",l=0,c=0;U=0;for(var s=function(){if(!U){var e=y(_[c]),t=16-(l+e[0]&15)&15;if(t)if(15&e[2]){for(var r=l+e[0],n=[t,r>>8,255&r,0],i=0;i<t;++i)n.push(0);c++,_.splice(c,0,D(n)),U=r+t}else{if(16!=e[0]){for(e.pop(),e[0]=16;e.length<20;)e.push(0);_[c]=D(e)}U=l+16}else U=l+e[0];P=c+1;var a=x(o);I.bytecodeStartAddrPadded=(U&~(a-1))+a;var s=I.bytecodeStartAddrPadded-U;$.assert(0==(15&s)),C=s}};n<_.length;++n){if((f=/:02000004(....)/.exec(_[n]))&&(i=f[1]),f=/^:..(....)00/.exec(_[n])){var u=parseInt(i+f[1],16);o.flashUsableEnd&&u>=o.flashUsableEnd&&s(),c=n,l=u}/^:00000001/.test(_[n])&&s(),(f=/^:10....000108010842424242010801083ED8E98D/.exec(_[n]))&&(K=l,N=n)}K||$.oops("No hex start"),U||$.oops("No hex end"),b={};for(var p=N+1;p<_.length;++p){var f;if((f=/^:..(....)00(.{4,})/.exec(_[p]))&&(g(f[2]),0==a.length))break}return void v()}P=-1,U=0,I.bytecodeStartAddrPadded=0,N=K=-1;for(var d=C=0,m=a;d<m.length;d++){var h=m[d];(b[h.name]=h).value=16777215}}function g(e){for(var t=o.shortPointers?4:8;e.length>=t;){var r=e.slice(0,t),n=parseInt(L(r),16);e=e.slice(t);var i=a.shift();if(!i)break;b[i.name]=i,n||$.U.oops("No value for "+i.name+" / "+r),0==i.argsFmt.length?n^=1:o.runtimeIsARM||o.nativeType!=$.NATIVE_TYPE_THUMB||1&n||$.U.oops("Non-thumb addr for "+i.name+" / "+r),i.value=n}}function v(){a.length&&$.oops("premature EOF in hex file; missing: "+a.map(function(e){return e.name}).join(", "))}},I.validateShim=function(e,t,r,n,i){if("TD_ID"!=t&&"TD_NOOP"!=t&&"ENUM_GET"!=t&&!$.U.lookup(l,t)){var a=e+"(...) (shim="+t+")",s=c(t);if(s){n?"V"==s.argsFmt[0]&&$.U.userError("expecting function for "+a):"V"!=s.argsFmt[0]&&$.U.userError("expecting procedure for "+a);for(var o=0;o<i.length;++o)s.argsFmt[o+1]||$.U.userError("excessive parameters passed to "+a);i.length!=s.argsFmt.length-1&&$.U.userError("not enough arguments for "+a+" (got "+i.length+"; fmt="+s.argsFmt.join(",")+")")}else $.U.userError("function not found: "+a)}},I.lookupFunc=c,I.lookupFunctionAddr=a,I.hexTemplateHash=F,I.hexPrelude=function(){return"    .startaddr 0x"+I.bytecodeStartAddrPadded.toString(16)+"\n"},I.patchHex=function(e,t,r,n){var i=_.slice(0,P),a=2*t.length+7>>3;$.assert(a<64e3,"program too large, bytes: "+2*t.length),t[17]=a,t[20]=e.commSize;for(var s=[],o=0;o<C>>1;++o)s.push(0);t=s.concat(t);var l=0;function c(e,t){for(var r=[16,t>>8&255,255&t,0],n=0;n<8;++n)r.push(255&(e[l]||0)),r.push((e[l]||0)>>>8),l++;return r}var u=[16912,0,65535&I.bytecodeStartAddrPadded,I.bytecodeStartAddrPadded>>>16],p=F();for(o=0;o<4;++o)u.push(parseInt(L(p.slice(4*o,4*o+4)),16));var f=n?$.UF2.newBlockFile($.target.uf2Family):null;if(A){var d=new Uint8Array(2*t.length);for(o=0;o<t.length;++o)pxt.HF2.write16(d,2*o,t[o]);var m=pxt.elf.patch(A,d);for(o=0;o<u.length;++o)pxt.HF2.write16(m,2*o+K,u[o]);if(M(null,m),f){var h=e.options.name||"pxt";return h=h.replace(/[^a-zA-Z0-9\-\.]+/g,"_"),f.filename="Projects/"+h+".elf",$.UF2.writeBytes(f,0,m),[$.UF2.serializeFile(f)]}return[$.U.uint8ArrayToString(m)]}if(f){if($.UF2.writeHex(f,i),M(f),$.UF2.writeBytes(f,K,c(u,N).slice(4)),e.checksumBlock){for(var g=[],v=0,b=e.checksumBlock;v<b.length;v++){var y=b[v];g.push(255&y,y>>8)}$.UF2.writeBytes(f,e.target.flashChecksumAddr,g)}}else!function(e){for(var t=0;t<e.length;++t){var r=e[t].indexOf("40505854");if(0<r){var n=r-9>>1,i=O(R(e,t,n,200));i&&B(e,t,n,i)}}}(i),i[N]=D(c(u,K)),e.checksumBlock&&$.U.oops("checksum block in HEX not implemented yet");l=0,r&&(i=[]);for(var x=U,k=x-16>>16;l<t.length;)f?$.UF2.writeBytes(f,x,c(t,x).slice(4)):(x>>16!=k&&(k=x>>16,i.push(D([2,0,0,4,k>>8,255&k]))),i.push(D(c(t,x)))),x+=16;if(!r){var S=_.slice(P);f?$.UF2.writeHex(f,S):$.Util.pushRange(i,S)}if(e.packedSource)if(f){x=f.currPtr+4096&-256;for(var T=new Uint8Array(256),w=0;w<e.packedSource.length;w+=256){for(o=0;o<256;++o)T[o]=e.packedSource.charCodeAt(w+o);$.UF2.writeBytes(f,x,T,$.UF2.UF2_FLAG_NOFLASH),x+=256}}else for(k=8192,x=0,i.push(D([2,0,0,4,k>>8,255&k])),o=0;o<e.packedSource.length;o+=16){g=[16,x>>8&255,255&x,0];for(var E=0;E<16;++E)g.push(255&(e.packedSource.charCodeAt(o+E)||0));i.push(D(g)),x+=16}return f?[$.UF2.serializeFile(f)]:i}}(P=$.hex||($.hex={})),$.asmline=function(e){return 0<=e.indexOf("\n")?(e=e.replace(/^\s*/gm,"").replace(/^(.*)$/gm,function(e,t){return";"==t[0]&&" "==t[1]||/:\*$/.test(t)?t:"    "+t}))+"\n":(/(^[\s;])|(:$)/.test(e)||(e="    "+e),e+"\n")},$.firstMethodOffset=function(){return 9};var b=[21078089,22513679,15655169,18636881,19658081,21486649,21919277,20041213,20548751,16180187,18361627,19338023,19772677,16506547,23530697,22998697,21225203,19815283,23679599,19822889,21136133,19540043,21837031,18095489,23924267,23434627,22582379,21584111,22615171,23403001,19640683,19998031,18460439,20105387,17595791,16482043,23199959,18881641,21578371,22765747,20170273,16547639,16434589,21435019,20226751,19506731,21454393,23224541,23431973,23745511];function x(e){var t=32;$.U.assert($.U.unique(e,function(e){return""+e}).length==e.length,"non unique");for(var r=2;;r<<=1)if(t--,!(r<e.length)){for(var n=-1,i=-1,a=void 0,s=0,o=b;s<o.length;s++){var l=o[s]<<8|t,c=new Uint16Array(r+$.vtLookups+1);$.U.assert(0==(1&c.length));for(var u=0,p=[],f=0,d=e;f<d.length;f++){var m=d[f];$.U.assert(0<m);var h=Math.imul(m,l)>>>t;p.push(h);for(var g=!1,v=0;v<$.vtLookups;v++){if(!c[h+v]){g=!0,c[h+v]=m;break}u++}if(!g){u=-1;break}}(-1==n||u<n)&&(n=u,i=l,a=c)}if(0<=n)return{mult:i,mapping:a,size:r}}}function h(e,t,r){var n=x(e.itable.map(function(e){return e.idx})),i=$.target.shortPointers?".short":".word",a="\n        .balign "+(1<<t.target.vtableShift)+"\n"+e.id+"_VT:\n        .short "+(4*e.allfields.length+4)+"  ; size in bytes\n        .byte "+pxt.ValTypeObject+", "+pxt.VTABLE_MAGIC+" ; magic\n        "+i+" "+e.id+"_IfaceVT\n        .short "+e.classNo+" ; class-id\n        .short 0 ; reserved\n        .word "+n.mult+" ; hash-mult\n",s=function(e){"0"!=e&&(e+="@fn"),a+="        "+i+" "+e+"\n"};s("pxt::RefRecord_destroy"),s("pxt::RefRecord_print"),s("pxt::RefRecord_scan"),s("pxt::RefRecord_gcsize");var o=e.toStringMethod;s(o?o.vtLabel():"0");for(var l=0,c=e.vtable;l<c.length;l++){s(c[l].label()+"_nochk")}a+="\n        .balign "+($.target.shortPointers?2:4)+"\n"+e.id+"_IfaceVT:\n";for(var u=2*n.mapping.length,p="",f=u,d={},m=0,h=e.itable;m<h.length;m++){var g=h[m];d[g.idx+""]=f;var v=g.proc?g.proc.isGetter()?1:2:0;p+="  .short "+g.idx+", "+v+" ; "+g.name+"\n",p+="  .word "+(g.proc?g.proc.vtLabel()+"@fn":g.info)+"\n",f+=8,g.setProc&&(p+="  .short "+g.idx+", 0 ; set "+g.name+"\n",p+="  .word "+g.setProc.vtLabel()+"@fn\n",f+=8)}p+="  .word 0, 0 ; the end\n",f+=8;for(var b=n.mapping,y=0;y<b.length;++y)r.itEntries++,b[y]&&r.itFullEntries++;return a+="  .short "+$.U.toArray(b).map(function(e,t){return(d[e+""]||u)-2*t}).join(", ")+"\n",a+=p,a+="\n"}$.vtLookups=3,$.computeHashMultiplier=x,$.vtableToAsm=h;var g=["GC"];function L(r,t){var n="; start\n"+P.hexPrelude()+"\n    .hex 708E3B92C615A841C49866C975EE5197 ; magic number\n    .hex "+P.hexTemplateHash()+" ; hex template hash\n    .hex 0000000000000000 ; @SRCHASH@\n    .short "+r.globalsWords+"   ; num. globals\n    .short 0 ; patched with number of 64 bit words resulting from assembly\n    .word _pxt_config_data\n    .short 0 ; patched with comm section size\n    .short "+r.nonPtrGlobals+" ; number of globals that are not pointers (they come first)\n    .word _pxt_iface_member_names\n    .word _pxt_lambda_trampoline@fn\n    .word _pxt_perf_counters\n    .word _pxt_restore_exception_state@fn\n    .word "+r.emitString(r.getTitle())+" ; name\n",i=null;i=new $.ThumbSnippets;var e=r.setPerfCounters(g);r.procs.forEach(function(e){var t=new $.ProctoAssembler(i,r,e);n+="\n"+t.getAssembly()+"\n"});var a=new $.ProctoAssembler(i,r,null);a.emitHelpers(),n+="\n"+a.getAssembly()+"\n",n+=P.asmTotalSource,n+="_code_end:\n\n",$.U.iterMap(r.codeHelpers,function(e,t){n+="    .section code\n"+t+":\n"+e+"\n"}),n+=i.arithmetic(),n+="_helpers_end:\n\n",r.usedClassInfos.forEach(function(e){n+=h(e,t,r)}),n+="\n.balign 4\n_pxt_iface_member_names:\n",n+="    .word "+r.ifaceMembers.length+"\n";for(var s=0,o=0,l=r.ifaceMembers;o<l.length;o++){var c=l[o],u=r.emitString(c);n+="    .word "+u+"  ; "+s+++" ."+c+"\n"}n+="    .word 0\n",n+="_vtables_end:\n\n",n+="\n.balign 4\n_pxt_config_data:\n";for(var p=0,f=r.res.configData||[];p<f.length;p++){c=f[p];n+="    .word "+c.key+", "+c.value+"  ; "+c.name+"="+c.value+"\n"}n+="    .word 0\n\n",function(e,t){for(var r=0,n=$.U.unique(t.ifaceMembers.concat(Object.keys(t.strings)),function(e){return e});r<n.length;r++){var i=n[r];t.otherLiterals.push(e.string_literal(t.strings[i],i))}for(var a=0,s=Object.keys(t.doubles);a<s.length;a++){var o=s[a],l=t.doubles[o];t.otherLiterals.push("\n.balign 4\n"+l+": "+e.obj_header("pxt::number_vt")+"\n        .hex "+o+"\n")}for(var c=0,u=Object.keys(t.hexlits);c<u.length;c++)o=u[c],t.otherLiterals.push(e.hex_literal(t.hexlits[o],o)),t.otherLiterals.push()}(i,r),n+=r.otherLiterals.join(""),n+="\n.balign 4\n.section code\n_pxt_perf_counters:\n",n+="    .word "+e.length+"\n";for(var d="",m=0;m<e.length;++m){n+="    .word "+(u=".perf"+m)+"\n",d+=u+": .string "+JSON.stringify(e[m])+"\n"}return n+=d,n+="_literals_end:\n"}function a(e){var t;return(t=e.nativeType==$.NATIVE_TYPE_VM?new $.assembler.VMFile(new $.vm.VmProcessor(e)):new $.assembler.File(new $.thumb.ThumbProcessor)).ei.testAssembler(),e.switches.noPeepHole&&(t.disablePeepHole=!0),t.lookupExternalLabel=P.lookupFunctionAddr,t.normalizeExternalLabel=function(e){var t=P.lookupFunc(e);return t?t.name:e},t}function s(e){if(0<e.errors.length){var r="";throw e.errors.forEach(function(e){var t=/^user(\d+)/.exec(e.scope);if(t){parseInt(t[1]);r+=$.U.lf("At inline assembly:\n"),r+=e.message}}),r&&(console.log($.U.lf("errors in inline assembly")),console.log(r)),new Error(e.errors[0].message)}}var i=!($.processorInlineAssemble=function(e,t){var r=a(e);r.disablePeepHole=!0,r.emit(t),s(r);for(var n=[],i=0;i<r.buf.length;i+=2)n.push(((r.buf[i+1]||0)<<16|r.buf[i])>>>0);return n});function F(e,t,r){var n=a(e);return n.emit(r),r="; Interface tables: "+t.itFullEntries+"/"+t.itEntries+" ("+Math.round(100*t.itFullEntries/t.itEntries)+"%)\n; Virtual methods: "+t.numVirtMethods+" / "+t.numMethods+"\n"+n.getSource(!i,t.numStmts,e.flashEnd),s(n),{src:r,buf:n.buf,thumbFile:n}}$.assemble=F,$.processorEmit=function(e,t,r){var n,i,a,s,o,l,c,u=L(e,t);n=e,i=u,a=$.U.sha256(i),n.sourceHash=a,u=i.replace(/\n.*@SRCHASH@\n/,"\n    .hex "+a.slice(0,16).toUpperCase()+" ; program hash\n"),t.embedBlob&&(e.packedSource=(s=t.embedMeta,o=D.pxtc.decodeBase64(t.embedBlob),(l=$.Util.toUTF8(s)).length,o.length,c="A/¸/¢»",c+=$.U.uint8ArrayToString([255&l.length,l.length>>8,255&o.length,o.length>>8,0,0,0,0]),c+=l,(c+=o).length%2&&(c+="\0"),c),!e.target.noSourceInFlash&&e.packedSource.length<4e4&&(u+=function(e){for(var t="",r=0;r<e.length;++r){var n=255&e.charCodeAt(r);t+=n<=15?"0"+n.toString(16):n.toString(16)}return"\n    .balign 16\n_stored_program: .hex "+t+"\n"}(e.packedSource),e.packedSource=null));var p=P.flashCodeAlign(t.target);if(t.target.flashChecksumAddr){for(var f=0;1<<f<p;)f++;var d=parseInt(e.sourceHash.slice(0,8),16),m=P.bytecodeStartAddrPadded/p;d=4294967040&d|f;var h=0,g=m;t.target.flashChecksumAddr<P.bytecodeStartAddrPadded&&(g-=h=Math.ceil((t.target.flashChecksumAddr+32)/p)),u+="\n    .balign 4\n__end_marker:\n    .word "+d+"\n\n; ------- this will get removed from the final binary ------\n__flash_checksums:\n    .word 0x87eeb07c ; magic\n    .word __end_marker ; end marker position\n    .word "+d+" ; end marker\n    ; template region\n    .short "+h+", "+g+"\n    .word 0x"+P.hexTemplateHash().slice(0,8)+"\n    ; user region\n    .short "+m+", 0xffff\n    .word 0x"+e.sourceHash.slice(0,8)+"\n    .word 0x0 ; terminator\n"}e.writeFile($.BINARY_ASM,u);var v=F(t.target,e,u);v.thumbFile.commPtr&&(e.commSize=v.thumbFile.commPtr-P.commBase),v.src&&e.writeFile($.BINARY_ASM,v.src);var b=r.configData||[];if(b.some(function(e){return"BOOTLOADER_BOARD_ID"==e.name})){var y="const uint32_t configData[] = {\n";y+="    0x1e9e10f1, 0x20227a79, // magic\n",y+="    "+b.length+", 0, // num. entries; reserved\n";for(var x=0,k=b;x<k.length;x++){var S=k[x];y+="    "+S.key+", 0x"+S.value.toString(16)+", // "+S.name+"\n"}y+="    0, 0\n};\n",e.writeFile("config.c",y)}if(v.buf){if(t.target.flashChecksumAddr){var T=v.thumbFile.lookupLabel("__flash_checksums")/2;$.U.assert(T==v.buf.length-16);var w=v.buf.slice(v.buf.length-16);v.buf.splice(v.buf.length-16,16);var E=Math.ceil(2*v.buf.length/p);w[w.length-5]=E,e.checksumBlock=w}if(pxt.isOutputText($.target))I=P.patchHex(e,v.buf,!1,!1).join("\r\n")+"\r\n",e.writeFile(pxt.outputName($.target),I);else{var I=D.pxtc.encodeBase64(P.patchHex(e,v.buf,!1,!!$.target.useUF2)[0]);e.writeFile(pxt.outputName($.target),I)}}for(var _=0,K=r.breakpoints;_<K.length;_++){var N=K[_],C=$.U.lookup(v.thumbFile.getLabels(),"__brkp_"+N.id);null!=C&&(N.binAddr=C)}for(var U=0,A=e.procs;U<A.length;U++)A[U].fillDebugInfo(v.thumbFile);r.procDebugInfo=e.procs.map(function(e){return e.debugInfo})},$.validateShim=P.validateShim,$.f4EncodeImg=function(e,t,r,n){for(var i=[135,r,255&e,e>>8,255&t,t>>8,0,0].map(p).join(""),a=4,s=0,o=0,l=function(e){s|=e<<o,o==8-r?(i+=p(s),a++,o=s=0):o+=r},c=0;c<e;++c){for(var u=0;u<t;++u)l(n(c,u));for(;0!=o;)l(0);if(1<r)for(;3&a;)l(0)}return i;function p(e){return("0"+e.toString(16)).slice(-2)}}}(D.pxtc||(D.pxtc={}))}(ts||(ts={})),function(e){var t,r;t=e.pxtc||(e.pxtc={}),r=function(){function e(e){this.p=e}return e.prototype.getCompilationSettings=function(){var e=this.p.getCompilerOptions();return e.noLib=!0,e},e.prototype.getNewLine=function(){return"\n"},e.prototype.getScriptFileNames=function(){return this.p.getSourceFiles().map(function(e){return e.fileName})},e.prototype.getScriptVersion=function(e){return"0"},e.prototype.getScriptSnapshot=function(e){var t=this.p.getSourceFile(e);return{getLength:function(){return t.getFullText().length},getText:function(){return t.getFullText()},getChangeRange:function(){}}},e.prototype.getCurrentDirectory=function(){return"."},e.prototype.getDefaultLibFileName=function(e){return""},e.prototype.useCaseSensitiveFileNames=function(){return!0},e}(),t.LSHost=r}(ts||(ts={})),function(p){!function(o){var l=function(e){var t=r(e);p.sys.write(t)};function c(e){for(var t=0,r=e;t<r.length;t++){var n=r[t];l(n)}}function r(e){var t;if(null!=o.DiagnosticCategory.file){var r=e,n=p.getLineAndCharacterOfPosition(r.file,r.start),i=n.line,a=n.character,s=r.file.fileName;t=Object.assign({fileName:s,line:i,column:a},r)}else t=Object.assign({fileName:void 0,line:void 0,column:void 0},e);return function(e){var t="";e.fileName&&(t+=e.fileName+"("+(e.line+1)+","+(e.column+1)+"): ");var r=p.sys?p.sys.newLine:"\n",n=o.DiagnosticCategory[e.category].toLowerCase();return t+=n+" TS"+e.code+": "+o.flattenDiagnosticMessageText(e.messageText,r)+r}(t)}function n(e,t){var r=p.createCompilerHost(t);return r.getDefaultLibFileName=function(){return"node_modules/typescript/lib/lib.d.ts"},p.createProgram(e,t,r)}function u(e){var t=e.getSyntacticDiagnostics();return 0===t.length&&0===(t=e.getOptionsDiagnostics().concat(o.Util.toArray(e.getGlobalDiagnostics()))).length&&(t=e.getSemanticDiagnostics()),t}o.getDiagnosticString=r,o.plainTscCompileDir=function(i){var a=p.parseCommandLine([]),s=p.findConfigFile(i,p.sys.fileExists),e=function(){var e=p.sys.readFile(s),t=p.parseConfigFileTextToJson(s,e),r=t.config;if(!r)return c([t.error]),void p.sys.exit(p.ExitStatus.DiagnosticsPresent_OutputsSkipped);var n=p.parseJsonConfigFileContent(r,p.sys,i,a.options,s);return 0<n.errors.length?(c(n.errors),void p.sys.exit(p.ExitStatus.DiagnosticsPresent_OutputsSkipped)):n}(),t=n(e.fileNames,e.options);return u(t).forEach(l),t},o.plainTscCompileFiles=n,o.getProgramDiagnostics=u}(p.pxtc||(p.pxtc={}))}(ts||(ts={})),function(I){!function(S){function r(t,e,r){if(void 0===r&&(r=""),e.parameters){var n=!!e.attributes.imageLiteral;return"("+e.parameters.filter(function(e){return!e.initializer}).map(function(e){return function(e,t,r,n){if(t.initializer)return t.initializer;if(t.default)return t.default;if("number"==t.type)return"0";if("boolean"==t.type)return"false";if("string"==t.type)return r?(r=!1,"`"+S.defaultImgLit+n+"`"):'"'+n+'"';var i=e?S.Util.lookup(e.byQName,t.type):void 0;if(i&&6==i.kind){var a=S.Util.values(e.byQName).filter(function(e){return e.namespace==t.type})[0];if(a)return a.namespace+"."+a.name}var s=/^\((.*)\) => (.*)$/.exec(t.type);return s?"("+s[1]+") => {\n    "+n+"\n}":S.placeholderChar}(t,e,n,r)}).join(", ")+")"}return""}function T(t){var e=t.toUpperCase(),r=t.toLowerCase();if(t==e||t==r)return t;if(0<t.lastIndexOf("_"))return t;for(var n,i=function(e){return t[e]!=r[e]},a="",s=0;s<t.length;){for(var o=i(s),l=s;l<t.length;){if(o&&t[n=l]!=e[n]){if(2<l-s){l--;break}o=!1}if(!o&&i(l))break;l++}a&&(a+="_"),a+=t.slice(s,l),s=l}return a}function w(e){if(!e||!e.kind)return null;switch(e.kind){case I.SyntaxKind.StringKeyword:return"str";case I.SyntaxKind.NumberKeyword:return"number";case I.SyntaxKind.BooleanKeyword:return"bool";case I.SyntaxKind.VoidKeyword:return"None";case I.SyntaxKind.FunctionType:return n=w((r=e).type),"("+r.parameters.map(function(e){return e.type}).map(w).join(", ")+") -> "+n;case I.SyntaxKind.ArrayType:return"List["+w((t=e).elementType)+"]";case I.SyntaxKind.TypeReference:var t;return""+((t=e).typeName&&t.typeName.getText?t.typeName.getText():t.typeName);default:return pxt.tickEvent("depython.todo",{kind:e.kind}),"(TODO: Unknown TypeNode kind: "+e.kind+")"}var r,n}function b(d,e,t){function m(e,t,r){void 0===r&&(r=!1);var n=d.getTypeAtLocation(t);if(!n)return"None";r&&(n=n.getCallSignatures()[0].getReturnType());var i=d.typeToString(n,void 0,I.TypeFormatFlags.UseFullyQualifiedType);return/^\d/.test(i)?"number":"this"==i?E(d,n.symbol):i}var r,n=function(e){switch(e.kind){case S.SK.MethodDeclaration:case S.SK.MethodSignature:return 1;case S.SK.PropertyDeclaration:case S.SK.PropertySignature:case S.SK.GetAccessor:case S.SK.SetAccessor:return 2;case S.SK.Constructor:case S.SK.FunctionDeclaration:return 3;case S.SK.VariableDeclaration:return 4;case S.SK.ModuleDeclaration:return 5;case S.SK.EnumDeclaration:return 6;case S.SK.EnumMember:return 7;case S.SK.ClassDeclaration:return 8;case S.SK.InterfaceDeclaration:return 9;default:return 0}}(t);if(0!=n){var i=t,h=S.parseComments(i);if(h.weight<0)return null;var a=/^(.*)\.(.*)/.exec(e),s=3==n||1==n,o=null,l=I.getSourceFileOfNode(t);if(l){var c=/^pxt_modules\/([^\/]+)/.exec(l.fileName);c&&(o=c[1])}var u=void 0;if(8==n||9==n){var p=t;if(u=[],p.heritageClauses)for(var f=0,g=p.heritageClauses;f<g.length;f++){var v=g[f];if(v.types)for(var b=0,y=v.types;b<y.length;b++){var x=y[b];u.push(m(0,x))}}}6!=n&&7!==n||(u||(u=[])).push("Number");var k={kind:n,qName:e,namespace:a?a[1]:"",name:a?a[2]:e,fileName:t.getSourceFile().fileName,attributes:h,pkg:o,extendsTypes:u,retType:t.kind==I.SyntaxKind.Constructor?"void":5==n?"":m(i.type,i,s),parameters:s?S.Util.toArray(i.parameters).map(function(r,e){var t,n,i=S.getName(r),a=h.paramHelp[i]||"",s=h.paramMin&&h.paramMin[i],o=h.paramMax&&h.paramMax[i];/\beg\.?:\s*(.+)/.exec(a);if(r.type&&r.type.kind===S.SK.FunctionType){var l=d.getSignatureFromDeclaration(r.type).getParameters();"objectdestructuring"===h.mutate?(S.assert(0<l.length),t=d.getTypeAtLocation(l[0].valueDeclaration).getProperties().map(function(e){return{name:e.getName(),type:d.typeToString(d.getTypeOfSymbolAtLocation(e,l[0].valueDeclaration))}})):n=l.map(function(e,t){return{name:e.getName(),type:d.typeToString(d.getTypeOfSymbolAtLocation(e,r))}})}var c={},u=d.getTypeAtLocation(r),p=u&&!!(u.flags&(I.TypeFlags.Enum|I.TypeFlags.EnumLiteral));if(h.block&&h.paramShadowOptions){var f=[];h.block.replace(/%(\w+)/g,function(e,t){return f.push(t),""}),h.paramShadowOptions[f[e]]&&(c.fieldEditorOptions={value:h.paramShadowOptions[f[e]]})}return s&&(c.min={value:s}),o&&(c.max={value:o}),{name:i,description:a,type:m(r.type,r),pyTypeString:w(r.type),initializer:r.initializer?r.initializer.getText():S.getExplicitDefault(h,i)||(r.questionToken?"undefined":void 0),default:h.paramDefl[i],properties:t,handlerParameters:n,options:c,isEnum:p}}):null,snippet:I.isFunctionLike(t)?null:void 0};switch(k.kind){case 7:k.pyName=T(k.name).toUpperCase();break;case 4:case 1:case 2:case 3:k.pyName=T(k.name).toLowerCase();break;case 6:case 8:case 9:case 5:default:k.pyName=k.name}return(t.kind===S.SK.GetAccessor||(t.kind===S.SK.PropertyDeclaration||t.kind===S.SK.PropertySignature)&&((r=t).modifiers&&r.modifiers.some(function(e){return e.kind==S.SK.ReadonlyKeyword})))&&(k.isReadOnly=!0),k}return null}function n(e){return!!e.attributes.block&&!!e.attributes.blockId}var i;function d(e,t){var r=-(n(e)?1:-1)+(n(t)?1:-1);return r||(i||(i={4:100,5:101,3:99,2:98,1:97,8:89,6:81,7:80}),(r=-(i[e.kind]||0)+(i[t.kind]||0))?r:(r=-(e.attributes.weight||50)+(t.attributes.weight||50))||S.U.strcmp(e.name,t.name))}function a(e,t,r){void 0===r&&(r=!1);for(var l={byQName:{},jres:t},a={},s=e.getTypeChecker(),o=function(e){if(e.kind!=S.SK.VariableStatement){if(function(e){if(e.modifiers&&e.modifiers.some(function(e){return e.kind==S.SK.PrivateKeyword||e.kind==S.SK.ProtectedKeyword}))return!1;var t=e.symbol;if(!t)return!1;for(;;){var r=t.parent;if(!r)break;t=r}var n=t.valueDeclaration||t.declarations[0];return n.kind==S.SK.VariableDeclaration&&(n=n.parent.parent),!(!n.parent||n.parent.kind!=S.SK.SourceFile)}(e)){if(!e.symbol)return void console.warn("no symbol",e);var t=E(s,e.symbol);e.kind==S.SK.SetAccessor&&(t+="@set"),a[t]=e;var r=b(s,t,e);if(r){var n=S.U.lookup(l.byQName,t);n&&(9==n.kind&&9!=r.kind?l.byQName[t+"@type"]=n:9!=n.kind&&9==r.kind?(l.byQName[t+"@type"]=r,r=n):(r.attributes=S.parseCommentString(n.attributes._source+"\n"+r.attributes._source),n.extendsTypes&&(r.extendsTypes=r.extendsTypes||[],n.extendsTypes.forEach(function(e){-1===r.extendsTypes.indexOf(e)&&r.extendsTypes.push(e)})))),!e.parent||e.parent.kind!=S.SK.ClassDeclaration&&e.parent.kind!=S.SK.InterfaceDeclaration||S.isStatic(e)||(r.isInstance=!0),l.byQName[t]=r}}if(e.kind==S.SK.ModuleDeclaration){var i=e;if(i.body.kind==S.SK.ModuleBlock)i.body.statements.forEach(o);else i.body.kind==S.SK.ModuleDeclaration&&o(i.body)}else if(e.kind==S.SK.InterfaceDeclaration){e.members.forEach(o)}else if(e.kind==S.SK.ClassDeclaration){e.members.forEach(o)}else if(e.kind==S.SK.EnumDeclaration){e.members.forEach(o)}}else{e.declarationList.declarations.forEach(o)}},n=0,i=e.getSourceFiles();n<i.length;n++){i[n].statements.forEach(o)}var c=[];for(var u in l.byQName){var p=l.byQName[u];p.qName=u,p.attributes._source=null,p.extendsTypes&&p.extendsTypes.length&&c.push(p);var f=p.attributes.jres;if(f){"true"==f&&(f=u);var d=S.U.lookup(t||{},f);d&&d.icon&&!p.attributes.iconURL&&(p.attributes.iconURL=d.icon),d&&d.data&&!p.attributes.jresURL&&(p.attributes.jresURL="data:"+d.mimeType+";base64,"+d.data)}if(p.pyName){var m=S.U.lookup(S.ts2PyFunNameMap,p.qName);if(m&&m.n)p.pyQName=m.n;else if(p.namespace){var h=l.byQName[p.namespace];h?p.pyQName=h.pyQName+"."+p.pyName:(pxt.log("namespace missing: "+p.namespace),p.pyQName=p.namespace+"."+p.pyName)}else p.pyQName=p.pyName}}var g={},v=function(e){if(!S.U.lookup(g,e.qName)){g[e.qName]=!0;var t={};t[e.qName]=!0;for(var r=0,n=e.extendsTypes||[];r<n.length;r++){var i=n[r];t[i]=!0;var a=l.byQName[i];if(a){v(a);for(var s=0,o=a.extendsTypes;s<o.length;s++){t[o[s]]=!0}}}e.extendsTypes=Object.keys(t)}};return c.forEach(v),r&&delete l.byQName["Array.map"],{apis:l,decls:a}}function E(e,t){return t.isBogusSymbol?t.name:e.getFullyQualifiedName(t)}S.placeholderChar="◊",S.defaultImgLit="\n. . . . .\n. . . . .\n. . # . .\n. . . . .\n. . . . .\n",S.ts2PyFunNameMap={"Math.trunc":{n:"int",t:I.SyntaxKind.NumberKeyword},"Math.min":{n:"min",t:I.SyntaxKind.NumberKeyword},"Math.max":{n:"max",t:I.SyntaxKind.NumberKeyword},"Math.abs":{n:"abs",t:I.SyntaxKind.NumberKeyword},"Math.randomRange":{n:"randint",t:I.SyntaxKind.NumberKeyword},"console.log":{n:"print",t:I.SyntaxKind.VoidKeyword},".length":{n:"len",t:I.SyntaxKind.NumberKeyword},".toLowerCase()":{n:"string.lower",t:I.SyntaxKind.StringKeyword},".toUpperCase()":{n:"string.upper",t:I.SyntaxKind.StringKeyword},".charCodeAt(0)":{n:"ord",t:I.SyntaxKind.NumberKeyword},"pins.createBuffer":{n:"bytearray",t:I.SyntaxKind.Unknown},"pins.createBufferFromArray":{n:"bytes",t:I.SyntaxKind.Unknown},"control.createBuffer":{n:"bytearray",t:I.SyntaxKind.Unknown},"control.createBufferFromArray":{n:"bytes",t:I.SyntaxKind.Unknown},"!!":{n:"bool",t:I.SyntaxKind.BooleanKeyword},".indexOf":{n:"Array.index",t:I.SyntaxKind.NumberKeyword},parseInt:{n:"int",t:I.SyntaxKind.NumberKeyword}},S.renderCall=function(e,t){return t.namespace+"."+t.name+r(e,t)+";"},S.renderParameters=r,S.snakify=T,S.emitType=w,S.genDocs=function(n,e,i){void 0===i&&(i={}),pxt.debug("generating docs for "+n),pxt.debug(JSON.stringify(Object.keys(e.byQName),null,2));for(var a={},r=S.Util.values(e.byQName),t=r.filter(function(e){return 7==e.kind}).sort(d),s={},o={},l={},c=function(t,e){if(i.locs){var r={};Object.keys(t).sort().forEach(function(e){return r[e]=t[e]}),a[n+e+"-strings.json"]=JSON.stringify(r,null,2)}},u=function(t){if(5==t.kind){if(!r.filter(function(e){return e.namespace==t.name&&!!e.attributes.jsDoc})[0])return"continue";t.attributes.block||(t.attributes.block=t.name)}!function(t){if(i.locs&&t.qName&&!/^__/.test(t.name)){if(pxt.debug("loc: "+t.qName),7!=t.kind){var e=I.pxtc.blocksCategory(t);e&&(o["{id:category}"+e]=e)}t.attributes.jsDoc&&(l[t.qName]=t.attributes.jsDoc),t.attributes.block&&(o[t.qName+"|block"]=t.attributes.block),t.attributes.group&&(o["{id:group}"+t.attributes.group]=t.attributes.group),t.attributes.subcategory&&(o["{id:subcategory}"+t.attributes.subcategory]=t.attributes.subcategory),t.parameters&&t.parameters.filter(function(e){return!!e.description}).forEach(function(e){l[t.qName+"|param|"+e.name]=e.description})}}(t)},p=0,f=r;p<f.length;p++)u(f[p]);return i.locs&&t.forEach(function(e){e.attributes.block&&(o[e.qName+"|block"]=e.attributes.block),e.attributes.jsDoc&&(o[e.qName]=e.attributes.jsDoc)}),c(o,""),c(l,"-jsdoc"),i.pxtsnippet&&(i.pxtsnippet.forEach(function(e){return n=["label","title","hint","errorMessage"],(r=s)[(t=e).label]=t.label,void t.questions.forEach(function(t){n.forEach(function(e){t[e]&&(r[t[e]]=t[e])})});var t,r,n}),c(s,"-snippet")),a},S.hasBlock=n,S.compareSymbols=d,S.getApiInfo=function(e,t,r){return void 0===r&&(r=!1),a(e,t,r).apis},S.internalGetApiInfo=a,S.getFullName=E}(I.pxtc||(I.pxtc={}))}(ts||(ts={})),function(F){var D;(function(e){var A,d,m,r,n,f,i,h,g,v,t={fileSystem:{},sourceFiles:[],target:{isNative:!1,hasHex:!1,switches:{}},hexinfo:null},a=function(){function e(){this.opts=t,this.fileVersions={},this.projectVer=0,this.pxtModulesOK=null}return e.prototype.getProjectVersion=function(){return this.projectVer+""},e.prototype.setFile=function(e,t){this.opts.fileSystem[e]!=t&&(this.fileVersions[e]=(this.fileVersions[e]||0)+1,this.opts.fileSystem[e]=t,this.projectVer++)},e.prototype.reset=function(){this.setOpts(t),this.pxtModulesOK=null},e.prototype.setOpts=function(e){var r=this;D.Util.iterMap(e.fileSystem,function(e,t){r.opts.fileSystem[e]!=t&&(r.fileVersions[e]=(r.fileVersions[e]||0)+1)}),this.opts=e,this.projectVer++},e.prototype.getCompilationSettings=function(){return D.getTsCompilerOptions(this.opts)},e.prototype.getScriptFileNames=function(){return this.opts.sourceFiles.filter(function(e){return D.U.endsWith(e,".ts")})},e.prototype.getScriptVersion=function(e){return(this.fileVersions[e]||0).toString()},e.prototype.getScriptSnapshot=function(e){var t=this.opts.fileSystem[e];return t?F.ScriptSnapshot.fromString(t):null},e.prototype.getNewLine=function(){return"\n"},e.prototype.getCurrentDirectory=function(){return"."},e.prototype.getDefaultLibFileName=function(e){return"no-default-lib.d.ts"},e.prototype.log=function(e){console.log("LOG",e)},e.prototype.trace=function(e){console.log("TRACE",e)},e.prototype.error=function(e){console.error("ERROR",e)},e.prototype.useCaseSensitiveFileNames=function(){return!0},e}(),P=function(e,t){return e?(n||(n=D.getBlocksInfo(e,t)),n):(r||(r=D.getBlocksInfo(m.apis,t)),r)};function b(e){e.apisInfo||e.target.preferredEditor!=pxt.PYTHON_PROJECT_NAME||(m||(m=D.internalGetApiInfo(A.getProgram(),e.jres)),e.apisInfo=D.U.clone(m.apis))}var s={reset:function(){A.cleanupSemanticCache(),m=null,d.reset(),D.transpile.resetCache()},setOptions:function(e){d.setOpts(e.options)},syntaxInfo:function(e){var t=e.fileContent;e.fileContent&&d.setFile(e.fileName,e.fileContent);var r=D.U.flatClone(d.opts);return r.fileSystem[e.fileName]=t,r.syntaxInfo={position:e.position,type:e.infoType},r.target.preferredEditor==pxt.PYTHON_PROJECT_NAME&&(b(r),pxt.py.py2ts(r)),r.syntaxInfo},getCompletions:function(e){var t=e.fileContent;e.fileContent&&d.setFile(e.fileName,e.fileContent);for(var r=/\.py$/.test(e.fileName),n=-1,i=-1,a=e.position-1;0<=a;--a){if("."==t[a]){n=a;break}if(!/\w/.test(t[a]))break;-1==i&&(i=a)}n==e.position-1?t=t.slice(0,e.position)+"_"+t.slice(e.position):-1==i&&(t=t.slice(0,e.position)+"_"+t.slice(e.position),i=e.position),-1!=n&&(i=n);var s={},o={entries:[],isMemberCompletion:-1!=n,isNewIdentifierLocation:!0,isTypeLocation:!1},l=D.U.flatClone(d.opts);l.fileSystem[e.fileName]=t,b(l),l.syntaxInfo={position:i,type:o.isMemberCompletion?"memberCompletion":"identifierCompletion"},pxt.py.py2ts(l);for(var c=0,u=l.syntaxInfo.symbols||[];c<u.length;c++){var p=u[c];if(!(/^__/.test(p.name)||/^__/.test(p.namespace)||p.attributes.hidden||p.attributes.deprecated)){s[p.qName]=p;var f=m.decls[p.qName];F.isFunctionLike(f)&&(r?p.pySnippet=y(m.apis,e.runtime,p,f,r):p.snippet=y(m.apis,e.runtime,p,f,r))}}return o.entries=pxt.Util.values(s),o.entries.sort(D.compareSymbols),o},compile:function(e){d.setOpts(e.options);var t=o();return D.timesToMs(t),t},decompile:function(e){return d.setOpts(e.options),D.decompile(A.getProgram(),e.options,e.fileName,!1,e.generatedVarDeclarations)},pydecompile:function(e){return d.setOpts(e.options),D.transpile.tsToPy(A.getProgram(),e.fileName)},assemble:function(e){return{words:D.processorInlineAssemble(d.opts.target,e.fileContent)}},py2ts:function(e){return b(e.options),D.transpile.pyToTs(e.options)},fileDiags:function(e){return D.patchUpDiagnostics(function(e){if(!/\.ts$/.test(e))return[];var t=A.getSyntacticDiagnostics(e);return t&&t.length||(t=A.getSemanticDiagnostics(e)),t||(t=[]),t}(e.fileName))},allDiags:function(){var e=o();return D.timesToMs(e),d.opts.target.switches.time&&console.log("DIAG-TIME",e.times),e.diagnostics},format:function(e){var t=e.format;return D.format(t.input,t.pos)},apiInfo:function(){if(f=r=void 0,d.opts!==t)return(m=D.internalGetApiInfo(A.getProgram(),d.opts.jres)).apis},snippet:function(e){var t=e.snippet;if(m){var r=m.apis.byQName[t.qName],n=m.decls[t.qName];if(r&&n&&F.isFunctionLike(n))return F.pxtc.service.getSnippet(m.apis,e.runtime,r,n,!!t.python)}},blocksInfo:function(e){return P(e,e.blocks&&e.blocks.bannedCategories)},apiSearch:function(e){var t=e.search,a=P(t.localizedApis,e.blocks&&e.blocks.bannedCategories);t.localizedStrings&&pxt.Util.setLocalizedStrings(t.localizedStrings);var r,i=function(t,e,r){if(t)return"string"==typeof t?t:e?t[e]:Object.keys(t).map(function(e){return t[e]}).join(" ")};if(!h){h=[],g=pxt.blocks.blockDefinitions();var n=function(r){var n=g[r];if(n.operators){var e=function(t){n.operators[t].forEach(function(e){return h.push({id:r,name:n.name,jsdoc:"string"==typeof n.tooltip?n.tooltip:n.tooltip[e],block:e,field:[t,e],builtinBlock:!0})})};for(var t in n.operators)e(t)}else h.push({id:r,name:n.name,jsdoc:i(n.tooltip,n.tooltipSearch),block:i(n.block,n.blockTextSearch),builtinBlock:!0})};for(var s in g)n(s)}if(!f||t.subset){var o={},l=[];t.subset&&(v=t.subset,l=h.filter(function(e){return!!v[e.id]})),v?r=a.blocks.filter(function(e){return!!v[e.attributes.blockId]}):(r=a.blocks,l=h);var c=r.map(function(e){return{id:e.attributes.blockId,qName:e.qName,name:e.name,namespace:e.namespace,block:e.attributes.block,jsdoc:e.attributes.jsDoc,localizedCategory:v&&"string"==typeof v[e.attributes.blockId]?v[e.attributes.blockId]:void 0}}),u={};l.forEach(function(e){return u[e.id]=!0}),c=c.filter(function(e){return!(e.id in u)});var p=0;r.forEach(function(e){var t,r,n,i=o[e.qName]=(r=(t=e).attributes.weight||50,(1e3*((n=a.apis.byQName[t.namespace])&&n.attributes.weight||50)+r)*(n&&n.attributes.advanced||t.attributes.advanced?1:1e6));p=Math.max(p,i)}),c=c.concat(l),f=new Fuse(c,{shouldSort:!0,threshold:.6,location:0,distance:100,maxPatternLength:16,minMatchCharLength:2,findAllMatches:!1,caseSensitive:!1,keys:[{name:"name",weight:.3},{name:"namespace",weight:.1},{name:"localizedCategory",weight:.1},{name:"block",weight:.4375},{name:"jsdoc",weight:.0625}],sortFn:function(e,t){var r=e.qName?1-o[e.item.qName]/p:1,n=t.qName?1-o[t.item.qName]/p:1;return e.score*(1+r/10)-t.score*(1+n/10)}})}return f.search(t.term).slice(0,7)},projectSearch:function(e){var t=e.projectSearch,r=t.headers;return i||(i=new Fuse(r,{shouldSort:!0,threshold:.6,location:0,distance:100,maxPatternLength:16,minMatchCharLength:2,findAllMatches:!1,caseSensitive:!1,keys:[{name:"name",weight:.3}]})),i.search(t.term)},projectSearchClear:function(){i=void 0}};function o(){b(d.opts);var e=D.U.flatClone(d.opts.fileSystem),t=D.runConversionsAndStoreResults(d.opts),r=d.opts.fileSystem;d.opts.fileSystem=e;for(var n=0,i=Object.keys(r);n<i.length;n++){var a=i[n];d.setFile(a,r[a])}if(0==t.diagnostics.length){d.opts.skipPxtModulesEmit=!1,d.opts.skipPxtModulesTSC=!1;var s=d.opts.target.isNative?"native":"js";!d.opts.target.switches.noIncr&&d.pxtModulesOK&&(d.opts.skipPxtModulesTSC=!0,d.opts.noEmit?d.opts.skipPxtModulesEmit=!0:d.opts.target.isNative?d.opts.skipPxtModulesEmit=!1:"js"!=d.pxtModulesOK||d.opts.breakpoints&&!d.opts.justMyCode||(d.opts.skipPxtModulesEmit=!0)),(t=D.compile(d.opts,A)).needsFullRecompile&&(pxt.log("trigering full recompile"),pxt.tickEvent("compile.fullrecompile"),d.opts.skipPxtModulesEmit=!1,t=D.compile(d.opts,A)),t.diagnostics.every(function(e){return!D.isPxtModulesFilename(e.fileName)})&&(d.pxtModulesOK=s)}return t}e.performOperation=function(e,t){A||(d=new a,A=F.createLanguageService(d));var r=null;if(s.hasOwnProperty(e))try{r=s[e](t)||{}}catch(e){r={errorMessage:e.stack}}else r={errorMessage:"No such operation: "+e};return r};var L="`\n. . . . .\n. . . . .\n. . # . .\n. . . . .\n. . . . .\n`";function y(g,e,t,r,v){var o=pxt.py.INDENT,l="",c="";c=r.kind==D.SK.Constructor?K(r.symbol)||r.parent.name.getText():K(r.symbol)||r.name.getText(),v&&(c=D.snakify(c).toLowerCase());var b=t.attributes,n=P(g,e.bannedCategories).blocks,y=pxt.Util.toDictionary(n,function(e){return e.attributes.blockId}),x=A&&A.getProgram().getTypeChecker(),i=r.parameters?r.parameters.filter(function(e){return!e.initializer&&!e.questionToken}).map(function(e){var t=e.type;if(!t)return v?"None":"null";var i=e.name.kind===D.SK.Identifier?e.name.text:void 0;if(b&&b.paramDefl&&b.paramDefl[i]){if(t.kind==D.SK.StringKeyword){var r=b.paramDefl[i];return t.kind==D.SK.StringKeyword&&0!=r.indexOf('"')?'"'+r+'"':r}return b.paramDefl[i]}function n(e){if(e.symbol&&e.symbol.flags&F.SymbolFlags.Enum)return function(e){if(x&&e.symbol&&e.symbol.declarations&&e.symbol.declarations.length)for(var t=0;t<e.symbol.declarations.length;t++){var r=e.symbol.declarations[t];if(r.kind===D.SK.EnumDeclaration)for(var n=r,i=0;i<n.members.length;i++){var a=n.members[t];if(a.name.kind===D.SK.Identifier){var s=x.getFullyQualifiedName(x.getSymbolAtLocation(a.name)),o=g.byQName[s];return o?v?o.pyQName:o.qName:s}}}return"0"}(e);if(D.isObjectType(e)){var t=g.byQName[x.getFullyQualifiedName(e.symbol)],r=t&&t.attributes&&(v?t.attributes.pySnippet:t.attributes.snippet);if(r)return r;if(e.objectFlags&F.ObjectFlags.Anonymous){var n=x.getSignaturesOfType(e,F.SignatureKind.Call);return n&&n.length?C(n[0]):U(i)}}return e.flags&F.TypeFlags.NumberLike?"0":null}var a,s,o,l=function(e){var t=(b._shadowOverrides||{})[e];if(!t)return null;var r=y[t];if(!r)return null;if("TD_ID"===r.attributes.shim&&r.parameters.length){var n=r.parameters[0].type;r=g.byQName[n]||r}return r}(i);if(l){var c=(a=l,s=e,o=x.getSymbolsInScope(s,F.SymbolFlags.Enum),pxt.Util.toDictionary(o,function(e){return e.escapedName.toString()})[a.qName]||null);if(c){var u=x.getTypeOfSymbolAtLocation(c,e);if(u){var p=n(u);if(p)return p}}}switch(t.kind){case D.SK.StringKeyword:return"leds"==i?L:'""';case D.SK.NumberKeyword:return"0";case D.SK.BooleanKeyword:return v?"False":"false";case D.SK.ArrayType:return"[]";case D.SK.TypeReference:break;case D.SK.FunctionType:var f=t,d=x?x.getSignatureFromDeclaration(f):void 0;return d?C(d):U(i)}var m=x&&x.getTypeAtLocation(e);if(m){var h=n(m);if(h)return h}return v?"None":"null"}):[],a=t.attributes.blockNamespace||t.namespace,s=!1,u="",p=0,f=t;if(f.attributes.block)if(f.attributes.defaultInstance)a=f.attributes.defaultInstance,v&&a&&(a=D.snakify(a).toLowerCase());else if(f.namespace){var d=g.byQName[f.namespace];if(d.attributes.fixedInstances){var m=D.Util.values(g.byQName);u=f.attributes.blockNamespace||d.namespace||"";var h=m.filter(function(e){return 4===e.kind&&e.attributes.fixedInstance}),k=h.filter(function(e){return e.retType==d.qName}).sort(function(e,t){return e.name.localeCompare(t.name)});if(k.length)a=""+N(k[0]);else{var S=h.filter(function(e){return-1!==(r=d.qName,m.filter(function(e){return e.extendsTypes}).filter(function(e){return e.extendsTypes.reduce(function(e,t){return e||-1!=t.indexOf(r)},!1)}).reduce(function(e,t){return e.concat(t.extendsTypes)},[])).indexOf(e.retType);var r}).sort(function(e,t){return e.name.localeCompare(t.name)});S.length&&(a=""+N(S[0]))}s=!0}else if(1==f.kind||2==f.kind){var T=pxt.blocks.compileInfo(f);T.thisParameter&&(a=T.thisParameter.defaultValue||T.thisParameter.definitionName,v&&a&&(a=D.snakify(a).toLowerCase()))}else if(8===d.kind)return}var w,E,I=c+"("+i.join(", ")+")",_=a?a+"."+I:I;return _=s?((E=(w=u).indexOf("."))<0?w:w.substring(0,E))+"."+_:_,b&&b.blockSetVariable&&(_=(v?"":"let ")+(v?D.snakify(b.blockSetVariable).toLowerCase():b.blockSetVariable)+" = "+_),l+_;function K(e){if(x){var t=D.getFullName(x,e),r=g.byQName[t];if(r)return N(r)}}function N(e){return v?e.pyName:e.name}function C(t){var e="",r=x.getReturnTypeOfSignature(t);if(r.flags&F.TypeFlags.NumberLike?e="return 0":r.flags&F.TypeFlags.StringLike?e='return ""':r.flags&(F.TypeFlags.Boolean|F.TypeFlags.BooleanLiteral)&&(e=v?"return False":"return false"),v){var n="("+t.parameters.map(function(e){return e.name}).join(", ")+")",i=c||"fn";return 0<p++&&(i+=p),i=D.snakify(i).toLowerCase(),l+="def "+i+n+":\n"+o+(e||"pass")+"\n",i}n="()";var a=F.mapToDisplayParts(function(e){x.getSymbolDisplayBuilder().buildSignatureDisplay(t,e)}),s=F.displayPartsToString(a);return"function "+(n=s.substr(0,s.lastIndexOf(":")))+" {\n    "+e+"\n}"}function U(e){return v?(e&&(e=D.snakify(e).toLowerCase()),l+="def "+e+"():\n"+o+"pass\n",e):"function () {}"}}e.getSnippet=y})((D=F.pxtc||(F.pxtc={})).service||(D.service={}))}(ts||(ts={})),function(e){var i;(function(e){var m=function(e){return"main."+e},h=[],g=10;function v(e){return e=e.replace(/\s/g,"")}function n(e,t,r,n){var i,a,s=function(e,t){for(var r=v(t),n=0,i=h;n<i.length;n++){var a=i[n];if(a.comparable[e]===r)return a}}(e,t);if(s&&s.code[r]){var o=s.code[r];return i=o,(a={})[m(r)]=i,{diagnostics:[],success:!0,outfiles:a}}var l,c,u,p,f,d=n();return d.success&&(o=d.outfiles[m(r)]||"",c=t,u=r,p=o,(f={comparable:{ts:void 0,blocks:void 0,py:void 0},code:{ts:void 0,blocks:void 0,py:void 0}}).code[l=e]=c,f.comparable[l]=v(c),f.code[u]=p,f.comparable[u]=v(p),h.unshift(f),h.length>g&&h.pop()),d}e.resetCache=function(){h=[]},e.pyToTs=function(e,t){void 0===t&&(t=m("py"));var r=e.fileSystem[t];return i.U.assert(null!=r,'Missing file "'+t+'" when converting from py->ts'),n("py",r,"ts",function(){return pxt.py.py2ts(e)})},e.tsToPy=function(e,t){void 0===t&&(t=m("ts"));var r=e.getSourceFile(t);return i.U.assert(null!=r,'Missing file "'+t+'" when converting from ts->py'),n("ts",r.getText(),"py",function(){return pxt.py.decompileToPython(e,t)})}})((i=e.pxtc||(e.pxtc={})).transpile||(i.transpile={}))}(ts||(ts={})),function(e){var m;(function(c){var f=m.assembler.emitErr,d=f("opcode name doesn't match","<name>"),u=function(n){function e(e,t,r){return n.call(this,e,t,r,r,!1)||this}return __extends(e,n),e.prototype.emit=function(e){var t=e.words;if(t[0]!=this.name)return d;for(var r=this.opcode,n=1,i=[],a=null,s=null,o=0;o<this.args.length;++o){var l=this.args[o],c=t[n++];if("$"==l[0]){var u=this.ei.encoders[l],p=null;if(u.isImmediate||u.isLabel){if(!c)return f("expecting number",c);if(c=c.replace(/^#/,""),null==(p=e.bin.parseOneInt(c)))return f("expecting number",c)}else m.oops();if(null==p)return f("didn't understand it",c);if(m.U.assert(0<=p),11111!=p&&"$lbl"==l&&(p-=e.bin.location()+2,p>>=1),i.push(p),null==(p=u.encode(p)))return f("argument out of range or mis-aligned",c);"$i3"==l?p=s|p<<6:"$i5"==l&&(p=s|p<<8),"$i2"==l||"$i4"==l?s=p:"$rt"==l?(11111!=p&&4096<p&&m.U.oops("label: "+c+" v="+p),r=32768|p,"callrt.p"==this.name&&(r|=8192)):e.isLong||p<0||255<p?(e.isLong=!0,"$lbl"==l&&(p-=1),r=p>>9&65535|49152,a=this.opcode+(p<<7)&65535):r=this.opcode+(p<<7)&65535}else if(l!=c)return f("expecting "+l,c)}return t[n]?f("trailing tokens",t[n]):{stack:0,opcode:r,opcode2:a,numArgs:i,labelName:e.bin.normalizeExternalLabel(null)}},e}(m.assembler.Instruction);c.VmInstruction=u,c.withPush={},c.opcodes=["stloc     $i1","ldloc     $i1","stfld     $i4, $i5","ldfld     $i4, $i5","newobj    $i1","ldcap     $i1","stglb     $i1","ldglb     $i1","ldint     $i1","ldintneg  $i1","ldspecial $i1","ldnumber  $i1","ldlit     $i1","checkinst $i1","mapget","mapset","ret       $i2, $i3","popmany   $i1","pushmany  $i1","callind   $i1","callproc  $i1","calliface $i2, $i3","callget   $i1","callset   $i1","jmp       $lbl","jmpnz     $lbl","jmpz      $lbl","try       $lbl","push","pop"];var e=function(l){function e(e){var t=l.call(this)||this;t.addEnc("$i1","#0-8388607",function(e){return t.inrange(8388607,e,e)}),t.addEnc("$i2","#0-31",function(e){return t.inrange(31,e,e)}),t.addEnc("$i3","#0-262143",function(e){return t.inrange(262143,e,e)}),t.addEnc("$i4","#0-255",function(e){return t.inrange(255,e,e)}),t.addEnc("$i5","#0-32767",function(e){return t.inrange(32767,e,e)}),t.addEnc("$lbl","LABEL",function(e){return t.inminmax(-4194304,4194303,e,e)}).isLabel=!0;for(var r=1,n=t.addEnc("$rt","SHIM",function(e){return t.inrange(8388607,e,e)}).isLabel=!0,i=0,a=c.opcodes.concat(["callrt $rt"]);i<a.length;i++){var s=a[i],o=new u(t,s,r);t.instructions[o.name]=[o],(n||"callrt"==o.name)&&(c.withPush[o.name]=!0,o=new u(t,s.replace(/\w+/,function(e){return e+".p"}),64|r),t.instructions[o.name]=[o]),"mapset.p"==o.name&&(n=!1),r++}return t}return __extends(e,l),e.prototype.testAssembler=function(){},e.prototype.postProcessRelAddress=function(e,t){return t},e.prototype.postProcessAbsAddress=function(e,t){return t},e.prototype.getAddressFromLabel=function(e,t,r,n){void 0===n&&(n=!1);var i=e.lookupLabel(r);return null==i?null:t.is32bit?i:i-(e.pc()+2)},e.prototype.toFnPtr=function(e,t){return e},e.prototype.wordSize=function(){return 8},e.prototype.peephole=function(e,t,r){var n=e.getOp(),i="";if(t){var a=n+";"+(i=t.getOp()),s=this.file.peepCounts;s[a]=(s[a]||0)+1}"stloc"==n&&"ldloc"==i&&e.numArgs[0]==t.numArgs[0]?(/LAST/.test(t.text)&&e.update(""),t.update("")):c.withPush[n]&&"push"==i&&(e.update(e.text.replace(/\w+/,function(e){return e+".p"})),t.update(""))},e}(m.assembler.AbstractProcessor);c.VmProcessor=e})((m=e.pxtc||(e.pxtc={})).vm||(m.vm={}))}(ts||(ts={}));